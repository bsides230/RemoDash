<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XTTS v2</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet" />
    <script src="/assets/module_sdk.js"></script>
    <style>
        :root {
            /* Standard Dashboard Variables */
            --bg-core: #050505;
            --bg-panel: #0a0a0a;
            --text-head: #ffffff;
            --text-body: #b0b0b0;
            --text-dim: #666666;
            --brand-color: #10B981;
            --brand-color-dim: rgba(16, 185, 129, 0.1);
            --border-color: #222222;

            --success-color: #2e7d32;
            --warn-color: #f9a825;
            --err-color: #c62828;

            --console-bg: #111;
            --console-text: #0f0;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: var(--bg-core);
            color: var(--text-body);
            margin: 0;
            padding: 20px;
            height: 100vh;
            box-sizing: border-box;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Persistent Header */
        header {
            flex: 0 0 auto;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        h2 {
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-head);
            font-size: 18px;
            font-weight: 500;
        }

        h3, h4 {
            color: var(--text-head);
        }

        .main-player-container {
            background: var(--bg-panel);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid var(--border-color);
        }

        audio {
            width: 100%;
            height: 40px;
            outline: none;
            filter: invert(0.9);
        }

        /* Scrollable Content Area */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
            display: flex;
            flex-direction: column;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; border: 2px solid transparent; background-clip: content-box; }
        ::-webkit-scrollbar-thumb:hover { background-color: var(--brand-color); }


        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
            flex-shrink: 0;
        }
        .tab-btn {
            background: none;
            border: none;
            color: var(--text-dim);
            padding: 8px 16px;
            cursor: pointer;
            font-size: 0.9rem;
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase;
            transition: color 0.2s, border-bottom 0.2s;
            border-bottom: 2px solid transparent;
        }
        .tab-btn:hover {
            color: var(--text-head);
        }
        .tab-btn.active {
            color: var(--brand-color);
            border-bottom: 2px solid var(--brand-color);
            font-weight: bold;
        }
        .tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
            padding-bottom: 20px;
        }
        .tab-content.active {
            display: block;
            animation: fadeIn 0.2s;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-head);
            font-size: 0.9em;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            background-color: var(--bg-panel);
            border: 1px solid var(--border-color);
            color: var(--text-body);
            border-radius: 4px;
            box-sizing: border-box;
            font-family: inherit;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--brand-color);
        }
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        input[type="range"] {
            padding: 0;
        }

        button {
            padding: 10px 20px;
            background-color: var(--brand-color);
            color: #000; /* Often black text on bright brand color looks best, or white if dark brand */
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
            transition: opacity 0.2s;
        }
        button:hover {
            opacity: 0.9;
        }
        button:disabled {
            background-color: var(--border-color);
            color: var(--text-dim);
            cursor: not-allowed;
        }
        button.danger {
            background-color: var(--err-color);
            color: white;
        }
        button.success {
            background-color: var(--success-color);
            color: white;
        }

        /* Lists */
        .list-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            gap: 10px;
        }
        .list-item:last-child {
            border-bottom: none;
        }
        .col-check { width: 30px; }
        .col-grow { flex: 1; }
        .col-date { width: 150px; color: var(--text-dim); font-size: 0.85em; font-family: 'JetBrains Mono'; }
        .col-actions { display: flex; gap: 5px; }

        /* Status Badge */
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: bold;
            text-transform: uppercase;
            font-family: 'JetBrains Mono';
        }
        .status-ok { background-color: var(--brand-color-dim); color: var(--brand-color); border: 1px solid var(--brand-color); }
        .status-warn { background-color: rgba(249, 168, 37, 0.1); color: var(--warn-color); border: 1px solid var(--warn-color); }
        .status-err { background-color: rgba(198, 40, 40, 0.1); color: var(--err-color); border: 1px solid var(--err-color); }

        .hidden { display: none !important; }

        /* Modal */
        .modal-overlay {
            position: fixed; top:0; left:0; right:0; bottom:0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(2px);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000;
        }
        .modal {
            background: var(--bg-core);
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }

        /* Console & Progress */
        .console-container {
            background: #000;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px;
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .console-log {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85em;
            color: var(--console-text);
            height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
            border-top: 1px solid #333;
            padding-top: 5px;
        }
        .progress-row {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .progress-label {
            font-size: 0.85em;
            color: var(--text-dim);
            display: flex;
            justify-content: space-between;
        }
        progress {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            appearance: none;
            background: var(--bg-panel);
        }
        progress::-webkit-progress-bar {
            background-color: var(--bg-panel);
        }
        progress::-webkit-progress-value {
            background-color: var(--brand-color);
        }
        .metrics-row {
            display: flex;
            gap: 15px;
            font-size: 0.85em;
            color: var(--text-dim);
            font-family: 'JetBrains Mono';
        }

        /* Grid for Settings */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .slider-group {
            display: flex;
            flex-direction: column;
        }
        .slider-val {
            float: right;
            font-weight: bold;
            color: var(--brand-color);
            font-family: 'JetBrains Mono';
        }
        small {
            font-size: 0.8em;
            color: var(--text-dim);
            margin-top: 4px;
        }

    </style>
</head>
<body>

    <header>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="display:flex; align-items:center; gap:15px;">
                <h2 style="margin:0;">XTTS v2</h2>
                <div id="headerControls" style="display:flex; gap:5px; align-items:center;">
                    <span id="modelStatus" class="status-badge status-warn">Checking...</span>
                    <button id="headerStartBtn" class="success hidden" style="padding:4px 12px; font-size:0.75em;" onclick="startModel()">Start</button>
                    <button id="headerStopBtn" class="danger hidden" style="padding:4px 12px; font-size:0.75em;" onclick="stopModel()">Stop</button>
                </div>
            </div>
        </div>
        <div class="main-player-container">
             <audio id="mainAudio" controls></audio>
             <div id="nowPlayingText" style="font-size: 0.8em; color: var(--text-dim); margin-top: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Ready to play.</div>
        </div>
    </header>

    <div class="content-area" id="mainContent">
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('generate')">Generate</button>
            <button class="tab-btn" onclick="switchTab('history')">History</button>
            <button class="tab-btn" onclick="switchTab('voices')">Voices</button>
            <button class="tab-btn" onclick="switchTab('settings')">Settings</button>
        </div>

        <!-- GENERATE TAB -->
        <div id="tab-generate" class="tab-content active">
            <div class="form-group">
                <label>Voice Profile</label>
                <select id="voiceSelect">
                    <option value="">Loading voices...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Text to Speak</label>
                <textarea id="TextInput" placeholder="Type something here..." oninput="updateCharCounter()"></textarea>
                <div id="charCounter" style="font-size:0.8em; text-align:right; margin-top:4px; color:var(--text-dim); font-family: 'JetBrains Mono';">
                    0 chars
                </div>
            </div>

            <div class="form-group" style="display:flex; gap:10px; align-items: center;">
                <button id="generateBtn" onclick="generateSpeech()">Generate Audio</button>
                <button id="playBtn" class="success hidden" onclick="playResult()">â–¶ Play</button>
                <button id="resetBtn" class="hidden" style="background:transparent; border:1px solid var(--border-color); color:var(--text-body);" onclick="resetGeneration()">Reset</button>
            </div>

            <div id="progressSection" class="console-container hidden">
                <div class="metrics-row">
                    <span id="metricTime">Time: 0.0s</span>
                    <span id="metricChunk">Chunk: 0/0</span>
                    <span id="metricStatus">Status: Idle</span>
                </div>

                <div class="progress-row">
                    <div class="progress-label"><span>Overall Progress</span><span id="progText">0%</span></div>
                    <progress id="mainProgress" value="0" max="100"></progress>
                </div>

                <div class="console-log" id="consoleLog"></div>
            </div>
        </div>

        <!-- HISTORY TAB -->
        <div id="tab-history" class="tab-content">
            <div style="margin-bottom: 10px; display: flex; justify-content: space-between;">
                <button class="danger" onclick="deleteSelectedHistory()">Delete Selected</button>
                <button style="background:transparent; border:1px solid var(--border-color); color:var(--text-body);" onclick="loadHistory()">Refresh</button>
            </div>
            <div id="historyList"></div>
        </div>

        <!-- VOICES TAB -->
        <div id="tab-voices" class="tab-content">
            <div style="margin-bottom: 10px;">
                <button onclick="showAddVoiceModal()">+ Add New Voice</button>
            </div>
            <div id="voiceList"></div>
        </div>

        <!-- SETTINGS TAB -->
        <div id="tab-settings" class="tab-content">
            <div class="form-group">
                <p id="modelMsg" style="color:var(--text-dim); font-size: 0.9em;"></p>
            </div>

            <div class="form-group">
                <button onclick="checkRequirementsManual()" style="background:transparent; border:1px solid var(--border-color); width:100%;">Scan Requirements</button>
            </div>

            <!-- Download Section (Hidden if loaded) -->
            <div id="downloadSection" class="hidden form-group" style="padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-panel);">
                <h4>Download Model</h4>
                <p style="font-size:0.9em; color:var(--text-dim);">The XTTS v2 model is licensed under the Coqui Public Model License (CPML).</p>
                <div style="margin-bottom: 10px;">
                    <input type="checkbox" id="licenseCheck" style="width:auto;">
                    <label for="licenseCheck" style="display:inline;">I agree to the CPML terms.</label>
                </div>
                <button onclick="downloadModel()">Download Model</button>
            </div>

            <!-- Device -->
            <div class="form-group">
                <h3 style="font-size:1em; text-transform:uppercase; color:var(--text-dim); border-bottom:1px solid var(--border-color); padding-bottom:5px; margin-bottom:15px;">Hardware</h3>
                <label>Processing Device</label>
                <select id="deviceSelect">
                    <option value="cpu">CPU (Safe)</option>
                    <option value="vulkan">Vulkan (Experimental)</option>
                    <option value="cuda">CUDA (NVIDIA GPU)</option>
                </select>
                <div style="font-size:0.8em; color:var(--text-dim); margin-top:5px;">
                    Note: Vulkan requires PyTorch with Vulkan support.
                </div>
            </div>

            <!-- Generation Params -->
            <h3 style="font-size:1em; text-transform:uppercase; color:var(--text-dim); border-bottom:1px solid var(--border-color); padding-bottom:5px; margin-bottom:15px; margin-top:30px;">Generation Parameters</h3>
            <div class="settings-grid">

                <div class="slider-group">
                    <label>Temperature <span id="val_temp" class="slider-val">0.75</span></label>
                    <input type="range" id="inp_temp" min="0.1" max="1.5" step="0.05" value="0.75" oninput="updateVal('temp', this.value)">
                    <small>Creativity vs Stability (Low = Stable)</small>
                </div>

                <div class="slider-group">
                    <label>Speed <span id="val_speed" class="slider-val">1.0</span></label>
                    <input type="range" id="inp_speed" min="0.5" max="2.0" step="0.1" value="1.0" oninput="updateVal('speed', this.value)">
                    <small>Speaking rate</small>
                </div>

                <div class="slider-group">
                    <label>Top P (Nucleus) <span id="val_topp" class="slider-val">0.8</span></label>
                    <input type="range" id="inp_topp" min="0.1" max="1.0" step="0.05" value="0.8" oninput="updateVal('topp', this.value)">
                    <small>Probability mass cutoff</small>
                </div>

                <div class="slider-group">
                    <label>Top K <span id="val_topk" class="slider-val">50</span></label>
                    <input type="number" id="inp_topk" min="1" max="100" value="50">
                    <small>Top token count cutoff</small>
                </div>

                <div class="slider-group">
                    <label>Repetition Penalty <span id="val_rep" class="slider-val">2.0</span></label>
                    <input type="range" id="inp_rep" min="1.0" max="10.0" step="0.1" value="2.0" oninput="updateVal('rep', this.value)">
                    <small>Discourages repeats</small>
                </div>

                <div class="slider-group">
                    <label>Length Penalty <span id="val_len" class="slider-val">1.0</span></label>
                    <input type="range" id="inp_len" min="0.5" max="2.0" step="0.1" value="1.0" oninput="updateVal('len', this.value)">
                    <small>Favors length (>1.0) or brevity (<1.0)</small>
                </div>
            </div>

            <div class="form-group" style="margin-top:20px;">
                <label>Max Characters Per Chunk</label>
                <div style="display:flex; align-items:center; gap:10px;">
                    <input type="number" id="chunkLimitInput" min="50" max="400" value="220" style="width:75px;">
                    <span style="font-size:0.82em; color:var(--text-dim);">
                        XTTS limit â‰ˆ 250. Auto-split ensures safety.
                    </span>
                </div>
            </div>

            <button onclick="saveSettings()" style="margin-top: 10px;">Save Settings</button>
        </div>
    </div>

    <!-- ADD VOICE MODAL -->
    <div id="addVoiceModal" class="modal-overlay hidden">
        <div class="modal">
            <h3>Add New Voice</h3>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="newVoiceName" placeholder="e.g. My Voice">
            </div>
            <div class="form-group">
                <label>Reference Audio (WAV/MP3, ~10s)</label>
                <input type="file" id="newVoiceFile" accept="audio/*">
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button onclick="closeAddVoiceModal()" style="background:transparent; border:1px solid var(--border-color); color:var(--text-body);">Cancel</button>
                <button onclick="addVoice()">Create Voice</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/modules/mod_xtts';
        const mainAudio = document.getElementById('mainAudio');
        const nowPlayingText = document.getElementById('nowPlayingText');

        // --- State ---
        let pollInterval = null;
        let lastLogCount = 0;
        let currentResultPath = null;

        // --- Tabs ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            document.querySelector(`.tab-btn[onclick="switchTab('${tabId}')"]`).classList.add('active');

            if (tabId === 'history') loadHistory();
            if (tabId === 'voices') loadVoices();
            if (tabId === 'settings') checkStatus();
        }

        // --- Init ---
        window.addEventListener('load', async () => {
            checkStatus();
            loadVoices();
            loadSettings();

            // Check Dependencies
            const sdk = new ModuleSDK('mod_xtts');
            const reqs = await sdk.checkRequirements();
            if (reqs && reqs.missing && reqs.missing.length > 0) {
                sdk.showInstallModal(reqs.missing);
            }
        });

        // --- API Helpers ---
        async function api(endpoint, method = 'GET', body = null) {
            const opts = { method };
            if (body) {
                opts.headers = { 'Content-Type': 'application/json' };
                opts.body = JSON.stringify(body);
            }
            const res = await fetch(API_BASE + endpoint, opts);
            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.detail || 'API Error');
            }
            return res.json();
        }

        function updateVal(id, val) {
            document.getElementById('val_' + id).innerText = val;
        }

        // --- Player ---
        function playAudio(url, text) {
            mainAudio.src = url;
            // No autoplay per request
            // mainAudio.play();
            nowPlayingText.innerText = text || 'Ready to play.';
        }

        function playResult() {
            if (currentResultPath) {
                mainAudio.src = currentResultPath;
                mainAudio.play();
            }
        }

        // --- Status & Settings ---
        async function checkStatus() {
            try {
                const status = await api('/status');
                const el = document.getElementById('modelStatus');
                const msg = document.getElementById('modelMsg');
                const dlSec = document.getElementById('downloadSection');

                const startBtn = document.getElementById('headerStartBtn');
                const stopBtn = document.getElementById('headerStopBtn');
                const genBtn = document.getElementById('generateBtn');

                // Defaults
                startBtn.classList.add('hidden');
                stopBtn.classList.add('hidden');

                if (status.loaded) {
                    el.className = 'status-badge status-ok';
                    el.innerText = 'Running';
                    msg.innerText = 'Ready to generate.';
                    dlSec.classList.add('hidden');
                    stopBtn.classList.remove('hidden');
                    genBtn.disabled = false;
                    genBtn.title = "";
                } else if (status.loading) {
                    el.className = 'status-badge status-warn';
                    el.innerText = 'Loading...';
                    msg.innerText = 'Please wait...';
                    dlSec.classList.add('hidden');
                    setTimeout(checkStatus, 2000);
                    genBtn.disabled = true;
                    genBtn.title = "Model is loading";
                } else {
                    // Not loaded
                    el.className = 'status-badge status-err';
                    el.innerText = 'Stopped';
                    genBtn.disabled = true;
                    genBtn.title = "Model not running";

                    if (status.files_exist) {
                        msg.innerText = 'Model files present. Click Start to load.';
                        dlSec.classList.add('hidden');
                        startBtn.classList.remove('hidden');
                    } else {
                        msg.innerText = 'Model files missing. Please download.';
                        dlSec.classList.remove('hidden');
                        // No start button if files missing
                    }
                }
            } catch (e) { console.error(e); }
        }

        async function startModel() {
            try {
                document.getElementById('headerStartBtn').disabled = true;
                const res = await api('/start', 'POST');
                if(res.status === 'started') {
                    checkStatus();
                } else {
                    alert(res.message);
                }
            } catch(e) { alert(e.message); }
            finally { document.getElementById('headerStartBtn').disabled = false; }
        }

        async function stopModel() {
            if(!confirm("Stop XTTS Model? This will free up memory.")) return;
            try {
                await api('/stop', 'POST');
                checkStatus();
            } catch(e) { alert(e.message); }
        }

        async function loadSettings() {
            try {
                const s = await api('/settings');
                document.getElementById('deviceSelect').value = s.device || 'cpu';
                document.getElementById('chunkLimitInput').value = s.max_chunk_chars || 220;
                window._chunkLimit = s.max_chunk_chars || 220;

                // Load Gen Params
                const setVal = (id, key) => {
                    const el = document.getElementById('inp_' + id);
                    if (s[key] !== undefined) el.value = s[key];
                    updateVal(id, el.value);
                };

                setVal('temp', 'temperature');
                setVal('speed', 'speed');
                setVal('topp', 'top_p');
                setVal('topk', 'top_k'); // number input, no val span update needed?
                document.getElementById('val_topk').innerText = document.getElementById('inp_topk').value;
                setVal('rep', 'repetition_penalty');
                setVal('len', 'length_penalty');

                updateCharCounter();
            } catch (e) { console.error(e); }
        }

        async function saveSettings() {
            const dev = document.getElementById('deviceSelect').value;
            const cl = parseInt(document.getElementById('chunkLimitInput').value) || 220;

            const payload = {
                device: dev,
                max_chunk_chars: cl,
                temperature: parseFloat(document.getElementById('inp_temp').value),
                speed: parseFloat(document.getElementById('inp_speed').value),
                top_p: parseFloat(document.getElementById('inp_topp').value),
                top_k: parseInt(document.getElementById('inp_topk').value),
                repetition_penalty: parseFloat(document.getElementById('inp_rep').value),
                length_penalty: parseFloat(document.getElementById('inp_len').value),
            };

            window._chunkLimit = cl;
            try {
                await api('/settings', 'POST', payload);
                alert('Settings saved.');
                updateCharCounter();
            } catch (e) { alert(e.message); }
        }

        function updateCharCounter() {
            const text = document.getElementById('TextInput').value;
            const len = text.length;
            const limit = window._chunkLimit || 220;
            const chunks = len > 0 ? Math.ceil(len / limit) : 1;
            const el = document.getElementById('charCounter');
            el.innerText = chunks > 1
                ? `${len} chars â€” ~${chunks} chunks`
                : `${len} chars`;
        }

        // --- Voices ---
        async function loadVoices() {
            try {
                const voices = await api('/voices');
                const list = document.getElementById('voiceList');
                const select = document.getElementById('voiceSelect');

                list.innerHTML = '';
                select.innerHTML = '';

                if (voices.length === 0) {
                    list.innerHTML = '<p style="color:var(--text-dim); text-align:center;">No voices found.</p>';
                    return;
                }

                voices.forEach(v => {
                    // List Item
                    const item = document.createElement('div');
                    item.className = 'list-item';
                    item.innerHTML = `
                        <div class="col-grow"><strong>${v.name}</strong></div>
                        <div class="col-actions">
                            <button style="padding:5px 10px;" onclick="playAudio('${API_BASE}/voices/${v.id}/reference', 'Ref: ${v.name}')">â–¶</button>
                            <button class="danger" style="padding:5px 10px;" onclick="deleteVoice('${v.id}')">ðŸ—‘</button>
                        </div>
                    `;
                    list.appendChild(item);

                    // Dropdown
                    const opt = document.createElement('option');
                    opt.value = v.id;
                    opt.innerText = v.name;
                    select.appendChild(opt);
                });
            } catch (e) { console.error(e); }
        }

        async function deleteVoice(vid) {
            if (!confirm('Delete this voice profile?')) return;
            try {
                await api('/voices/' + vid, 'DELETE');
                loadVoices();
            } catch (e) { alert(e.message); }
        }

        function showAddVoiceModal() { document.getElementById('addVoiceModal').classList.remove('hidden'); }
        function closeAddVoiceModal() { document.getElementById('addVoiceModal').classList.add('hidden'); }

        async function addVoice() {
            const name = document.getElementById('newVoiceName').value;
            const file = document.getElementById('newVoiceFile').files[0];
            if (!name || !file) { alert('Missing name or file.'); return; }

            const formData = new FormData();
            formData.append('name', name);
            formData.append('audio', file);

            const btn = document.querySelector('#addVoiceModal button:last-child');
            btn.disabled = true; btn.innerText = 'Processing...';

            try {
                const res = await fetch(API_BASE + '/voices/add', { method: 'POST', body: formData });
                if (!res.ok) throw new Error((await res.json()).detail);
                closeAddVoiceModal();
                loadVoices();
                alert('Voice added!');
            } catch (e) { alert(e.message); }
            finally { btn.disabled = false; btn.innerText = 'Create Voice'; }
        }

        // --- Generate & Poll ---
        async function generateSpeech() {
            const text = document.getElementById('TextInput').value;
            const vid = document.getElementById('voiceSelect').value;
            if (!text || !vid) { alert('Enter text and select voice.'); return; }

            // UI State
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('generateBtn').innerText = 'Generating...';
            document.getElementById('playBtn').classList.add('hidden');
            document.getElementById('resetBtn').classList.add('hidden');

            const progSec = document.getElementById('progressSection');
            progSec.classList.remove('hidden');

            // Reset logs
            document.getElementById('consoleLog').innerHTML = '';
            lastLogCount = 0;

            try {
                await api('/generate', 'POST', { text, voice_id: vid });
                // Start polling
                pollInterval = setInterval(pollStatus, 500);
            } catch (e) {
                alert('Error: ' + e.message);
                resetUI();
            }
        }

        async function pollStatus() {
            try {
                const status = await api('/generation_status');

                // Update Logs
                const logDiv = document.getElementById('consoleLog');
                if (status.logs && status.logs.length > lastLogCount) {
                    const newLogs = status.logs.slice(lastLogCount);
                    newLogs.forEach(l => {
                        const div = document.createElement('div');
                        div.innerText = l;
                        logDiv.appendChild(div);
                    });
                    lastLogCount = status.logs.length;
                    logDiv.scrollTop = logDiv.scrollHeight;
                }

                // Update Progress
                const pBar = document.getElementById('mainProgress');
                const pText = document.getElementById('progText');
                pBar.value = status.progress || 0;
                pText.innerText = (status.progress || 0) + '%';

                // Update Metrics
                document.getElementById('metricStatus').innerText = 'Status: ' + status.stage;
                if (status.metrics && status.metrics.start_time) {
                    const elapsed = (Date.now()/1000 - status.metrics.start_time).toFixed(1);
                    document.getElementById('metricTime').innerText = `Time: ${elapsed}s`;
                }
                document.getElementById('metricChunk').innerText = `Chunk: ${status.chunk_current}/${status.chunk_total}`;

                // Check Done
                if (status.stage === 'done') {
                    clearInterval(pollInterval);
                    finishGeneration(status);
                } else if (status.stage === 'error') {
                    clearInterval(pollInterval);
                    alert('Generation Failed: ' + status.error);
                    resetUI();
                }

            } catch (e) {
                console.error("Poll error", e);
            }
        }

        function finishGeneration(status) {
            document.getElementById('generateBtn').classList.add('hidden');

            const playBtn = document.getElementById('playBtn');
            playBtn.classList.remove('hidden');

            const resetBtn = document.getElementById('resetBtn');
            resetBtn.classList.remove('hidden');

            currentResultPath = status.output_path;

            // Do NOT autoplay, but prep player
            playAudio(currentResultPath, 'Generated Audio');
            mainAudio.pause(); // Ensure paused
        }

        function resetGeneration() {
            resetUI();
        }

        function resetUI() {
            if (pollInterval) clearInterval(pollInterval);
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('generateBtn').innerText = 'Generate Audio';
            document.getElementById('generateBtn').classList.remove('hidden');

            document.getElementById('playBtn').classList.add('hidden');
            document.getElementById('resetBtn').classList.add('hidden');
            document.getElementById('progressSection').classList.add('hidden');

            currentResultPath = null;
        }

        // --- History ---
        async function loadHistory() {
            try {
                const history = await api('/history');
                const list = document.getElementById('historyList');
                list.innerHTML = '';
                if (history.length === 0) {
                    list.innerHTML = '<p style="color:var(--text-dim); text-align:center;">No history.</p>';
                    return;
                }
                history.forEach(h => {
                    const row = document.createElement('div');
                    row.className = 'list-item';
                    row.innerHTML = `
                        <div class="col-check"><input type="checkbox" class="hist-check" value="${h.filename}"></div>
                        <div class="col-grow">
                            <div style="font-weight:bold;">${h.text.substring(0,50)}...</div>
                            <div style="font-size:0.8em; color:var(--text-dim);">Voice: ${h.voice_id}</div>
                        </div>
                        <div class="col-date">${h.date}</div>
                        <div class="col-actions">
                            <button onclick="playAudio('${API_BASE}/output/${h.filename}', 'History item')">â–¶</button>
                            <button class="danger" onclick="deleteSingleHistory('${h.filename}')">ðŸ—‘</button>
                        </div>
                    `;
                    list.appendChild(row);
                });
            } catch (e) { console.error(e); }
        }

        async function deleteSingleHistory(fn) {
            if(confirm('Delete?')) { await api('/history/delete', 'POST', {filenames:[fn]}); loadHistory(); }
        }
        async function deleteSelectedHistory() {
            const fns = Array.from(document.querySelectorAll('.hist-check:checked')).map(c=>c.value);
            if(fns.length && confirm(`Delete ${fns.length}?`)) { await api('/history/delete', 'POST', {filenames:fns}); loadHistory(); }
        }

        async function downloadModel() {
             if(!document.getElementById('licenseCheck').checked) return alert('Agree to license first.');
             await api('/download', 'POST', {agree:true});
             checkStatus();
        }

        async function checkRequirementsManual() {
            const sdk = new ModuleSDK('mod_xtts');
            const reqs = await sdk.checkRequirements();
            if (reqs && reqs.missing && reqs.missing.length > 0) {
                sdk.showInstallModal(reqs.missing);
            } else {
                alert("All requirements are satisfied.");
            }
        }

        function loadThemeCSS(url) {
            let link = document.getElementById('theme-css');
            if (!link) {
                link = document.createElement('link');
                link.id = 'theme-css';
                link.rel = 'stylesheet';
                document.head.appendChild(link);
            }
            link.href = url;
        }

        function clearThemeCSS() {
            const link = document.getElementById('theme-css');
            if (link) link.remove();
        }

        // --- Theme Listener ---
        window.addEventListener('message', (e) => {
            if (e.data.type === 'THEME_UPDATE') {
                document.body.setAttribute('data-theme', e.data.theme);

                // Color override if provided
                if(e.data.brandColor) {
                    document.documentElement.style.setProperty('--brand-color', e.data.brandColor);
                    const hex = e.data.brandColor.replace('#', '');
                    const r = parseInt(hex.substring(0,2), 16);
                    const g = parseInt(hex.substring(2,4), 16);
                    const b = parseInt(hex.substring(4,6), 16);
                    document.documentElement.style.setProperty('--brand-color-dim', `rgba(${r},${g},${b}, 0.1)`);
                }

                if(e.data.fontSize) {
                     // We might need to adjust root font size if we used rem, but we used px mostly.
                     // But we can set a variable.
                     // document.documentElement.style.setProperty('--font-size-base', e.data.fontSize + 'px');
                }

                if (e.data.themeCssUrl) loadThemeCSS(e.data.themeCssUrl);
                else clearThemeCSS();
            }
        });

    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Server Status</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet" />
    <style>
        :root {
            --bg-core: #050505;
            --text-head: #ffffff;
            --text-body: #b0b0b0;
            --text-dim: #666666;
            --brand-color: #10B981;
            --brand-color-dim: rgba(16, 185, 129, 0.1);
            --border-color: #222222;
        }

        body[data-theme="light"] {
            --bg-core: #eef0f4;
            --text-head: #111111;
            --text-body: #333333;
            --text-dim: #555555;
            --border-color: #d1d5db;
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; border: 2px solid transparent; background-clip: content-box; }
        ::-webkit-scrollbar-thumb:hover { background-color: var(--brand-color); }

        body {
            background-color: var(--bg-core);
            color: var(--text-body);
            font-family: 'Inter', sans-serif;
            margin: 0; padding: 20px;
            font-size: 13px;
            overflow-y: auto;
        }

        /* Tabs Styles */
        .tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 15px; }
        .tab-btn {
            background: transparent; border: none; color: var(--text-dim);
            padding: 8px 12px; font-family: 'JetBrains Mono'; font-size: 11px;
            cursor: pointer; text-transform: uppercase; border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .tab-btn:hover { color: var(--text-head); }
        .tab-btn.active { color: var(--brand-color); border-bottom-color: var(--brand-color); }

        .tab-content { display: none; animation: fadeIn 0.2s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Bars */
        .progress-bg { width: 100%; height: 6px; background: rgba(128,128,128,0.2); border-radius: 3px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; background: var(--brand-color); width: 0%; transition: width 0.5s; }

        /* Pop Out Button */
        .pop-out-btn {
            float: right; font-size: 10px; border: 1px solid var(--border-color);
            background: transparent; color: var(--text-dim); padding: 2px 6px;
            border-radius: 4px; cursor: pointer; margin-top: -35px;
        }
        .pop-out-btn:hover { color: var(--text-head); border-color: var(--brand-color); }

        h2 {
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-head);
            font-size: 16px;
            margin-top: 0;
            padding-bottom: 10px;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 12px;
        }
        .stat-label { font-weight: 500; }
        .stat-value { font-family: 'JetBrains Mono', monospace; color: var(--brand-color); }

        /* Widget Mode Styles */
        body.widget-mode {
            padding: 10px; overflow: hidden;
            background: transparent;
        }
        body.widget-mode .tabs { display: none; }
        body.widget-mode .pop-out-btn { display: none; }
        body.widget-mode h2 { font-size: 12px; margin-bottom: 5px; border: none; padding-bottom: 0; }
        body.widget-mode .stat-row { padding: 2px 0; font-size: 11px; }
        body.widget-mode .progress-bg { height: 4px; }

        /* Charts (Simple CSS Bars) */
        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .chart-card { background: rgba(128,128,128,0.05); padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); }
        .big-stat { font-family: 'JetBrains Mono'; font-size: 24px; color: var(--text-head); margin: 5px 0; }
        .sub-stat { font-size: 10px; color: var(--text-dim); font-family:'JetBrains Mono'; }

    </style>
</head>
<body>
    <!-- Auth/Conn Status -->
    <div id="connection-info" style="display:none;"></div>

    <!-- Tabs Header -->
    <div class="tabs">
        <button class="tab-btn active" id="btn-tab-sys" onclick="switchTab('sys')">System</button>
        <button class="tab-btn" id="btn-tab-gpu" onclick="switchTab('gpu')">GPU</button>
        <button class="tab-btn" id="btn-tab-info" onclick="switchTab('info')">Info</button>
    </div>

    <!-- System Tab -->
    <div id="tab-sys" class="tab-content active">
        <button class="pop-out-btn" onclick="popOut('sys')">⬈ POP OUT</button>
        <h2>System Resources</h2>

        <div class="chart-grid">
            <div class="chart-card">
                <div class="sub-stat">CPU LOAD</div>
                <div class="big-stat" id="val-cpu">0%</div>
                <div class="progress-bg"><div class="progress-fill" id="bar-cpu"></div></div>
            </div>
            <div class="chart-card">
                <div class="sub-stat">RAM USAGE</div>
                <div class="big-stat" id="val-ram">0%</div>
                <div class="progress-bg"><div class="progress-fill" id="bar-ram"></div></div>
                <div class="sub-stat" id="sub-ram" style="margin-top:4px;">0/0 GB</div>
            </div>
        </div>

        <div style="margin-top:15px; border-bottom:1px solid var(--border-color); padding-bottom:4px; margin-bottom:8px; font-family:'JetBrains Mono'; font-size:11px; color:var(--text-dim);">DRIVES</div>
        <div id="drives-container"></div>
    </div>

    <!-- GPU Tab -->
    <div id="tab-gpu" class="tab-content">
        <button class="pop-out-btn" onclick="popOut('gpu')">⬈ POP OUT</button>
        <h2>GPU Status</h2>
        <div id="gpu-container">Loading...</div>
    </div>

    <!-- Info Tab -->
    <div id="tab-info" class="tab-content">
        <h2>System Information</h2>
        <div id="info-container" style="font-family:'JetBrains Mono'; font-size:12px; display:flex; flex-direction:column; gap:8px;">
            Loading...
        </div>
    </div>

    <script>
        let coreUrl = localStorage.getItem('lyrn_core_url');
        let authToken = localStorage.getItem('lyrn_admin_token') || null;
        let intervalId = null;

        // Parse Query Params
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode');
        const defaultTab = urlParams.get('tab') || 'sys';

        if(mode === 'widget') {
            document.body.classList.add('widget-mode');
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

            document.getElementById('tab-' + tabId).classList.add('active');
            const btn = document.getElementById('btn-tab-' + tabId);
            if(btn) btn.classList.add('active');
        }

        // Init Tab
        switchTab(defaultTab);

        function popOut(tab) {
            const title = tab.toUpperCase() + " Widget";
            window.parent.postMessage({
                type: 'OPEN_WIDGET',
                id: 'widget_' + tab,
                name: title,
                file: 'ServerStatus.html?mode=widget&tab=' + tab
            }, '*');
        }

        function loadThemeCSS(url) {
            let link = document.getElementById('theme-css');
            if (!link) {
                link = document.createElement('link');
                link.id = 'theme-css';
                link.rel = 'stylesheet';
                document.head.appendChild(link);
            }
            link.href = url;
        }

        function clearThemeCSS() {
            const link = document.getElementById('theme-css');
            if (link) link.remove();
        }

        // Listen for messages
        window.addEventListener('message', (e) => {
            if (e.data.type === 'CORE_URL_CHANGE') {
                coreUrl = e.data.url;
                startMonitoring();
                fetchSysInfo();
            }
            if (e.data.type === 'THEME_CHANGE') {
                document.body.setAttribute('data-theme', e.data.theme);
            }
            if (e.data.type === 'FONT_CHANGE') {
                document.documentElement.style.setProperty('--font-size-base', e.data.fontSize + 'px');
            }
            if (e.data.type === 'TOKEN_UPDATE') {
                const wasNull = !authToken;
                authToken = e.data.token;
                if(wasNull) {
                    startMonitoring();
                    fetchSysInfo();
                }
            }
            if (e.data.type === 'THEME_UPDATE') {
                document.body.setAttribute('data-theme', e.data.theme);
                document.documentElement.style.setProperty('--brand-color', e.data.brandColor);
                const hex = e.data.brandColor.replace('#', '');
                const r = parseInt(hex.substring(0,2), 16);
                const g = parseInt(hex.substring(2,4), 16);
                const b = parseInt(hex.substring(4,6), 16);
                document.documentElement.style.setProperty('--brand-color-dim', `rgba(${r},${g},${b}, 0.1)`);
                document.documentElement.style.setProperty('--font-size-base', e.data.fontSize + 'px');

                if (e.data.themeCssUrl) loadThemeCSS(e.data.themeCssUrl);
                else clearThemeCSS();
            }
        });

        function startMonitoring() {
            if(intervalId) clearInterval(intervalId);
            if(!coreUrl || !authToken) return;
            fetchStats();
            intervalId = setInterval(fetchStats, 2000);
            fetchSysInfo();
        }

        async function fetchSysInfo() {
            if(!coreUrl || !authToken) return;
            try {
                const res = await fetch(coreUrl + '/api/sysinfo', {
                    headers: { 'X-Token': authToken }
                });
                if(res.ok) {
                    const data = await res.json();
                    let html = `
                        <div class="stat-row"><span class="stat-label">Hostname</span><span class="stat-value">${data.hostname}</span></div>
                        <div class="stat-row"><span class="stat-label">IP Address</span><span class="stat-value">${data.ip_address}</span></div>
                        <div class="stat-row"><span class="stat-label">OS</span><span class="stat-value">${data.os}</span></div>
                        <div class="stat-row"><span class="stat-label">CPU Model</span><span class="stat-value">${data.cpu_model}</span></div>
                    `;
                    document.getElementById('info-container').innerHTML = html;
                }
            } catch(e) {}
        }

        async function fetchStats() {
            if(!authToken) return;
            try {
                // Assuming /health is public or we pass token if needed.
                // Currently /health is public in lyrn_web_v5.py.
                const res = await fetch(coreUrl + '/health', {
                    headers: authToken ? { 'X-Token': authToken } : {}
                });
                if(!res.ok) return;

                const data = await res.json();
                updateUI(data);
            } catch(e) {
                console.error(e);
            }
        }

        function updateUI(data) {
            // System
            document.getElementById('val-cpu').innerText = data.cpu.percent + '%';
            document.getElementById('bar-cpu').style.width = data.cpu.percent + '%';

            document.getElementById('val-ram').innerText = Math.round(data.ram.percent) + '%';
            document.getElementById('bar-ram').style.width = data.ram.percent + '%';
            document.getElementById('sub-ram').innerText = `${data.ram.used_gb.toFixed(1)} / ${data.ram.total_gb.toFixed(1)} GB`;

            // Drives
            if (data.disk && data.disk.partitions) {
                let drivesHtml = "";
                data.disk.partitions.forEach(p => {
                     drivesHtml += `
                        <div style="background:rgba(128,128,128,0.05); padding:8px; border-radius:4px; margin-bottom:5px;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:4px; font-size:11px;">
                                <span style="font-family:'JetBrains Mono'">${p.mountpoint}</span>
                                <span>${p.percent}%</span>
                            </div>
                            <div class="progress-bg"><div class="progress-fill" style="width:${p.percent}%"></div></div>
                            <div style="font-size:10px; color:var(--text-dim); margin-top:2px; display:flex; justify-content:space-between;">
                                <span>${p.fstype}</span>
                                <span>${p.used_gb.toFixed(1)} / ${p.total_gb.toFixed(1)} GB</span>
                            </div>
                        </div>
                     `;
                });
                document.getElementById('drives-container').innerHTML = drivesHtml;
            } else {
                 // Fallback if no detailed partitions
                 document.getElementById('drives-container').innerHTML = `
                    <div style="background:rgba(128,128,128,0.05); padding:8px; border-radius:4px;">
                         <div style="display:flex; justify-content:space-between;"><span>Root</span><span>${data.disk.percent}%</span></div>
                         <div class="progress-bg"><div class="progress-fill" style="width:${data.disk.percent}%"></div></div>
                    </div>
                 `;
            }

            // GPU
            const gpuContainer = document.getElementById('gpu-container');
            const gpuBtn = document.getElementById('btn-tab-gpu');

            if(data.gpu && data.gpu.vram_percent !== undefined) {
                gpuBtn.style.display = 'block';
                // Render GPU Stats
                gpuContainer.innerHTML = `
                    <div class="chart-card">
                        <div class="sub-stat">VRAM USAGE</div>
                        <div class="big-stat">${data.gpu.vram_percent.toFixed(1)}%</div>
                        <div class="progress-bg"><div class="progress-fill" style="width:${data.gpu.vram_percent}%"></div></div>
                        <div class="sub-stat" style="margin-top:4px;">${data.gpu.vram_used_gb.toFixed(1)} / ${data.gpu.vram_total_gb.toFixed(1)} GB</div>
                    </div>
                `;
            } else {
                // If no GPU, hide tab unless active
                if(document.getElementById('tab-gpu').classList.contains('active')) {
                     gpuContainer.innerHTML = "<div style='padding:10px; color:var(--text-dim)'>No GPU Detected</div>";
                } else {
                    gpuBtn.style.display = 'none';
                }
            }
        }

        // Init
        if(coreUrl && authToken) startMonitoring();

    </script>
</body>
</html>
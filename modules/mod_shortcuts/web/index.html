<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Shortcuts</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet" />
    <style>
        :root {
            --bg-core: #050505;
            --bg-panel: #0a0a0a;
            --bg-card: #111;
            --brand-purple: #7c5cff;
            --text-head: #ffffff;
            --text-body: #b0b0b0;
            --text-dim: #666666;
            --border-color: #222222;
            --success-color: #10B981;
            --error-color: #ff4444;
        }

        body[data-theme="light"] {
            --bg-core: #eef0f4;
            --bg-panel: #ffffff;
            --bg-card: #f8f9fa;
            --brand-purple: #6a4ce0;
            --text-head: #111111;
            --text-body: #333333;
            --text-dim: #555555;
            --border-color: #d1d5db;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-core);
            color: var(--text-body);
            font-family: 'Inter', sans-serif;
            margin: 0; padding: 20px;
            font-size: 13px;
            height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        .header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; flex-shrink: 0;
        }
        .header h2 { margin: 0; font-size: 18px; color: var(--text-head); font-weight: 600; }

        .btn {
            background: var(--bg-panel); border: 1px solid var(--border-color);
            color: var(--text-head); padding: 8px 16px; border-radius: 6px;
            cursor: pointer; font-size: 12px; font-weight: 500;
            transition: all 0.2s; display: flex; align-items: center; gap: 6px;
        }
        .btn:hover { border-color: var(--text-dim); background: var(--bg-card); }
        .btn.primary { background: var(--brand-purple); border-color: var(--brand-purple); color: #fff; }
        .btn.primary:hover { opacity: 0.9; }
        .btn.danger { color: var(--error-color); border-color: rgba(255,68,68,0.3); }
        .btn.danger:hover { background: var(--error-color); color: #fff; }

        /* Grid */
        #shortcuts-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px; overflow-y: auto; padding-bottom: 20px; flex: 1;
        }

        .shortcut-card {
            background: var(--bg-panel); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 15px; display: flex; flex-direction: column;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .shortcut-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); border-color: var(--text-dim); }

        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .card-title { font-weight: 600; color: var(--text-head); font-size: 14px; margin-bottom: 4px; }
        .card-type { font-size: 10px; text-transform: uppercase; color: var(--text-dim); background: rgba(255,255,255,0.05); padding: 2px 6px; border-radius: 4px; border: 1px solid var(--border-color); }

        .card-path {
            font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text-dim);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 15px;
        }

        .card-actions { display: flex; gap: 8px; margin-top: auto; }
        .card-btn { flex: 1; padding: 6px; justify-content: center; }

        /* Modals */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(2px);
            z-index: 100; display: none; align-items: center; justify-content: center;
        }
        .modal {
            background: var(--bg-panel); border: 1px solid var(--border-color);
            border-radius: 8px; width: 500px; max-width: 90%; max-height: 90vh;
            display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .modal-header {
            padding: 15px 20px; border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-title { font-weight: 600; color: var(--text-head); }
        .modal-body { padding: 20px; overflow-y: auto; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 10px; }

        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; color: var(--text-dim); font-size: 11px; text-transform: uppercase; }
        .form-input, .form-select {
            width: 100%; padding: 8px; background: var(--bg-core); border: 1px solid var(--border-color);
            color: var(--text-head); border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 12px;
        }
        .form-input:focus { border-color: var(--brand-purple); outline: none; }

        .checkbox-group { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; cursor: pointer; user-select: none; }
        .checkbox-group input { cursor: pointer; }

        /* Output View */
        #output-content {
            background: #000; color: #ccc; font-family: 'JetBrains Mono', monospace;
            padding: 10px; border-radius: 4px; height: 300px; overflow-y: auto;
            white-space: pre-wrap; font-size: 11px; border: 1px solid var(--border-color);
        }
        .status-badge {
            display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;
        }
        .status-success { background: rgba(16, 185, 129, 0.2); color: var(--success-color); }
        .status-error { background: rgba(255, 68, 68, 0.2); color: var(--error-color); }

    </style>
</head>
<body>

    <div class="header">
        <h2>Shortcuts</h2>
        <button class="btn primary" onclick="openEditModal()">+ New Shortcut</button>
    </div>

    <div id="shortcuts-grid">
        <!-- Injected JS -->
    </div>

    <!-- Edit Modal -->
    <div id="modal-edit" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title" id="edit-modal-title">Add Shortcut</span>
                <button class="btn" style="padding:4px 8px;" onclick="closeModal('modal-edit')">âœ•</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="inp-id">
                <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" id="inp-name" class="form-input" placeholder="My Script">
                </div>
                <div class="form-group">
                    <label class="form-label">Path</label>
                    <input type="text" id="inp-path" class="form-input" placeholder="/path/to/script.py">
                </div>
                <div class="form-group" style="display:flex; gap:10px;">
                    <div style="flex:1;">
                        <label class="form-label">Type</label>
                        <select id="inp-type" class="form-select">
                            <option value="auto">Auto-detect</option>
                            <option value="python">Python</option>
                            <option value="node">Node.js</option>
                            <option value="bash">Bash/Sh</option>
                            <option value="bat">Batch</option>
                            <option value="powershell">PowerShell</option>
                            <option value="exe">Executable</option>
                        </select>
                    </div>
                    <div style="flex:1;">
                        <label class="form-label">Run Mode</label>
                        <select id="inp-runmode" class="form-select">
                            <option value="output">Show Output Panel</option>
                            <option value="terminal">Run in Terminal Tab</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Arguments (Optional)</label>
                    <input type="text" id="inp-args" class="form-input" placeholder="--flag value">
                </div>
                <div class="form-group">
                    <label class="form-label">Working Directory (Optional)</label>
                    <input type="text" id="inp-cwd" class="form-input" placeholder="/path/to/workdir">
                </div>

                <label class="checkbox-group">
                    <input type="checkbox" id="inp-confirm">
                    <span>Require Confirmation before running</span>
                </label>
                <label class="checkbox-group">
                    <input type="checkbox" id="inp-capture" checked>
                    <span>Capture Output (Output Mode only)</span>
                </label>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modal-edit')">Cancel</button>
                <button class="btn primary" onclick="saveShortcut()">Save</button>
            </div>
        </div>
    </div>

    <!-- Output Modal -->
    <div id="modal-output" class="modal-overlay">
        <div class="modal" style="width: 700px;">
            <div class="modal-header">
                <span class="modal-title">Execution Result</span>
                <button class="btn" style="padding:4px 8px;" onclick="closeModal('modal-output')">âœ•</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom:10px;" id="output-status"></div>
                <div id="output-content">Running...</div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modal-output')">Close</button>
            </div>
        </div>
    </div>

    <script>
        let coreUrl = localStorage.getItem('lyrn_core_url');
        let authToken = localStorage.getItem('lyrn_admin_token');
        let shortcuts = [];

        window.addEventListener('message', (e) => {
            if (e.data.type === 'CORE_URL_CHANGE') {
                coreUrl = e.data.url;
                loadShortcuts();
            }
            if (e.data.type === 'TOKEN_UPDATE') {
                authToken = e.data.token;
                loadShortcuts();
            }
            if (e.data.type === 'THEME_CHANGE') document.body.setAttribute('data-theme', e.data.theme);
            if (e.data.type === 'OPEN_ADD_MODAL') {
                // Sent from File Explorer
                openEditModal(null, e.data.payload);
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            loadShortcuts();
        });

        async function loadShortcuts() {
            if(!coreUrl || !authToken) return;
            try {
                // Use new endpoint
                const res = await fetch(`${coreUrl}/api/modules/mod_shortcuts/`, {
                    headers: { 'X-Token': authToken }
                });
                if(res.ok) {
                    shortcuts = await res.json();
                    renderGrid();
                }
            } catch(e) { console.error(e); }
        }

        function renderGrid() {
            const grid = document.getElementById('shortcuts-grid');
            grid.innerHTML = '';

            if(shortcuts.length === 0) {
                grid.innerHTML = '<div style="text-align:center; grid-column:1/-1; color:var(--text-dim); padding-top:50px;">No shortcuts created yet.</div>';
                return;
            }

            shortcuts.forEach(s => {
                const card = document.createElement('div');
                card.className = 'shortcut-card';

                const modeIcon = s.run_mode === 'terminal' ? 'ðŸ’»' : 'ðŸ“„';
                const runAction = s.confirm ? `confirmRun('${s.id}')` : `runShortcut('${s.id}')`;

                card.innerHTML = `
                    <div class="card-header">
                        <div class="card-title">${s.name}</div>
                        <div class="card-type">${s.type}</div>
                    </div>
                    <div class="card-path" title="${s.path}">${s.path}</div>
                    <div class="card-actions">
                        <button class="btn primary card-btn" onclick="${runAction}">â–¶ Run</button>
                        <button class="btn card-btn" onclick="openEditModal('${s.id}')">âœŽ</button>
                        <button class="btn danger card-btn" onclick="deleteShortcut('${s.id}')" style="flex:0;">ðŸ—‘</button>
                    </div>
                    <div style="font-size:10px; color:var(--text-dim); margin-top:5px; text-align:right;">${modeIcon} ${s.run_mode}</div>
                `;
                grid.appendChild(card);
            });
        }

        // --- CRUD ---

        function openEditModal(id = null, prefill = null) {
            const isEdit = !!id;
            document.getElementById('edit-modal-title').innerText = isEdit ? 'Edit Shortcut' : 'Add Shortcut';
            document.getElementById('inp-id').value = id || '';

            if (isEdit) {
                const s = shortcuts.find(x => x.id === id);
                if(s) {
                    document.getElementById('inp-name').value = s.name;
                    document.getElementById('inp-path').value = s.path;
                    document.getElementById('inp-type').value = s.type;
                    document.getElementById('inp-args').value = s.args || '';
                    document.getElementById('inp-cwd').value = s.cwd || '';
                    document.getElementById('inp-runmode').value = s.run_mode || 'output';
                    document.getElementById('inp-confirm').checked = s.confirm;
                    document.getElementById('inp-capture').checked = s.capture_output;
                }
            } else if (prefill) {
                // Prefill from File Explorer
                document.getElementById('inp-name').value = prefill.name || '';
                document.getElementById('inp-path').value = prefill.path || '';
                document.getElementById('inp-type').value = prefill.type || 'auto';
                document.getElementById('inp-args').value = '';
                document.getElementById('inp-cwd').value = prefill.cwd || '';
                document.getElementById('inp-runmode').value = prefill.run_mode || 'terminal'; // Default for files
                document.getElementById('inp-confirm').checked = true;
                document.getElementById('inp-capture').checked = true;
            } else {
                // Clear
                document.getElementById('inp-name').value = '';
                document.getElementById('inp-path').value = '';
                document.getElementById('inp-type').value = 'auto';
                document.getElementById('inp-args').value = '';
                document.getElementById('inp-cwd').value = '';
                document.getElementById('inp-runmode').value = 'output';
                document.getElementById('inp-confirm').checked = false;
                document.getElementById('inp-capture').checked = true;
            }

            document.getElementById('modal-edit').style.display = 'flex';
        }

        async function saveShortcut() {
            const id = document.getElementById('inp-id').value;
            const data = {
                name: document.getElementById('inp-name').value,
                path: document.getElementById('inp-path').value,
                type: document.getElementById('inp-type').value,
                args: document.getElementById('inp-args').value,
                cwd: document.getElementById('inp-cwd').value,
                run_mode: document.getElementById('inp-runmode').value,
                confirm: document.getElementById('inp-confirm').checked,
                capture_output: document.getElementById('inp-capture').checked
            };

            if(!data.name || !data.path) {
                alert("Name and Path are required.");
                return;
            }

            try {
                let res;
                if (id) {
                    data.id = id;
                    res = await fetch(`${coreUrl}/api/modules/mod_shortcuts/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'X-Token': authToken },
                        body: JSON.stringify(data)
                    });
                } else {
                    res = await fetch(`${coreUrl}/api/modules/mod_shortcuts/`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-Token': authToken },
                        body: JSON.stringify(data)
                    });
                }

                if(res.ok) {
                    closeModal('modal-edit');
                    loadShortcuts();
                } else {
                    alert("Error saving: " + await res.text());
                }
            } catch(e) { alert(e.message); }
        }

        async function deleteShortcut(id) {
            if(!confirm("Delete this shortcut?")) return;
            try {
                await fetch(`${coreUrl}/api/modules/mod_shortcuts/${id}`, {
                    method: 'DELETE',
                    headers: { 'X-Token': authToken }
                });
                loadShortcuts();
            } catch(e) { alert(e); }
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // --- Execution ---

        function confirmRun(id) {
            const s = shortcuts.find(x => x.id === id);
            if(confirm(`Run shortcut "${s.name}"?`)) {
                runShortcut(id);
            }
        }

        async function runShortcut(id) {
            const s = shortcuts.find(x => x.id === id);
            if(!s) return;

            if (s.run_mode === 'terminal') {
                try {
                    const res = await fetch(`${coreUrl}/api/modules/mod_shortcuts/${id}/run`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-Token': authToken },
                        body: JSON.stringify({ run_mode: 'terminal' })
                    });
                    const data = await res.json();

                    if (data.action === 'terminal') {
                        // Send message to parent
                        window.parent.postMessage({
                            type: 'OPEN_TERMINAL_TAB',
                            cwd: data.cwd,
                            command: data.command
                        }, '*');
                    } else {
                        alert("Unexpected response: " + JSON.stringify(data));
                    }
                } catch(e) { alert("Failed to initiate terminal run: " + e.message); }
                return;
            }

            // Output Mode
            document.getElementById('modal-output').style.display = 'flex';
            const content = document.getElementById('output-content');
            const status = document.getElementById('output-status');
            content.innerText = "Running...";
            status.innerHTML = '<span class="status-badge" style="background:#333; color:#fff;">EXECUTING</span>';

            try {
                const res = await fetch(`${coreUrl}/api/modules/mod_shortcuts/${id}/run`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Token': authToken },
                    body: JSON.stringify({ run_mode: 'output' })
                });
                const result = await res.json();

                if (result.exit_code === 0) {
                    status.innerHTML = '<span class="status-badge status-success">SUCCESS</span>';
                } else {
                    status.innerHTML = `<span class="status-badge status-error">FAILED (Exit: ${result.exit_code})</span>`;
                }

                let text = "";
                if (result.stdout) text += result.stdout + "\n";
                if (result.stderr) text += "--- STDERR ---\n" + result.stderr;
                content.innerText = text || "(No Output)";

            } catch(e) {
                status.innerHTML = '<span class="status-badge status-error">ERROR</span>';
                content.innerText = "Request Failed: " + e.message;
            }
        }

    </script>
</body>
</html>

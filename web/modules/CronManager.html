<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cron Manager</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet" />
    <style>
        :root {
            --bg-core: #050505;
            --bg-panel: #0a0a0a;
            --text-head: #ffffff;
            --text-body: #b0b0b0;
            --text-dim: #666666;
            --brand-purple: #7c5cff;
            --border-color: #222222;
            --bg-input: #111;
        }

        body[data-theme="light"] {
            --bg-core: #eef0f4;
            --bg-panel: #ffffff;
            --text-head: #111111;
            --text-body: #333333;
            --text-dim: #555555;
            --border-color: #d1d5db;
            --brand-purple: #6a4ce0;
            --bg-input: #f3f4f6;
        }

        body {
            background-color: var(--bg-core);
            color: var(--text-body);
            font-family: 'Inter', sans-serif;
            margin: 0; padding: 0;
            height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        #toolbar {
            padding: 10px 15px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border-color); background: var(--bg-panel);
            font-family: 'JetBrains Mono'; font-weight: bold; color: var(--text-head);
        }

        button {
            background: var(--bg-input); border: 1px solid var(--border-color);
            color: var(--text-body); padding: 6px 12px; border-radius: 4px;
            cursor: pointer; font-family: 'JetBrains Mono'; font-size: 11px;
            transition: all 0.2s;
        }
        button:hover { border-color: var(--brand-purple); color: var(--text-head); }
        button.primary { background: var(--brand-purple); border-color: var(--brand-purple); color: #fff; }
        button.primary:hover { opacity: 0.9; }

        #cron-editor {
            flex: 1; width: 100%; resize: none; border: none; outline: none;
            background: var(--bg-core); color: var(--text-body);
            font-family: 'JetBrains Mono', monospace; font-size: 13px;
            padding: 15px; line-height: 1.5;
        }
    </style>
</head>
<body>
    <div id="toolbar">
        <span>USER CRONTAB</span>
        <button class="primary" onclick="saveCron()">Save Changes</button>
    </div>

    <textarea id="cron-editor" spellcheck="false" placeholder="# Edit your crontab here..."></textarea>

    <script>
        let coreUrl = localStorage.getItem('lyrn_core_url');
        let authToken = localStorage.getItem('lyrn_admin_token');

        window.addEventListener('message', (e) => {
            if (e.data.type === 'CORE_URL_CHANGE') { coreUrl = e.data.url; loadCron(); }
            if (e.data.type === 'TOKEN_UPDATE') { authToken = e.data.token; loadCron(); }
            if (e.data.type === 'THEME_CHANGE') document.body.setAttribute('data-theme', e.data.theme);
        });

        async function loadCron() {
            if(!coreUrl || !authToken) return;
            document.getElementById('cron-editor').value = "Loading...";

            try {
                const res = await fetch(coreUrl + '/api/cron', {
                    headers: { 'X-Token': authToken }
                });

                if(res.status === 501) {
                    document.getElementById('cron-editor').value = "# Error: python-crontab not installed on server.";
                    return;
                }

                if(res.ok) {
                    const data = await res.json();
                    document.getElementById('cron-editor').value = data.lines;
                } else {
                     document.getElementById('cron-editor').value = "# Failed to load crontab.";
                }
            } catch(e) {
                console.error(e);
                document.getElementById('cron-editor').value = "# Connection Error";
            }
        }

        async function saveCron() {
            if(!confirm("Overwrite crontab with these contents?")) return;
            const lines = document.getElementById('cron-editor').value;

            try {
                const res = await fetch(coreUrl + '/api/cron', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Token': authToken
                    },
                    body: JSON.stringify({ lines: lines })
                });

                if(res.ok) {
                    alert("Crontab saved successfully.");
                } else {
                    const txt = await res.text();
                    alert("Error saving: " + txt);
                }
            } catch(e) {
                alert("Connection Error: " + e.message);
            }
        }

        if(coreUrl && authToken) loadCron();
    </script>
</body>
</html>

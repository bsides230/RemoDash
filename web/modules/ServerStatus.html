<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Server Status</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet" />
    <style>
        :root {
            --bg-core: #050505;
            --text-head: #ffffff;
            --text-body: #b0b0b0;
            --text-dim: #666666;
            --brand-purple: #7c5cff;
            --brand-purple-dim: rgba(124, 92, 255, 0.1);
            --border-color: #222222;
        }

        body[data-theme="light"] {
            --bg-core: #eef0f4;
            --brand-purple: #6a4ce0;
            --brand-purple-dim: rgba(106, 76, 224, 0.1);
            --text-head: #111111;
            --text-body: #333333;
            --text-dim: #555555;
            --border-color: #d1d5db;
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; border: 2px solid transparent; background-clip: content-box; }
        ::-webkit-scrollbar-thumb:hover { background-color: var(--brand-purple); }

        body {
            background-color: var(--bg-core);
            color: var(--text-body);
            font-family: 'Inter', sans-serif;
            margin: 0; padding: 20px;
            font-size: 13px;
            overflow-y: auto;
        }

        /* Tabs Styles */
        .tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 15px; }
        .tab-btn {
            background: transparent; border: none; color: var(--text-dim);
            padding: 8px 12px; font-family: 'JetBrains Mono'; font-size: 11px;
            cursor: pointer; text-transform: uppercase; border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .tab-btn:hover { color: var(--text-head); }
        .tab-btn.active { color: var(--brand-purple); border-bottom-color: var(--brand-purple); }

        .tab-content { display: none; animation: fadeIn 0.2s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Bars */
        .progress-bg { width: 100%; height: 6px; background: rgba(128,128,128,0.2); border-radius: 3px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; background: var(--brand-purple); width: 0%; transition: width 0.5s; }

        /* Pop Out Button */
        .pop-out-btn {
            float: right; font-size: 10px; border: 1px solid var(--border-color);
            background: transparent; color: var(--text-dim); padding: 2px 6px;
            border-radius: 4px; cursor: pointer; margin-top: -35px;
        }
        .pop-out-btn:hover { color: var(--text-head); border-color: var(--brand-purple); }

        h2 {
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-head);
            font-size: 16px;
            margin-top: 0;
            padding-bottom: 10px;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 12px;
        }
        .stat-label { font-weight: 500; }
        .stat-value { font-family: 'JetBrains Mono', monospace; color: var(--brand-purple); }

        /* Widget Mode Styles */
        body.widget-mode {
            padding: 10px; overflow: hidden;
            background: transparent;
        }
        body.widget-mode .tabs { display: none; }
        body.widget-mode .pop-out-btn { display: none; }
        body.widget-mode h2 { font-size: 12px; margin-bottom: 5px; border: none; padding-bottom: 0; }
        body.widget-mode .stat-row { padding: 2px 0; font-size: 11px; }
        body.widget-mode .progress-bg { height: 4px; }

        /* Charts (Simple CSS Bars) */
        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .chart-card { background: rgba(128,128,128,0.05); padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); }
        .big-stat { font-family: 'JetBrains Mono'; font-size: 24px; color: var(--text-head); margin: 5px 0; }
        .sub-stat { font-size: 10px; color: var(--text-dim); font-family:'JetBrains Mono'; }

    </style>
</head>
<body>
    <!-- Auth/Conn Status -->
    <div id="connection-info" style="display:none;"></div>

    <!-- Tabs Header -->
    <div class="tabs">
        <button class="tab-btn active" id="btn-tab-sys" onclick="switchTab('sys')">System</button>
        <button class="tab-btn" id="btn-tab-gpu" onclick="switchTab('gpu')">GPU</button>
        <button class="tab-btn" id="btn-tab-llm" onclick="switchTab('llm')">LLM</button>
    </div>

    <!-- System Tab -->
    <div id="tab-sys" class="tab-content active">
        <button class="pop-out-btn" onclick="popOut('sys')">⬈ POP OUT</button>
        <h2>System Resources</h2>

        <div class="chart-grid">
            <div class="chart-card">
                <div class="sub-stat">CPU LOAD</div>
                <div class="big-stat" id="val-cpu">0%</div>
                <div class="progress-bg"><div class="progress-fill" id="bar-cpu"></div></div>
            </div>
            <div class="chart-card">
                <div class="sub-stat">RAM USAGE</div>
                <div class="big-stat" id="val-ram">0%</div>
                <div class="progress-bg"><div class="progress-fill" id="bar-ram"></div></div>
                <div class="sub-stat" id="sub-ram" style="margin-top:4px;">0/0 GB</div>
            </div>
        </div>

        <div class="stat-row" style="margin-top:15px;">
            <span class="stat-label">Disk Usage</span>
            <span class="stat-value" id="val-disk">--%</span>
        </div>
        <div class="progress-bg"><div class="progress-fill" id="bar-disk"></div></div>
    </div>

    <!-- GPU Tab -->
    <div id="tab-gpu" class="tab-content">
        <button class="pop-out-btn" onclick="popOut('gpu')">⬈ POP OUT</button>
        <h2>GPU Status</h2>
        <div id="gpu-container">Loading...</div>
    </div>

    <!-- LLM Tab -->
    <div id="tab-llm" class="tab-content">
        <button class="pop-out-btn" onclick="popOut('llm')">⬈ POP OUT</button>
        <h2>Model Statistics</h2>

        <div class="chart-card" style="margin-bottom:10px;">
            <div class="sub-stat">MODEL STATUS</div>
            <div class="big-stat" id="llm-status" style="font-size:16px;">Unknown</div>
        </div>

        <!-- Timings -->
        <div class="stat-row">
            <span class="stat-label">Load Time</span>
            <span class="stat-value" id="llm-load-time">0 ms</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Total Time</span>
            <span class="stat-value" id="llm-total-time">0.00 s</span>
        </div>

        <div style="height:1px; background:var(--border-color); margin:10px 0;"></div>

        <!-- Token Counts -->
        <div class="chart-grid">
            <div class="chart-card">
                <div class="sub-stat">PROMPT (SPEED)</div>
                <div class="big-stat" id="llm-prompt-tokens">0</div>
                <div class="sub-stat" id="llm-prompt-speed">0 T/s</div>
            </div>
            <div class="chart-card">
                <div class="sub-stat">RESPONSE (SPEED)</div>
                <div class="big-stat" id="llm-eval-tokens">0</div>
                <div class="sub-stat" id="llm-eval-speed">0 T/s</div>
            </div>
        </div>

        <div class="stat-row" style="margin-top:10px;">
            <span class="stat-label">KV Cache Reused</span>
            <span class="stat-value" id="llm-kv-reused">0</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Total Tokens</span>
            <span class="stat-value" id="llm-total-tokens">0</span>
        </div>

        <div class="stat-row" style="margin-top:15px;">
            <span class="stat-label">Active Model</span>
            <span class="stat-value" id="llm-model" style="font-size:10px; word-break:break-all;">--</span>
        </div>
    </div>

    <script>
        let coreUrl = localStorage.getItem('lyrn_core_url');
        let authToken = localStorage.getItem('lyrn_admin_token') || null;
        let intervalId = null;

        // Parse Query Params
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode');
        const defaultTab = urlParams.get('tab') || 'sys';

        if(mode === 'widget') {
            document.body.classList.add('widget-mode');
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

            document.getElementById('tab-' + tabId).classList.add('active');
            const btn = document.getElementById('btn-tab-' + tabId);
            if(btn) btn.classList.add('active');
        }

        // Init Tab
        switchTab(defaultTab);

        function popOut(tab) {
            const title = tab.toUpperCase() + " Widget";
            window.parent.postMessage({
                type: 'OPEN_WIDGET',
                id: 'widget_' + tab,
                name: title,
                file: 'ServerStatus.html?mode=widget&tab=' + tab
            }, '*');
        }

        // Listen for messages
        window.addEventListener('message', (e) => {
            if (e.data.type === 'CORE_URL_CHANGE') {
                coreUrl = e.data.url;
                startMonitoring();
            }
            if (e.data.type === 'THEME_CHANGE') {
                document.body.setAttribute('data-theme', e.data.theme);
            }
            if (e.data.type === 'FONT_CHANGE') {
                document.documentElement.style.setProperty('--font-size-base', e.data.fontSize + 'px');
            }
            if (e.data.type === 'TOKEN_UPDATE') {
                const wasNull = !authToken;
                authToken = e.data.token;
                if(wasNull) startMonitoring();
            }
        });

        function startMonitoring() {
            if(intervalId) clearInterval(intervalId);
            if(!coreUrl || !authToken) return;
            fetchStats();
            intervalId = setInterval(fetchStats, 2000);
        }

        async function fetchStats() {
            if(!authToken) return;
            try {
                // Assuming /health is public or we pass token if needed.
                // Currently /health is public in lyrn_web_v5.py.
                const res = await fetch(coreUrl + '/health', {
                    headers: authToken ? { 'X-Token': authToken } : {}
                });
                if(!res.ok) return;

                const data = await res.json();
                updateUI(data);
            } catch(e) {
                console.error(e);
            }
        }

        function updateUI(data) {
            // System
            document.getElementById('val-cpu').innerText = data.cpu + '%';
            document.getElementById('bar-cpu').style.width = data.cpu + '%';

            document.getElementById('val-ram').innerText = Math.round(data.ram.percent) + '%';
            document.getElementById('bar-ram').style.width = data.ram.percent + '%';
            document.getElementById('sub-ram').innerText = `${data.ram.used_gb.toFixed(1)} / ${data.ram.total_gb.toFixed(1)} GB`;

            document.getElementById('val-disk').innerText = data.disk.percent + '%';
            document.getElementById('bar-disk').style.width = data.disk.percent + '%';

            // GPU
            const gpuContainer = document.getElementById('gpu-container');
            const gpuBtn = document.getElementById('btn-tab-gpu');
            const llmBtn = document.getElementById('btn-tab-llm');

            if(data.gpu && data.gpu.vram_percent !== undefined) {
                gpuBtn.style.display = 'block';
                // Render GPU Stats
                gpuContainer.innerHTML = `
                    <div class="chart-card">
                        <div class="sub-stat">VRAM USAGE</div>
                        <div class="big-stat">${data.gpu.vram_percent.toFixed(1)}%</div>
                        <div class="progress-bg"><div class="progress-fill" style="width:${data.gpu.vram_percent}%"></div></div>
                        <div class="sub-stat" style="margin-top:4px;">${data.gpu.vram_used_gb.toFixed(1)} / ${data.gpu.vram_total_gb.toFixed(1)} GB</div>
                    </div>
                `;
            } else {
                // If no GPU, hide tab unless active
                if(document.getElementById('tab-gpu').classList.contains('active')) {
                     gpuContainer.innerHTML = "<div style='padding:10px; color:var(--text-dim)'>No GPU Detected</div>";
                } else {
                    gpuBtn.style.display = 'none';
                }
            }

            // LLM Stats
            if(data.llm_stats) {
                const s = data.llm_stats;
                // Basic
                document.getElementById('llm-model').innerText = s.model_name || "--";

                // Extended
                document.getElementById('llm-load-time').innerText = (s.load_time || 0).toFixed(0) + " ms";
                document.getElementById('llm-total-time').innerText = (s.total_time || 0).toFixed(2) + " s";

                document.getElementById('llm-prompt-tokens').innerText = s.prompt_tokens || 0;
                document.getElementById('llm-prompt-speed').innerText = (s.prompt_speed || 0).toFixed(1) + " T/s";

                document.getElementById('llm-eval-tokens').innerText = s.eval_tokens || (s.last_tokens || 0);
                // Use eval_speed if available, otherwise tps from legacy
                const evalSpeed = s.eval_speed || s.tps || 0;
                document.getElementById('llm-eval-speed').innerText = evalSpeed.toFixed(1) + " T/s";

                document.getElementById('llm-kv-reused').innerText = s.kv_cache_reused || 0;
                document.getElementById('llm-total-tokens').innerText = s.total_tokens || 0;
            }

            if(data.worker) {
                const s = data.worker.llm_status;
                const statusEl = document.getElementById('llm-status');
                statusEl.innerText = s.toUpperCase();

                if(s === 'busy') statusEl.style.color = '#7c5cff'; // Blue
                else if(s === 'loading') statusEl.style.color = '#ffbb33'; // Yellow
                else if(s === 'error') statusEl.style.color = '#ff4444'; // Red
                else statusEl.style.color = '#00cc66'; // Green
            }
        }

        // Init
        if(coreUrl && authToken) startMonitoring();

    </script>
</body>
</html>
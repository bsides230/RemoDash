<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Code Editor</title>
    <!-- CodeMirror 5 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/eclipse.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/markdown/markdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/shell/shell.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Inter:wght@400;500&display=swap" rel="stylesheet" />

    <style>
        :root {
            --bg-core: #050505;
            --bg-panel: #0a0a0a;
            --brand-color: #10B981;
            --brand-color-dim: rgba(16, 185, 129, 0.1);
            --text-head: #ffffff;
            --text-dim: #666666;
            --border-color: #222222;
        }
        body[data-theme="light"] {
            --bg-core: #ffffff;
            --bg-panel: #f4f6f8;
            --text-head: #111;
            --border-color: #ddd;
        }

        body { margin: 0; padding: 0; background: var(--bg-core); color: var(--text-head); font-family: 'Inter', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* Tabs */
        #tabs-bar {
            height: 36px; background: var(--bg-panel); border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; padding: 0 5px; overflow-x: auto; flex-shrink: 0;
        }
        .tab {
            height: 28px; background: var(--bg-core); border: 1px solid var(--border-color);
            border-radius: 4px 4px 0 0; margin-right: 4px; padding: 0 10px;
            display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;
            font-size: 11px; color: var(--text-dim); border-bottom: none; margin-top: 4px;
        }
        .tab.active { background: var(--bg-core); color: var(--text-head); border-top: 2px solid var(--brand-color); height: 32px; margin-top: 0; }
        .tab-close { width: 14px; height: 14px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .tab-close:hover { background: #ff4444; color: white; }
        .tab.unsaved .tab-title::after { content: ' *'; color: var(--brand-color); }

        /* Toolbar */
        #toolbar {
            height: 32px; background: var(--bg-panel); border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; padding: 0 10px; gap: 10px; flex-shrink: 0;
        }
        .btn {
            background: transparent; border: 1px solid var(--border-color); color: var(--text-head);
            padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; font-family: 'Inter';
        }
        .btn:hover { border-color: var(--brand-color); color: var(--brand-color); }
        .status { margin-left: auto; font-family: 'JetBrains Mono'; font-size: 10px; color: var(--text-dim); }

        /* Editor Area */
        #editor-container {
            flex: 1; position: relative; overflow: hidden;
            /* Fix mobile scroll */
            -webkit-overflow-scrolling: touch;
        }
        .CodeMirror { height: 100%; font-family: 'JetBrains Mono', monospace; font-size: 13px; }

        /* Empty State */
        #empty-state {
            position: absolute; top:0; left:0; width:100%; height:100%;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-dim); font-size: 12px; pointer-events: none;
        }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 100; display: none;
            align-items: center; justify-content: center;
        }
        .modal-box {
            background: var(--bg-panel); border: 1px solid var(--border-color);
            padding: 20px; border-radius: 8px; width: 300px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .modal-title { font-size: 14px; color: var(--text-head); margin-bottom: 15px; font-weight: 600; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 5px; }
        .form-input {
            width: 100%; padding: 8px; background: var(--bg-core);
            border: 1px solid var(--border-color); color: var(--text-head);
            border-radius: 4px; font-family: 'JetBrains Mono'; font-size: 12px;
        }
        .form-checkbox { display: flex; align-items: center; gap: 8px; font-size: 12px; cursor: pointer; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="tabs-bar"></div>
    <div id="toolbar">
        <button class="btn" onclick="createNewFile()">New</button>
        <button class="btn" onclick="saveCurrentFile()">Save</button>
        <button class="btn" onclick="openSettings()">⚙️</button>
        <span class="status" id="status-bar">Ready</span>
    </div>
    <div id="editor-container">
        <div id="empty-state">No files open</div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">Editor Settings</div>

            <div class="form-group">
                <label class="form-label">Default Save Path (Optional)</label>
                <input type="text" id="inp-default-path" class="form-input" placeholder="/home/user/Documents/">
            </div>

            <div class="form-group">
                <label class="form-checkbox">
                    <input type="checkbox" id="chk-always-ask"> Always ask for full path
                </label>
            </div>

            <div class="modal-footer">
                <button class="btn" onclick="closeSettings()">Cancel</button>
                <button class="btn" style="border-color:var(--brand-color); color:var(--brand-color);" onclick="saveSettings()">Save</button>
            </div>
        </div>
    </div>

    <script>
        let coreUrl = localStorage.getItem('lyrn_core_url');
        let authToken = localStorage.getItem('lyrn_admin_token');
        let currentTheme = 'dark';
        let currentFontSize = 13;

        // Settings
        let editorSettings = {
            defaultPath: '',
            alwaysAsk: false
        };

        let files = []; // { path, name, doc, unsaved }
        let activeFileIndex = -1;
        let cm = null;
        let untitledCount = 0;

        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            initCM();
        });

        function loadSettings() {
            const s = localStorage.getItem('lyrn-editor-settings');
            if(s) {
                editorSettings = JSON.parse(s);
            }
        }

        function saveSettings() {
            editorSettings.defaultPath = document.getElementById('inp-default-path').value.trim();
            editorSettings.alwaysAsk = document.getElementById('chk-always-ask').checked;
            localStorage.setItem('lyrn-editor-settings', JSON.stringify(editorSettings));
            closeSettings();
        }

        function openSettings() {
            document.getElementById('inp-default-path').value = editorSettings.defaultPath || '';
            document.getElementById('chk-always-ask').checked = editorSettings.alwaysAsk;
            document.getElementById('settings-modal').style.display = 'flex';
        }

        function closeSettings() {
            document.getElementById('settings-modal').style.display = 'none';
        }

        function createNewFile() {
            untitledCount++;
            const name = `Untitled-${untitledCount}.txt`;

            const doc = CodeMirror.Doc("", "text/plain");
            files.push({
                path: null, // Indicates new file
                name: name,
                doc: doc,
                unsaved: true
            });

            setActiveFile(files.length - 1);
            setStatus('New file created');
        }

        function initCM() {
            cm = CodeMirror(document.getElementById('editor-container'), {
                lineNumbers: true,
                theme: 'dracula',
                mode: 'javascript',
                indentUnit: 4,
                tabSize: 4,
                lineWrapping: false,
                // Better mobile support
                inputStyle: 'contenteditable',
                viewportMargin: Infinity
            });

            // Hide initially
            cm.getWrapperElement().style.display = 'none';

            cm.on('change', () => {
                if(activeFileIndex > -1) {
                    if(!files[activeFileIndex].unsaved) {
                        files[activeFileIndex].unsaved = true;
                        renderTabs();
                    }
                }
            });
        }

        function loadThemeCSS(url) {
            let link = document.getElementById('theme-css');
            if (!link) {
                link = document.createElement('link');
                link.id = 'theme-css';
                link.rel = 'stylesheet';
                document.head.appendChild(link);
            }
            link.href = url;
        }

        function clearThemeCSS() {
            const link = document.getElementById('theme-css');
            if (link) link.remove();
        }

        window.addEventListener('message', (e) => {
            if (e.data.type === 'CORE_URL_CHANGE') coreUrl = e.data.url;
            if (e.data.type === 'TOKEN_UPDATE') authToken = e.data.token;
            if (e.data.type === 'THEME_CHANGE') setTheme(e.data.theme);
            if (e.data.type === 'FONT_CHANGE') setFont(e.data.fontSize);
            if (e.data.type === 'OPEN_FILE') openFile(e.data.path, e.data.name);
            if (e.data.type === 'COLOR_CHANGE') {
                document.documentElement.style.setProperty('--brand-color', e.data.color);
            }
            if (e.data.type === 'THEME_UPDATE') {
                setTheme(e.data.theme);
                document.documentElement.style.setProperty('--brand-color', e.data.brandColor);
                const hex = e.data.brandColor.replace('#', '');
                const r = parseInt(hex.substring(0,2), 16);
                const g = parseInt(hex.substring(2,4), 16);
                const b = parseInt(hex.substring(4,6), 16);
                document.documentElement.style.setProperty('--brand-color-dim', `rgba(${r},${g},${b}, 0.1)`);
                setFont(e.data.fontSize);

                if (e.data.themeCssUrl) loadThemeCSS(e.data.themeCssUrl);
                else clearThemeCSS();
            }
        });

        function setTheme(theme) {
            currentTheme = theme;
            document.body.setAttribute('data-theme', theme);
            if(cm) cm.setOption('theme', theme === 'dark' ? 'dracula' : 'eclipse');
        }

        function setFont(size) {
            currentFontSize = size;
            const el = document.querySelector('.CodeMirror');
            if(el) el.style.fontSize = size + 'px';
            if(cm) cm.refresh();
        }

        async function openFile(path, name) {
            // Check if open
            const existingIdx = files.findIndex(f => f.path === path);
            if(existingIdx > -1) {
                setActiveFile(existingIdx);
                return;
            }

            // Fetch content
            try {
                setStatus('Loading ' + name + '...');
                const res = await fetch(`${coreUrl}/api/files/content?path=${encodeURIComponent(path)}`, {
                    headers: { 'X-Token': authToken }
                });

                if(!res.ok) throw new Error("Failed to read file");

                const data = await res.json();

                // Create Doc
                const mode = getMode(name);
                const doc = CodeMirror.Doc(data.content, mode);

                files.push({
                    path: path,
                    name: name,
                    doc: doc,
                    unsaved: false
                });

                setActiveFile(files.length - 1);
                setStatus('Opened ' + name);

            } catch(e) {
                setStatus('Error: ' + e.message);
                alert("Could not open file: " + e.message);
            }
        }

        function setActiveFile(index) {
            if(index < 0 || index >= files.length) {
                activeFileIndex = -1;
                cm.getWrapperElement().style.display = 'none';
                document.getElementById('empty-state').style.display = 'flex';
                renderTabs();
                setStatus('No file');
                return;
            }

            activeFileIndex = index;
            const file = files[index];

            document.getElementById('empty-state').style.display = 'none';
            cm.getWrapperElement().style.display = 'block';

            cm.swapDoc(file.doc);
            cm.focus();

            renderTabs();
            setStatus(file.path);
        }

        function closeFile(index, e) {
            if(e) e.stopPropagation();
            if(files[index].unsaved) {
                if(!confirm(`Save changes to ${files[index].name}?`)) {
                    // if cancel, maybe return? but if user wants to close without saving...
                    // Standard: Confirm "Save? Yes/No/Cancel"
                    // Simple: "Discard changes?"
                    if(!confirm("Discard unsaved changes?")) return;
                } else {
                    // User said yes to save
                    // We must await save?
                    // Simpler logic: Just "Discard?"
                    // Let's implement active save first.
                }
            }

            files.splice(index, 1);
            if(activeFileIndex >= index) {
                activeFileIndex = Math.max(0, activeFileIndex - 1);
                if(files.length === 0) activeFileIndex = -1;
            }
            setActiveFile(activeFileIndex);
        }

        async function saveCurrentFile() {
            if(activeFileIndex === -1) return;
            const file = files[activeFileIndex];
            const content = file.doc.getValue();

            let targetPath = file.path;

            // Handle New File (Save As)
            if (!targetPath) {
                let initialPath = "";
                let promptMsg = "";

                if (editorSettings.alwaysAsk || !editorSettings.defaultPath) {
                    // Ask for full path
                    promptMsg = "Enter full file path to save:";
                    // Default to something relative if no default path, or just empty
                    initialPath = editorSettings.defaultPath ?
                        (editorSettings.defaultPath.endsWith('/') ? editorSettings.defaultPath + file.name : editorSettings.defaultPath + '/' + file.name)
                        : file.name;
                } else {
                    // Default path exists and not always asking -> ask for filename
                    const base = editorSettings.defaultPath.endsWith('/') ? editorSettings.defaultPath : editorSettings.defaultPath + '/';
                    const filename = prompt("Enter filename:", file.name);
                    if(!filename) return; // Cancelled
                    targetPath = base + filename;
                }

                if (!targetPath) {
                    const userPath = prompt(promptMsg, initialPath);
                    if (!userPath) return; // Cancelled
                    targetPath = userPath;
                }
            }

            setStatus('Saving...');
            try {
                 const res = await fetch(`${coreUrl}/api/files/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Token': authToken },
                    body: JSON.stringify({ path: targetPath, content: content })
                });

                if(res.ok) {
                    file.path = targetPath;
                    file.name = targetPath.split('/').pop().split('\\').pop();
                    file.unsaved = false;

                    // Update Mode based on new extension
                    const newMode = getMode(file.name);
                    cm.setOption("mode", newMode);

                    renderTabs();
                    setStatus(`Saved to ${file.name}`);
                } else {
                    const errText = await res.text();
                    setStatus('Save Failed');
                    alert("Save failed: " + errText);
                }
            } catch(e) {
                setStatus('Error: ' + e.message);
                alert("Error saving: " + e.message);
            }
        }

        function renderTabs() {
            const bar = document.getElementById('tabs-bar');
            bar.innerHTML = '';

            files.forEach((f, i) => {
                const el = document.createElement('div');
                el.className = `tab ${i === activeFileIndex ? 'active' : ''} ${f.unsaved ? 'unsaved' : ''}`;
                el.innerHTML = `
                    <span class="tab-title">${f.name}</span>
                    <div class="tab-close" onclick="closeFile(${i}, event)">✕</div>
                `;
                el.onclick = () => setActiveFile(i);
                bar.appendChild(el);
            });
        }

        function getMode(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const map = {
                'js': 'javascript', 'json': 'javascript',
                'py': 'python',
                'html': 'htmlmixed',
                'css': 'css',
                'md': 'markdown',
                'sh': 'shell', 'bash': 'shell'
            };
            return map[ext] || 'text/plain';
        }

        function setStatus(msg) {
            document.getElementById('status-bar').innerText = msg;
        }

    </script>
</body>
</html>
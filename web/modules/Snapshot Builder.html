<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LYRN Snapshot Builder (Module)</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet" />

  <style>
    /* [ ... CORE VARIABLES ... ] */
    :root {
      --bg-core: #050505;
      --bg-panel: #0a0a0a;
      --bg-input: #050505;
      --brand-purple: #7c5cff;
      --brand-purple-dim: rgba(124, 92, 255, 0.1);
      --text-head: #ffffff;
      --text-body: #b0b0b0;
      --text-dim: #666666;
      --border-color: #222222;
      --input-focus-bg: #111111;
      --success-color: #10B981;
      --error-color: #EF4444;

      --btn-text: #e0e0e0;
      --btn-border: #444444;
      --btn-bg: rgba(255,255,255,0.03);

      /* TYPOGRAPHY */
      --font-size-base: 12px;
    }

    body[data-theme="light"] {
        --bg-core: #eef0f4;
        --bg-panel: #ffffff;
        --bg-input: #ffffff;
        --brand-purple: #6a4ce0;
        --brand-purple-dim: rgba(106, 76, 224, 0.1);
        --text-head: #111111;
        --text-body: #333333;
        --text-dim: #555555;
        --border-color: #d1d5db;
        --input-focus-bg: #f9fafb;
        --btn-text: #333;
        --btn-border: #ccc;
        --btn-bg: rgba(0,0,0,0.03);
    }

    * { box-sizing: border-box; }

    /* --- THEMED SCROLLBARS --- */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; border: 2px solid transparent; background-clip: content-box; }
    ::-webkit-scrollbar-thumb:hover { background-color: var(--brand-purple); }

    body {
      margin: 0; padding: 0;
      background-color: var(--bg-core); color: var(--text-body);
      font-family: 'Inter', system-ui, sans-serif;
      height: 100vh; width: 100vw; overflow: hidden;
      font-size: var(--font-size-base);
    }

    h1, h2, h3 { font-family: 'JetBrains Mono', monospace; color: var(--text-head); margin: 0; }

    /* UI ELEMENTS */
    button {
      font-family: 'JetBrains Mono', monospace;
      font-size: calc(var(--font-size-base) - 1px);
      background: var(--btn-bg);
      border: 1px solid var(--btn-border); color: var(--btn-text); padding: 8px 12px;
      cursor: pointer; text-transform: uppercase; letter-spacing: 0.1em; transition: all 0.2s ease; border-radius: 4px;
      white-space: nowrap;
    }
    button:hover { border-color: var(--brand-purple); color: var(--brand-purple); }
    button.btn-primary { background: var(--brand-purple); color: #ffffff; border-color: var(--brand-purple); font-weight: 600; }
    button.btn-primary:hover { background: #6a4ce0; }
    .btn-group { display: flex; align-items: center; gap: 8px; }
    .btn-square { width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; font-size: calc(var(--font-size-base) + 4px); }
    .btn-delete:hover { border-color: #ff4444; color: #ff4444; }
    .btn-save:hover { border-color: var(--success-color); color: var(--success-color); }

    .hidden { display: none !important; }
    .btn-hidden { display: none !important; }

    /* LAYOUT */
    .rwi-wrapper {
      background: var(--bg-core);
      height: 100vh; width: 100%;
      display: flex; flex-direction: column; position: relative;
    }

    header {
      border-bottom: 1px solid var(--border-color); padding: 12px 16px;
      display: flex; justify-content: space-between; align-items: center;
      background: var(--bg-panel); flex-shrink: 0;
    }

    .meta-label {
        font-family: 'JetBrains Mono';
        font-size: calc(var(--font-size-base) - 2px);
        color: var(--brand-purple); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 4px; display: block;
    }
    .panel-title { font-size: calc(var(--font-size-base) + 2px); font-weight: 600; }
    .version-tag { font-family: 'JetBrains Mono'; font-size: calc(var(--font-size-base) - 2px); border: 1px solid var(--border-color); color: var(--text-dim); padding: 2px 6px; border-radius: 4px; margin-left: 10px; }

    /* GRID & PANELS */
    .main-grid { display: grid; grid-template-columns: 260px 1fr; flex: 1; overflow: hidden; }

    .left-panel { border-right: 1px solid var(--border-color); background: rgba(0,0,0,0.02); overflow-y: auto; display: flex; flex-direction: column; }
    .panel-header { padding: 10px 15px; background: var(--bg-panel); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; flex-shrink: 0; }

    .component-list-scroll { flex: 1; overflow-y: auto; }

    .component-item { display: flex; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--border-color); cursor: pointer; font-family: 'JetBrains Mono', monospace; font-size: calc(var(--font-size-base) - 1px); transition: background 0.2s; }
    .component-item:hover { background: var(--bg-panel); }
    .component-item.selected { background: var(--brand-purple-dim); border-left: 3px solid var(--brand-purple); }
    .component-name { flex: 1; color: var(--text-body); margin: 0 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .panel { overflow-y: auto; height: 100%; position: relative; display: flex; flex-direction: column; }
    .editor-scroll { padding: 20px; flex: 1; overflow-y: auto; }

    /* FORMS */
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; font-size: calc(var(--font-size-base) - 2px); color: var(--text-dim); text-transform: uppercase; margin-bottom: 5px; font-family: 'JetBrains Mono'; }

    input[type="text"], textarea {
      width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); color: var(--text-head); padding: 10px; font-family: 'JetBrains Mono', monospace; font-size: var(--font-size-base); border-radius: 4px;
    }
    input[type="text"]:focus, textarea:focus { border-color: var(--brand-purple); outline: none; background: var(--input-focus-bg); }

    /* SWITCH */
    .switch { position: relative; display: inline-block; width: 26px; height: 14px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--bg-input); transition: .4s; border-radius: 14px; border: 1px solid var(--border-color); }
    .slider:before { position: absolute; content: ""; height: 8px; width: 8px; left: 2px; bottom: 2px; background-color: var(--text-dim); transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--brand-purple); border-color: var(--brand-purple); }
    input:checked + .slider:before { transform: translateX(12px); background-color: #fff; }

    /* FOOTER & TOAST */
    .rwi-footer-bar { padding: 8px 16px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: var(--bg-panel); font-size: calc(var(--font-size-base) - 2px); font-family: 'JetBrains Mono'; color: var(--text-dim); flex-shrink: 0; }

    #rwi-toast {
        position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
        background: var(--bg-panel); border: 1px solid var(--brand-purple);
        color: var(--text-head); padding: 10px 20px; border-radius: 4px;
        font-family: 'JetBrains Mono', monospace; font-size: var(--font-size-base);
        opacity: 0; pointer-events: none; transition: opacity 0.3s;
        box-shadow: 0 10px 30px rgba(0,0,0,0.8); z-index: 11000;
    }
    #rwi-toast.show { opacity: 1; }

    /* MODAL */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(2px);
        z-index: 10000; display: flex; justify-content: center; align-items: center;
    }
    .modal-box {
        background: var(--bg-panel); border: 1px solid var(--border-color);
        box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 90%; max-width: 800px; height: 80%;
        display: flex; flex-direction: column; border-radius: 8px; animation: slideUp 0.3s ease-out;
    }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
    .modal-body { flex: 1; padding: 0; overflow: hidden; position: relative; }
    .modal-body textarea { width: 100%; height: 100%; background: var(--bg-core); color: var(--text-body); font-family: 'JetBrains Mono', monospace; font-size: var(--font-size-base); border: none; padding: 20px; resize: none; outline: none; }
    .modal-text-display { padding: 30px; overflow-y: auto; font-size: calc(var(--font-size-base) + 2px); line-height: 1.6; color: var(--text-body); }
    .modal-footer { padding: 15px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 10px; }

    /* RESPONSIVE */
    @media (max-width: 768px) {
        .main-grid { grid-template-columns: 1fr; grid-template-rows: 200px 1fr; }
        .left-panel { border-right: none; border-bottom: 1px solid var(--border-color); }
        header { flex-direction: column; gap: 10px; text-align: center; height: auto; }
        header .btn-group { flex-wrap: wrap; justify-content: center; }
    }
  </style>
</head>
<body>

  <div class="rwi-wrapper">
    <header>
        <div>
            <div class="meta-label">LYRN SYSTEM MODULE</div>
            <h1 class="panel-title">Snapshot Builder <span class="version-tag">v2.0</span></h1>
        </div>
        <div class="btn-group">
            <input type="file" id="sns-file-input" style="display: none;" accept=".sns" onchange="rwiLoadSNS(this)">
            <button onclick="document.getElementById('sns-file-input').click()">Load</button>
            <button onclick="rwiSaveSNS()">Save</button>
            <button onclick="rwiPreview()">View</button>
            <button class="btn-primary" id="rebuild-btn" onclick="rwiBuild()">Rebuild</button>
            <button class="btn-icon btn-square" onclick="rwiShowHelp()" title="Help">?</button>
        </div>
    </header>

    <div class="main-grid">
        <div class="panel left-panel">
            <div class="panel-header">
                <h3 class="panel-title">Components</h3>
                <div style="display: flex; gap: 5px;">
                    <button class="btn-square" onclick="moveSelected(-1)" title="Move Up">‚Üë</button>
                    <button class="btn-square" onclick="moveSelected(1)" title="Move Down">‚Üì</button>
                    <button class="btn-square" onclick="rwiAddNew()" title="Add New">+</button>
                </div>
            </div>
            <div id="components-list" class="component-list-scroll"></div>
        </div>

        <div class="panel">
            <div class="panel-header">
                <h3 class="panel-title" id="editor-title">Editor</h3>
                <div class="btn-group">
                    <button class="btn-square btn-delete" id="delete-btn" style="display: none;" onclick="rwiDelete()" title="Delete">üóëÔ∏è</button>
                    <button class="btn-square btn-save" id="save-btn" onclick="rwiSave()" title="Save">üíæ</button>
                </div>
            </div>
            <div id="editor-container" class="editor-scroll">
                <p style="color: var(--text-dim); padding: 20px; text-align: center;">Select a component to edit.</p>
            </div>
        </div>
    </div>

    <div class="rwi-footer-bar">
         <span>RWI SYSTEM // V2.0 // MODULE RUNTIME</span>
         <span>READY</span>
    </div>
  </div>

  <div id="rwi-toast">Operation Successful</div>

  <div id="preview-modal" class="modal-overlay hidden">
    <div class="modal-box">
        <div class="modal-header">
            <h3 class="panel-title" id="modal-title">Final RWI Prompt</h3>
            <button onclick="closeModal()" style="border:none; background:transparent; font-size:16px; color:var(--text-dim);">‚úï</button>
        </div>
        <div class="modal-body">
            <textarea id="modal-content" readonly></textarea>
            <div id="modal-html-content" class="modal-text-display hidden"></div>
        </div>
        <div class="modal-footer">
             <button id="copy-btn" onclick="copyModalContent()">Copy to Clipboard</button>
             <button id="download-btn" class="btn-primary btn-hidden" onclick="rwiDownloadSNS()">Download .SNS File</button>
        </div>
    </div>
  </div>

  <script>
    let CORE_URL = "http://localhost:8000";
    let authToken = localStorage.getItem('lyrn_admin_token') || null;

    document.addEventListener('DOMContentLoaded', () => {
        // Core URL Init
        const stored = localStorage.getItem('lyrn_core_url');
        if(stored) CORE_URL = stored.replace(/\/$/, "");

        if(authToken) initRWIBuilder();

        // Theme Sync & URL Update
        window.addEventListener('message', (event) => {
            if (event.data.type === 'THEME_CHANGE') {
                document.body.setAttribute('data-theme', event.data.theme);
            }
            if (event.data.type === 'FONT_CHANGE') {
                document.documentElement.style.setProperty('--font-size-base', event.data.fontSize + 'px');
            }
            if (event.data.type === 'TOKEN_UPDATE') {
                const wasNull = !authToken;
                authToken = event.data.token;
                if(wasNull) initRWIBuilder();
            }
            if (event.data.type === 'CORE_URL_CHANGE') {
                CORE_URL = event.data.url.replace(/\/$/, "");
                if(authToken) initRWIBuilder();
            }
        });
    });

    /* =========================================
       RWI BUILDER LOGIC
       ========================================= */
    async function initRWIBuilder() {
        if (!document.getElementById('components-list')) return;
        if (!authToken) return;

        let components = [
            { name: "rwi", pinned: true, active: true, order: 0, config: { begin_bracket: "###RWI_INSTRUCTIONS_START###", end_bracket: "###RWI_INSTRUCTIONS_END###", rwi_text: "Relational Web Index header." }, content: "" },
            { name: "system_instructions", pinned: true, active: true, order: 1, config: { begin_bracket: "###SYSTEM_INSTRUCTIONS_START###", end_bracket: "###SYSTEM_INSTRUCTIONS_END###", rwi_text: "Core system instructions." }, content: `This model operates as part of the LYRN cognitive architecture...` }
        ];

        // Fetch from API
        try {
            const res = await fetch(CORE_URL + '/api/snapshot', {
                headers: authToken ? { 'X-Token': authToken } : {}
            });
            if(res.ok) {
                const data = await res.json();
                if(Array.isArray(data) && data.length > 0) {
                    components = data;
                }
            }
        } catch(e) {
            console.warn("Failed to fetch snapshot from API, using defaults.", e);
        }

        let selectedComponent = null;

        function updateRWITableOfContents() {
            const rwiComp = components.find(c => c.name === 'rwi');
            if(!rwiComp) return;
            let txt = "RWI Header: active components list...\n\n";
            components.forEach(c => {
                if (c.name !== 'rwi' && c.active) {
                    txt += `- ${c.name}: [${c.config.begin_bracket}]...[${c.config.end_bracket}] ${c.config.rwi_text}\n\n`;
                }
            });
            rwiComp.content = txt;
            if(selectedComponent === 'rwi') {
                 const editContent = document.getElementById('edit-content');
                 if(editContent) editContent.value = txt;
            }
        }
        updateRWITableOfContents();

        function renderList() {
            const listEl = document.getElementById('components-list');
            listEl.innerHTML = '';
            components.sort((a, b) => {
                if (!!a.pinned !== !!b.pinned) return a.pinned ? -1 : 1;
                return (a.order || 0) - (b.order || 0);
            });

            components.forEach((comp, index) => {
                comp.order = index;
                const item = document.createElement('div');
                item.className = `component-item ${selectedComponent === comp.name ? 'selected' : ''}`;

                let pinStatusHtml = comp.name === 'rwi'
                    ? `<span style="font-size:calc(var(--font-size-base) - 2px); color:var(--brand-purple); margin-right:8px; font-weight:bold;">SYS</span>`
                    : `<button class="pin-btn" style="background:none; border:none; padding:0; margin-right:5px; font-size:var(--font-size-base); color:var(--text-dim);">${comp.pinned ? 'üìå' : 'üìç'}</button>`;

                let toggleHtml = comp.name !== 'rwi'
                    ? `<label class="switch component-toggle" onclick="event.stopPropagation()"><input type="checkbox" ${comp.active ? 'checked' : ''}><span class="slider"></span></label>`
                    : '';

                item.innerHTML = `${pinStatusHtml}<span class="component-name">${comp.name}</span>${toggleHtml}`;
                item.onclick = () => selectComponent(comp.name);

                if (comp.name !== 'rwi') {
                    const pinBtn = item.querySelector('.pin-btn');
                    if(pinBtn) pinBtn.onclick = (e) => { e.stopPropagation(); togglePin(comp.name); };
                    const chk = item.querySelector('input');
                    if(chk) chk.onchange = (e) => { toggleActive(comp.name, e.target.checked); };
                }
                listEl.appendChild(item);
            });
        }

        window.moveSelected = (direction) => {
            if (!selectedComponent) { showToast("No component selected", true); return; }
            const index = components.findIndex(c => c.name === selectedComponent);
            if (index === -1) return;
            const currentComp = components[index];
            if (currentComp.pinned) { showToast("Pinned items cannot be reordered", true); return; }
            const targetIndex = index + direction;
            if (targetIndex < 0 || targetIndex >= components.length) return;
            const targetComp = components[targetIndex];
            if (targetComp.pinned) { showToast("Cannot move into pinned section", true); return; }

            const tempOrder = currentComp.order;
            currentComp.order = targetComp.order;
            targetComp.order = tempOrder;
            renderList();
        };

        function togglePin(name) {
            const c = components.find(x => x.name === name);
            if (c) { c.pinned = !c.pinned; renderList(); }
        }

        function toggleActive(name, val) {
            const c = components.find(x => x.name === name);
            if (c) { c.active = val; updateRWITableOfContents(); showToast(val ? `${name} Activated` : `${name} Deactivated`); }
        }

        function selectComponent(name) {
            selectedComponent = name;
            renderList();
            const titleEl = document.getElementById('editor-title');
            const container = document.getElementById('editor-container');
            titleEl.innerText = name === '_NEW_' ? 'New Component' : `Editing: ${name}`;

            if (name === '_NEW_') {
                container.innerHTML = `
                    <div class="form-group"><label>Component Name</label><input type="text" id="edit-name" placeholder="e.g., memory_buffer"></div>
                    <div class="form-group"><label>Begin Bracket</label><input type="text" id="edit-begin" value="###_START###"></div>
                    <div class="form-group"><label>End Bracket</label><input type="text" id="edit-end" value="###_END###"></div>
                    <div class="form-group"><label>RWI Instructions</label><textarea id="edit-rwi" placeholder="Description..."></textarea></div>
                    <div class="form-group"><label>Content</label><textarea id="edit-content"></textarea></div>
                `;
            } else {
                const c = components.find(x => x.name === name);
                if (!c) return;
                container.innerHTML = `
                    <div class="form-group"><label>Begin Bracket</label><input type="text" id="edit-begin" value="${escapeHtml(c.config.begin_bracket)}"></div>
                    <div class="form-group"><label>End Bracket</label><input type="text" id="edit-end" value="${escapeHtml(c.config.end_bracket)}"></div>
                    <div class="form-group"><label>RWI Instructions</label><textarea id="edit-rwi">${escapeHtml(c.config.rwi_text)}</textarea></div>
                    <div class="form-group"><label>Main Content</label><textarea id="edit-content" style="height: 300px;">${escapeHtml(c.content)}</textarea></div>
                `;
            }
            const delBtn = document.getElementById('delete-btn');
            if (delBtn) delBtn.style.display = (name === '_NEW_' || name === 'rwi') ? 'none' : 'block';
        }

        window.rwiAddNew = () => selectComponent('_NEW_');

        // NEW: SAVE to API
        window.rwiSave = async () => {
            const isNew = selectedComponent === '_NEW_';
            let name = selectedComponent;
            if (isNew) {
                name = document.getElementById('edit-name').value.trim();
                if (!name || components.find(c => c.name === name)) { showToast("Invalid Name", true); return; }
                components.push({
                    name: name, pinned: false, active: true, order: components.length,
                    config: {
                        begin_bracket: document.getElementById('edit-begin').value,
                        end_bracket: document.getElementById('edit-end').value,
                        rwi_text: document.getElementById('edit-rwi').value
                    },
                    content: document.getElementById('edit-content').value
                });
                selectedComponent = name;
            } else {
                const c = components.find(x => x.name === name);
                if (c) {
                    c.config.begin_bracket = document.getElementById('edit-begin').value;
                    c.config.end_bracket = document.getElementById('edit-end').value;
                    c.config.rwi_text = document.getElementById('edit-rwi').value;
                    c.content = document.getElementById('edit-content').value;
                }
            }
            updateRWITableOfContents();

            // API CALL
            try {
                const res = await fetch(CORE_URL + '/api/snapshot', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Token': authToken || ''
                    },
                    body: JSON.stringify(components)
                });
                if(res.ok) showToast("Snapshot Saved to Core");
                else showToast("Failed to Save", true);
            } catch(e) { showToast("Connection Error", true); }

            renderList();
            if (isNew) selectComponent(name);
        };

        window.rwiDelete = () => {
            if (!selectedComponent || selectedComponent === '_NEW_') return;
            if (confirm(`Delete ${selectedComponent}?`)) {
                components = components.filter(c => c.name !== selectedComponent);
                selectedComponent = null;
                document.getElementById('editor-container').innerHTML = '<p style="padding:20px; color:var(--text-dim)">Select a component.</p>';
                updateRWITableOfContents();

                // Trigger Save to persist deletion
                window.rwiSave();

                renderList();
                showToast("Deleted");
            }
        };

        // NEW: REBUILD Trigger
        window.rwiBuild = async () => {
            const btn = document.getElementById('rebuild-btn');
            if (!btn) return;
            const origText = btn.innerText;
            btn.innerText = "Building...";

            try {
                // Ensure saved first? Maybe not needed if user clicked save. But safe to assume current state.
                await fetch(CORE_URL + '/api/snapshot', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Token': authToken || ''
                    },
                    body: JSON.stringify(components)
                });

                const res = await fetch(CORE_URL + '/api/snapshot/rebuild', {
                    method: 'POST',
                    headers: authToken ? { 'X-Token': authToken } : {}
                });
                if(res.ok) showToast("Rebuild Trigger Sent");
                else showToast("Rebuild Failed", true);
            } catch(e) {
                showToast("Connection Error", true);
            }

            setTimeout(() => { btn.innerText = origText; }, 800);
        };

        window.rwiSaveSNS = () => { window.rwiPreview(); document.getElementById('modal-title').innerText = "Review Snapshot (.SNS)"; document.getElementById('download-btn').classList.remove('btn-hidden'); };

        window.rwiDownloadSNS = () => {
             let filename = prompt("Enter filename:", "lyrn_snapshot");
            if (!filename) return;
            if (!filename.endsWith('.sns')) filename += '.sns';
            const blob = new Blob([JSON.stringify(components, null, 2)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast("Snapshot Downloaded");
            closeModal();
        }

        window.rwiLoadSNS = (input) => {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    components = JSON.parse(e.target.result);
                    selectedComponent = 'rwi';
                    updateRWITableOfContents(); renderList(); selectComponent('rwi');
                    showToast("Snapshot Loaded");
                } catch (err) { showToast("Error Parsing File", true); }
            };
            reader.readAsText(file); input.value = '';
        };

        window.rwiPreview = () => {
            let text = "";
            components.filter(c => c.active).forEach(c => { text += `${c.config.begin_bracket}\n${c.content}\n${c.config.end_bracket}\n\n`; });
            document.getElementById('modal-title').innerText = "Final RWI Prompt";
            document.getElementById('modal-content').value = text;
            document.getElementById('modal-content').classList.remove('hidden');
            document.getElementById('modal-html-content').classList.add('hidden');
            document.getElementById('copy-btn').classList.remove('btn-hidden');
            document.getElementById('download-btn').classList.add('btn-hidden');
            document.getElementById('preview-modal').classList.remove('hidden');
        };

        window.rwiShowHelp = () => {
            document.getElementById('modal-title').innerText = "RWI Builder Guide";
            document.getElementById('modal-html-content').innerHTML = `<p><strong>RWI Builder v2.0 Guide</strong></p><ul><li>Edit, reorder, and toggle components.</li><li>Export .sns files for the dashboard.</li><li>Files are JSON compatible for LYRN v5.</li></ul>`;
            document.getElementById('modal-content').classList.add('hidden');
            document.getElementById('modal-html-content').classList.remove('hidden');
            document.getElementById('copy-btn').classList.add('btn-hidden');
            document.getElementById('download-btn').classList.add('btn-hidden');
            document.getElementById('preview-modal').classList.remove('hidden');
        };

        window.closeModal = () => document.getElementById('preview-modal').classList.add('hidden');
        window.copyModalContent = () => { document.getElementById('modal-content').select(); document.execCommand('copy'); showToast("Copied!"); }

        function showToast(msg, error=false) {
            const t = document.getElementById('rwi-toast');
            if(!t) return;
            t.innerText = msg;
            t.style.borderColor = error ? 'var(--error-color)' : 'var(--brand-purple)';
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
        }

        // Initial Select
        selectComponent("rwi");
    }
  </script>
</body>
</html>
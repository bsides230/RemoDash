<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LYRN Settings (Module)</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet" />

  <style>
    /* [ ... CORE VARIABLES ... ] */
    :root {
      --bg-core: #050505;
      --bg-panel: #0a0a0a;
      --bg-input: #050505;
      --brand-purple: #7c5cff;
      --brand-purple-dim: rgba(124, 92, 255, 0.1);
      --text-head: #ffffff;
      --text-body: #b0b0b0;
      --text-dim: #666666;
      --border-color: #222222;
      --input-focus-bg: #111111;
      --success-color: #10B981;
      --error-color: #EF4444;

      --btn-text: #e0e0e0;
      --btn-border: #444444;
      --btn-bg: rgba(255,255,255,0.03);

      /* TYPOGRAPHY */
      --font-size-base: 12px;
    }

    body[data-theme="light"] {
        --bg-core: #eef0f4;
        --bg-panel: #ffffff;
        --bg-input: #ffffff;
        --brand-purple: #6a4ce0;
        --brand-purple-dim: rgba(106, 76, 224, 0.1);
        --text-head: #111111;
        --text-body: #333333;
        --text-dim: #555555;
        --border-color: #d1d5db;
        --input-focus-bg: #f9fafb;
        --btn-text: #333;
        --btn-border: #ccc;
        --btn-bg: rgba(0,0,0,0.03);
    }

    * { box-sizing: border-box; }

    /* --- THEMED SCROLLBARS --- */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; border: 2px solid transparent; background-clip: content-box; }
    ::-webkit-scrollbar-thumb:hover { background-color: var(--brand-purple); }

    body {
      margin: 0; padding: 0;
      background-color: var(--bg-core); color: var(--text-body);
      font-family: 'Inter', system-ui, sans-serif;
      height: 100vh; width: 100vw; overflow: hidden;
      font-size: var(--font-size-base);
    }

    h1, h2, h3, h4 { font-family: 'JetBrains Mono', monospace; color: var(--text-head); margin: 0; }

    /* UI ELEMENTS */
    button {
      font-family: 'JetBrains Mono', monospace;
      font-size: calc(var(--font-size-base) - 1px);
      background: var(--btn-bg);
      border: 1px solid var(--btn-border); color: var(--btn-text); padding: 8px 12px;
      cursor: pointer; text-transform: uppercase; letter-spacing: 0.1em; transition: all 0.2s ease; border-radius: 4px;
      white-space: nowrap; display: flex; align-items: center; justify-content: center; gap: 6px;
    }
    button:hover { border-color: var(--brand-purple); color: var(--brand-purple); }
    button.btn-primary { background: var(--brand-purple); color: #ffffff; border-color: var(--brand-purple); font-weight: 600; }
    button.btn-primary:hover { background: #6a4ce0; }
    .btn-group { display: flex; align-items: center; gap: 8px; }
    .btn-square { width: 32px; height: 32px; padding: 0; font-size: calc(var(--font-size-base) + 4px); }
    .btn-delete:hover { border-color: #ff4444; color: #ff4444; }
    .btn-save:hover { border-color: var(--success-color); color: var(--success-color); }

    .hidden { display: none !important; }

    /* LAYOUT */
    .app-wrapper {
      background: var(--bg-core);
      height: 100vh; width: 100%;
      display: flex; flex-direction: column; position: relative;
    }

    header {
      border-bottom: 1px solid var(--border-color); padding: 12px 16px;
      display: flex; justify-content: space-between; align-items: center;
      background: var(--bg-panel); flex-shrink: 0;
    }

    .meta-label { font-family: 'JetBrains Mono'; font-size: calc(var(--font-size-base) - 2px); color: var(--brand-purple); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 4px; display: block; }
    .panel-title { font-size: calc(var(--font-size-base) + 2px); font-weight: 600; }

    .content-area { flex: 1; overflow-y: auto; padding: 20px; }

    /* SETTINGS GRID */
    .settings-grid {
        display: grid; grid-template-columns: 1fr; gap: 20px;
        max-width: 800px; margin: 0 auto;
    }

    .settings-card {
        background: var(--bg-panel); border: 1px solid var(--border-color);
        border-radius: 8px; overflow: hidden;
    }

    .card-header {
        padding: 15px 20px; border-bottom: 1px solid var(--border-color);
        display: flex; justify-content: space-between; align-items: center;
    }

    .card-body { padding: 20px; }

    /* API MAP TABLE */
    .api-table {
        width: 100%; border-collapse: collapse; margin-bottom: 15px;
    }
    .api-table th {
        text-align: left; font-family: 'JetBrains Mono'; font-size: calc(var(--font-size-base) - 1px);
        color: var(--text-dim); padding: 8px 10px; border-bottom: 1px solid var(--border-color);
        text-transform: uppercase;
    }
    .api-table td {
        padding: 10px; border-bottom: 1px solid var(--border-color);
    }
    .api-table tr:last-child td { border-bottom: none; }

    input[type="text"] {
      width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); color: var(--text-head); padding: 8px; font-family: 'JetBrains Mono', monospace; font-size: var(--font-size-base); border-radius: 4px;
    }
    input[type="text"]:focus { border-color: var(--brand-purple); outline: none; background: var(--input-focus-bg); }

    /* TOAST */
    #toast {
        position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
        background: var(--bg-panel); border: 1px solid var(--brand-purple);
        color: var(--text-head); padding: 10px 20px; border-radius: 4px;
        font-family: 'JetBrains Mono', monospace; font-size: var(--font-size-base);
        opacity: 0; pointer-events: none; transition: opacity 0.3s;
        box-shadow: 0 10px 30px rgba(0,0,0,0.8); z-index: 11000;
    }
    #toast.show { opacity: 1; }

    /* FOOTER */
    .footer-bar { padding: 8px 16px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: var(--bg-panel); font-size: calc(var(--font-size-base) - 2px); font-family: 'JetBrains Mono'; color: var(--text-dim); flex-shrink: 0; }

  </style>
</head>
<body>

  <div class="app-wrapper">
    <header>
        <div>
            <div class="meta-label">LYRN SYSTEM MODULE</div>
            <h1 class="panel-title">System Settings</h1>
        </div>
        <div class="btn-group">
            <input type="file" id="file-input" style="display: none;" accept=".json" onchange="handleFileLoad(this)">
            <button onclick="document.getElementById('file-input').click()">Import Config</button>
            <button onclick="exportConfig()">Export Config</button>
        </div>
    </header>

    <div class="content-area">
        <div class="settings-grid">

            <div class="settings-card">
                <div class="card-header">
                    <h3 class="panel-title">API Endpoints</h3>
                    <button class="btn-primary" onclick="addApiRow()">+ Add Endpoint</button>
                </div>
                <div class="card-body">
                    <p style="color: var(--text-dim); margin-bottom: 20px;">
                        Configure the backend API URLs for each LYRN module. These settings are saved locally in your browser.
                    </p>

                    <table class="api-table" id="api-table">
                        <thead>
                            <tr>
                                <th style="width: 30%;">Module Name</th>
                                <th style="width: 55%;">API URL</th>
                                <th style="width: 15%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="api-list">
                            <!-- Rows generated by JS -->
                        </tbody>
                    </table>

                    <div style="display: flex; justify-content: flex-end; margin-top: 10px;">
                        <button class="btn-save" onclick="saveToLocalStorage()">Save Changes</button>
                    </div>
                </div>
            </div>

            <div class="settings-card">
                <div class="card-header">
                    <h3 class="panel-title">System Configuration (Server)</h3>
                    <button class="btn-save" onclick="saveSystemConfig()">Save to Server</button>
                </div>
                <div class="card-body">
                    <p style="color: var(--text-dim); margin-bottom: 10px;">
                        Directly edit the server-side configuration (settings.json). Use with caution.
                    </p>
                    <textarea id="sys-config-editor" style="width:100%; height:300px; font-family:'JetBrains Mono'; font-size:12px; background:var(--bg-input); color:var(--text-head); border:1px solid var(--border-color); border-radius:4px; padding:10px; resize:vertical;"></textarea>
                </div>
            </div>

        </div>
    </div>

    <div class="footer-bar">
         <span>SYSTEM SETTINGS MANAGER // V1.0</span>
         <span id="status-bar">READY</span>
    </div>
  </div>

  <div id="toast">Operation Successful</div>

  <script>
    /* =========================================
       GLOBAL STATE
       ========================================= */
    let CORE_URL = "http://localhost:8000";
    let authToken = localStorage.getItem('lyrn_admin_token') || null;

    let API_MAP = {
        "Chat": "http://localhost:8000/api/chat",
        "Job Manager": "http://localhost:8000/api",
        "RWI Builder": "http://localhost:8000/api"
    };

    document.addEventListener('DOMContentLoaded', () => {
        // Init logic
        loadFromLocalStorage();
        renderApiList();
        if(authToken) fetchSystemConfig();

        // Theme Sync
        window.addEventListener('message', (event) => {
            if (event.data.type === 'THEME_CHANGE') {
                document.body.setAttribute('data-theme', event.data.theme);
            }
            if (event.data.type === 'FONT_CHANGE') {
                document.documentElement.style.setProperty('--font-size-base', event.data.fontSize + 'px');
            }
            if (event.data.type === 'TOKEN_UPDATE') {
                const wasNull = !authToken;
                authToken = event.data.token;
                if(wasNull) fetchSystemConfig();
            }
            if (event.data.type === 'CORE_URL_CHANGE') {
                 CORE_URL = event.data.url.replace(/\/$/, "");
                 if(authToken) fetchSystemConfig();
            }
        });
    });

    function showToast(msg, error=false) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.style.borderColor = error ? 'var(--error-color)' : 'var(--brand-purple)';
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    }

    /* =========================================
       DATA MANAGEMENT
       ========================================= */
    function loadFromLocalStorage() {
        try {
            const stored = localStorage.getItem('lyrn_api_config');
            if (stored) {
                API_MAP = JSON.parse(stored);
            }
        } catch (e) {
            console.error("Failed to load settings", e);
        }
    }

    function saveToLocalStorage() {
        // Gather data from UI
        const rows = document.querySelectorAll('#api-list tr');
        const newMap = {};

        rows.forEach(row => {
            const nameInput = row.querySelector('.input-name');
            const urlInput = row.querySelector('.input-url');
            if (nameInput && urlInput && nameInput.value.trim()) {
                newMap[nameInput.value.trim()] = urlInput.value.trim();
            }
        });

        API_MAP = newMap;
        localStorage.setItem('lyrn_api_config', JSON.stringify(API_MAP));
        showToast("Settings Saved");
        renderApiList(); // Refresh to clean up empty rows if any
    }

    function exportConfig() {
        const content = JSON.stringify(API_MAP, null, 2);
        const blob = new Blob([content], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = "lyrn_api_config.json";
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast("Config Exported");
    }

    function handleFileLoad(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const json = JSON.parse(e.target.result);
                API_MAP = json;
                saveToLocalStorage(); // Auto-save on import
                renderApiList();
                showToast("Config Imported");
            } catch (err) { showToast("Invalid JSON", true); }
        };
        reader.readAsText(file);
        input.value = '';
    }

    /* =========================================
       UI RENDERING
       ========================================= */
    function renderApiList() {
        const list = document.getElementById('api-list');
        list.innerHTML = '';

        Object.keys(API_MAP).sort().forEach(name => {
            addApiRow(name, API_MAP[name]);
        });
    }

    function addApiRow(name="", url="") {
        const list = document.getElementById('api-list');
        const row = document.createElement('tr');

        row.innerHTML = `
            <td><input type="text" class="input-name" value="${escapeHtml(name)}" placeholder="Module Name"></td>
            <td><input type="text" class="input-url" value="${escapeHtml(url)}" placeholder="http://localhost:..."></td>
            <td>
                <button class="btn-square btn-delete" onclick="this.closest('tr').remove()" title="Delete">üóëÔ∏è</button>
            </td>
        `;
        list.appendChild(row);
    }

    function escapeHtml(text) {
        if (!text) return "";
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
    }

    /* =========================================
       SYSTEM CONFIG (SERVER SIDE)
       ========================================= */
    async function fetchSystemConfig() {
        if(!authToken) return;
        try {
            const res = await fetch(CORE_URL + '/api/config', {
                headers: authToken ? { 'X-Token': authToken } : {}
            });
            if(!res.ok) throw new Error("Config fetch failed");
            const json = await res.json();
            document.getElementById('sys-config-editor').value = JSON.stringify(json, null, 2);
        } catch(e) {
            console.error(e);
            // showToast("Failed to load System Config", true);
            document.getElementById('sys-config-editor').value = "// Failed to load config from " + CORE_URL;
        }
    }

    async function saveSystemConfig() {
        try {
            const text = document.getElementById('sys-config-editor').value;
            const json = JSON.parse(text);

            const res = await fetch(CORE_URL + '/api/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Token': authToken || ''
                },
                body: JSON.stringify(json)
            });
            if(!res.ok) throw new Error("Save failed");
            showToast("System Config Saved");
        } catch(e) {
            showToast("Error: " + e.message, true);
        }
    }

  </script>
</body>
</html>
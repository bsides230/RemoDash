<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>VLC Control</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet" />
    <style>
        :root {
            --bg-core: #050505;
            --bg-panel: #0a0a0a;
            --bg-card: #111;
            --brand-purple: #7c5cff;
            --text-head: #ffffff;
            --text-body: #b0b0b0;
            --text-dim: #666666;
            --border-color: #222222;
            --success-color: #10B981;
            --error-color: #ff4444;
        }

        body[data-theme="light"] {
            --bg-core: #eef0f4;
            --bg-panel: #ffffff;
            --bg-card: #f8f9fa;
            --brand-purple: #6a4ce0;
            --text-head: #111111;
            --text-body: #333333;
            --text-dim: #555555;
            --border-color: #d1d5db;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-core);
            color: var(--text-body);
            font-family: 'Inter', sans-serif;
            margin: 0; padding: 20px;
            font-size: 13px;
            height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        .header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; flex-shrink: 0;
        }
        .header h2 { margin: 0; font-size: 18px; color: var(--text-head); font-weight: 600; }

        .btn {
            background: var(--bg-panel); border: 1px solid var(--border-color);
            color: var(--text-head); padding: 8px 16px; border-radius: 6px;
            cursor: pointer; font-size: 12px; font-weight: 500;
            transition: all 0.2s; display: flex; align-items: center; gap: 6px;
            justify-content: center;
        }
        .btn:hover { border-color: var(--text-dim); background: var(--bg-card); }
        .btn.primary { background: var(--brand-purple); border-color: var(--brand-purple); color: #fff; }
        .btn.primary:hover { opacity: 0.9; }
        .btn.danger { color: var(--error-color); border-color: rgba(255,68,68,0.3); }
        .btn.danger:hover { background: var(--error-color); color: #fff; }

        .btn:active { transform: translateY(1px); }

        .container {
            flex: 1; display: flex; flex-direction: column; gap: 20px; overflow-y: auto;
        }

        .card {
            background: var(--bg-panel); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 20px; display: flex; flex-direction: column; gap: 15px;
        }

        .section-title { font-weight: 600; color: var(--text-head); font-size: 14px; margin-bottom: 5px; }

        .input-group { display: flex; gap: 10px; }
        .form-input {
            flex: 1; padding: 10px; background: var(--bg-core); border: 1px solid var(--border-color);
            color: var(--text-head); border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 12px;
        }
        .form-input:focus { border-color: var(--brand-purple); outline: none; }

        .control-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
        }

        .control-btn {
            height: 50px; font-size: 16px;
        }

        .status-display {
            background: #000; color: var(--brand-purple);
            font-family: 'JetBrains Mono', monospace; padding: 15px;
            border-radius: 4px; border: 1px solid var(--border-color);
            min-height: 60px; display: flex; align-items: center; justify-content: center;
            text-align: center;
        }

        .status-playing { color: var(--success-color); }
        .status-stopped { color: var(--text-dim); }

    </style>
</head>
<body>

    <div class="header">
        <h2>VLC Control</h2>
        <button class="btn danger" onclick="killVLC()" title="Force Kill VLC">‚ò† Kill VLC</button>
    </div>

    <div class="container">

        <!-- Launcher Section -->
        <div class="card">
            <div class="section-title">Launch Playlist</div>
            <div style="font-size:11px; color:var(--text-dim); margin-top:-10px; margin-bottom:5px;">
                Enter a folder path containing media files. VLC will launch in Fullscreen, Shuffle, and Loop mode.
            </div>
            <div class="input-group">
                <input type="text" id="inp-path" class="form-input" placeholder="/path/to/media/folder">
                <button class="btn primary" onclick="launchVLC()">Launch VLC</button>
            </div>
        </div>

        <!-- Controls Section -->
        <div class="card" style="flex:1;">
            <div class="section-title">Playback Control</div>

            <div id="status-box" class="status-display status-stopped">
                -- Not Connected --
            </div>

            <div class="control-grid">
                <button class="btn control-btn" onclick="sendCmd('prev')">‚èÆ Prev</button>
                <button class="btn control-btn" onclick="sendCmd('pause')">‚èØ Play/Pause</button>
                <button class="btn control-btn" onclick="sendCmd('next')">‚è≠ Next</button>

                <button class="btn control-btn" onclick="sendCmd('stop')">‚èπ Stop</button>
                <button class="btn control-btn" onclick="sendCmd('fullscreen')">‚õ∂ Fullscreen</button>
                <button class="btn control-btn" onclick="sendCmd('play')">‚ñ∂ Play</button>
            </div>

             <div class="control-grid" style="margin-top:10px;">
                 <button class="btn" onclick="sendCmd('vol_down')">üîâ Vol -</button>
                 <div style="display:flex;align-items:center;justify-content:center;color:var(--text-dim);font-size:10px;">VOLUME</div>
                 <button class="btn" onclick="sendCmd('vol_up')">üîä Vol +</button>
             </div>
        </div>

    </div>

    <script>
        let coreUrl = localStorage.getItem('lyrn_core_url');
        let authToken = localStorage.getItem('lyrn_admin_token');
        let pollInterval = null;

        window.addEventListener('message', (e) => {
            if (e.data.type === 'CORE_URL_CHANGE') coreUrl = e.data.url;
            if (e.data.type === 'TOKEN_UPDATE') authToken = e.data.token;
            if (e.data.type === 'THEME_CHANGE') document.body.setAttribute('data-theme', e.data.theme);
        });

        document.addEventListener('DOMContentLoaded', () => {
            // Start polling status
            pollStatus();
            pollInterval = setInterval(pollStatus, 2000);
        });

        async function launchVLC() {
            const path = document.getElementById('inp-path').value.trim();
            if(!path) {
                alert("Please enter a folder path.");
                return;
            }

            try {
                const res = await fetch(`${coreUrl}/api/vlc/launch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Token': authToken },
                    body: JSON.stringify({ path: path })
                });

                if(res.ok) {
                    // Success
                    document.getElementById('status-box').innerText = "Launching...";
                } else {
                    alert("Launch Failed: " + await res.text());
                }
            } catch(e) {
                alert("Error: " + e.message);
            }
        }

        async function sendCmd(cmd) {
            try {
                const res = await fetch(`${coreUrl}/api/vlc/command`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Token': authToken },
                    body: JSON.stringify({ command: cmd })
                });
                if(!res.ok) {
                    console.error("Command failed", await res.text());
                } else {
                    // Poll immediately after command
                    setTimeout(pollStatus, 200);
                }
            } catch(e) { console.error(e); }
        }

        async function killVLC() {
            if(!confirm("Force Kill VLC process?")) return;
            try {
                await fetch(`${coreUrl}/api/vlc/kill`, {
                    method: 'POST',
                    headers: { 'X-Token': authToken }
                });
            } catch(e) { alert(e); }
        }

        async function pollStatus() {
            if(!coreUrl || !authToken) return;
            try {
                const res = await fetch(`${coreUrl}/api/vlc/status`, {
                     headers: { 'X-Token': authToken }
                });
                if(res.ok) {
                    const data = await res.json();
                    updateStatusUI(data);
                }
            } catch(e) {
                document.getElementById('status-box').innerText = "Connection Error";
                document.getElementById('status-box').className = "status-display status-stopped";
            }
        }

        function updateStatusUI(data) {
            const box = document.getElementById('status-box');

            if (data.state && data.state.includes("Error")) {
                box.innerText = "VLC Not Running / Not Connected";
                box.className = "status-display status-stopped";
                return;
            }

            let text = "";
            let statusClass = "status-display";

            // State: playing, stopped, paused
            const state = (data.state || "").toLowerCase();
            if (state.includes("playing")) {
                statusClass += " status-playing";
                text += "‚ñ∂ PLAYING\n";
            } else if (state.includes("paused")) {
                statusClass += " status-stopped";
                text += "‚è∏ PAUSED\n";
            } else {
                statusClass += " status-stopped";
                text += "‚èπ STOPPED\n";
            }

            if (data.title) {
                text += data.title;
            } else {
                text += "(No Title)";
            }

            box.innerText = text;
            box.className = statusClass;
        }

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>File Explorer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet" />
    <style>
        :root {
            --bg-core: #050505;
            --bg-panel: #0a0a0a;
            --bg-sidebar: #080808;
            --bg-hover: #111;
            --brand-purple: #7c5cff;
            --text-head: #ffffff;
            --text-body: #b0b0b0;
            --text-dim: #666666;
            --border-color: #222222;
        }

        body[data-theme="light"] {
            --bg-core: #eef0f4;
            --bg-panel: #ffffff;
            --bg-sidebar: #f4f6f8;
            --bg-hover: #f0f0f0;
            --brand-purple: #6a4ce0;
            --text-head: #111111;
            --text-body: #333333;
            --text-dim: #555555;
            --border-color: #d1d5db;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-core);
            color: var(--text-body);
            font-family: 'Inter', sans-serif;
            margin: 0; padding: 0;
            font-size: 13px;
            display: flex; height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        #sidebar {
            width: 200px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column;
            padding: 10px; flex-shrink: 0;
            overflow-y: auto;
        }

        .sidebar-section { margin-bottom: 20px; }
        .sidebar-title {
            font-size: 10px; font-weight: 600; color: var(--text-dim);
            text-transform: uppercase; margin-bottom: 8px; padding-left: 8px;
            letter-spacing: 0.5px;
        }
        .sidebar-item {
            display: flex; align-items: center; gap: 8px;
            padding: 6px 8px; border-radius: 6px;
            cursor: pointer; color: var(--text-body);
            transition: all 0.2s; font-size: 12px;
        }
        .sidebar-item:hover { background: var(--bg-hover); color: var(--text-head); }
        .sidebar-item.active { background: rgba(124, 92, 255, 0.1); color: var(--brand-purple); }

        /* Main Content */
        #main-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

        /* Tabs Bar */
        #tabs-bar {
            height: 36px; background: var(--bg-panel);
            border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center;
            padding: 0 4px; overflow-x: auto;
        }
        .tab {
            height: 28px;
            background: var(--bg-core); border: 1px solid var(--border-color);
            border-radius: 4px; padding: 0 10px;
            display: flex; align-items: center; gap: 8px;
            margin-right: 4px; cursor: pointer;
            min-width: 120px; max-width: 200px;
            font-size: 11px; user-select: none;
        }
        .tab.active {
            background: var(--bg-hover); border-color: var(--brand-purple);
            color: var(--text-head);
        }
        .tab-title { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tab-close { opacity: 0.5; width: 14px; height: 14px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .tab-close:hover { background: #ff4444; color: white; opacity: 1; }

        .tab-popout { opacity: 0.5; font-size: 10px; }
        .tab-popout:hover { opacity: 1; color: var(--brand-purple); }

        .new-tab-btn {
            width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: var(--text-dim); font-size: 16px;
        }
        .new-tab-btn:hover { color: var(--text-head); }

        /* Toolbar */
        .toolbar {
            padding: 8px; background: var(--bg-panel);
            border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; gap: 8px;
            flex-wrap: wrap; /* Allow wrapping on small screens */
        }
        .nav-btn { background: transparent; border: none; color: var(--text-head); cursor: pointer; font-size: 14px; padding: 4px; border-radius: 4px; flex-shrink: 0; }
        .nav-btn:hover { background: var(--bg-hover); }
        .path-bar {
            flex: 1; display: flex; align-items: center; background: var(--bg-core);
            border: 1px solid var(--border-color); border-radius: 4px; padding: 4px 8px;
            min-width: 200px;
        }
        .path-input {
            width: 100%; background: transparent; border: none; color: var(--text-head);
            font-family: 'JetBrains Mono'; font-size: 12px; outline: none;
        }
        .tool-btn {
            background: var(--bg-panel); border: 1px solid var(--border-color);
            color: var(--text-dim); padding: 4px 8px; border-radius: 4px;
            font-size: 11px; cursor: pointer; display: flex; align-items: center; gap: 4px;
            white-space: nowrap; flex-shrink: 0;
        }
        .tool-btn:hover { border-color: var(--text-dim); color: var(--text-head); }
        .tool-btn.primary { color: var(--brand-purple); border-color: var(--brand-purple); }

        /* File List Container */
        #file-scroll-container {
             flex: 1; overflow: auto; background: var(--bg-core);
             display: flex; flex-direction: column;
        }

        .file-header {
            display: grid; grid-template-columns: 40px 30px 2fr 100px 150px;
            padding: 8px 0; border-bottom: 1px solid var(--border-color);
            font-size: 11px; color: var(--text-dim); font-weight: 600; text-transform: uppercase;
            position: sticky; top: 0; background: var(--bg-core); z-index: 1;
            min-width: 100%; /* Ensure it fills container */
        }
        .header-col { padding: 0 8px; cursor: pointer; }
        .header-col:hover { color: var(--text-head); }

        #file-view { flex: 1; }

        .file-row {
            display: grid; grid-template-columns: 40px 30px 2fr 100px 150px;
            padding: 6px 0; border-bottom: 1px solid transparent;
            align-items: center; cursor: default;
            font-size: 12px;
            min-width: 100%;
        }
        .file-row:hover { background: var(--bg-hover); }
        .file-row.selected { background: rgba(124, 92, 255, 0.1); border-bottom-color: rgba(124, 92, 255, 0.2); }

        .col-check { display: flex; justify-content: center; }
        .col-icon { font-size: 16px; text-align: center; }
        .col-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; }
        .col-size { font-family: 'JetBrains Mono'; font-size: 11px; color: var(--text-dim); }
        .col-date { font-family: 'JetBrains Mono'; font-size: 11px; color: var(--text-dim); }

        /* Checkbox */
        input[type="checkbox"] { cursor: pointer; }

        /* Modals */
        .modal-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(2px);
            z-index: 200; display: none; align-items: center; justify-content: center;
        }
        .modal {
            background: var(--bg-panel); border: 1px solid var(--border-color);
            padding: 20px; border-radius: 8px; width: 300px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .modal h3 { margin-top: 0; color: var(--text-head); font-family: 'JetBrains Mono'; font-size: 14px; }
        .modal input {
            width: 100%; padding: 8px; background: var(--bg-core);
            border: 1px solid var(--border-color); color: var(--text-head);
            margin: 10px 0; font-family: 'JetBrains Mono'; outline: none;
        }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }

        /* Mobile Styles */
        @media (max-width: 768px) {
            #sidebar {
                position: fixed; top: 0; left: 0; height: 100%; z-index: 100;
                transform: translateX(-100%); transition: transform 0.3s;
                box-shadow: 2px 0 10px rgba(0,0,0,0.5);
            }
            #sidebar.open { transform: translateX(0); }

            #sidebar-overlay {
                display: none; position: fixed; top:0; left:0; width:100%; height:100%;
                background: rgba(0,0,0,0.5); z-index: 99;
            }
            #sidebar-overlay.visible { display: block; }

            #mobile-menu-btn { display: flex !important; margin-right: 10px; }

            /* Mobile Horizontal Scroll */
            /* Enforce min-width to trigger scroll */
            .file-header, .file-row {
                min-width: 600px;
            }

            /* Ensure columns are visible */
            .col-size, .col-date { display: block; }

            /* Full width path bar on its own line if needed, or flex grow */
            .path-bar { min-width: 0; flex-basis: 100%; order: 10; margin-top: 5px; }
        }

        #mobile-menu-btn {
            display: none; width: 32px; height: 32px; align-items: center; justify-content: center;
            background: transparent; border: 1px solid var(--border-color); border-radius: 4px;
            color: var(--text-head); cursor: pointer;
        }

        /* Bottom padding for mobile drag handle */
        #file-view { padding-bottom: 40px; }

        /* Upload Progress */
        #upload-status {
            position: fixed; bottom: 20px; right: 20px; background: var(--bg-panel);
            border: 1px solid var(--border-color); padding: 10px; border-radius: 6px;
            display: none; flex-direction: column; gap: 5px; z-index: 200;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); width: 200px;
        }
        #upload-bar-bg { width: 100%; height: 4px; background: var(--bg-core); border-radius: 2px; overflow: hidden; }
        #upload-bar-fill { width: 0%; height: 100%; background: var(--brand-purple); transition: width 0.2s; }

    </style>
</head>
<body>
    <div id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div id="sidebar">
        <div class="sidebar-section">
            <div class="sidebar-title">Favorites</div>
            <div id="fav-list"></div>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-title">Drives</div>
            <div id="drive-list"></div>
        </div>
    </div>

    <div id="main-area">
        <div id="tabs-bar">
            <!-- Tabs injected here -->
            <div class="new-tab-btn" onclick="addNewTab()">+</div>
        </div>

        <div class="toolbar">
            <button id="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>
            <button class="nav-btn" onclick="navBack()">‚óÄ</button>
            <button class="nav-btn" onclick="navUp()">‚ñ≤</button>
            <button class="nav-btn" onclick="refreshTab()">‚Üª</button>

            <div class="path-bar">
                <input type="text" class="path-input" id="current-path" onkeydown="if(event.key==='Enter') navigate(this.value)">
            </div>

            <button class="tool-btn" onclick="triggerUpload()">Upload</button>
            <button class="tool-btn" onclick="triggerDownload()">Download</button>
            <div style="width:1px; height:16px; background:var(--border-color); margin:0 4px;"></div>
            <button class="tool-btn" onclick="togglePinCurrent()">üìå Pin</button>
            <div style="width:1px; height:16px; background:var(--border-color); margin:0 4px;"></div>
            <button class="tool-btn" onclick="copySelection()">Copy</button>
            <button class="tool-btn" onclick="addToGit()">+ Git</button>
            <button class="tool-btn" onclick="pasteSelection()">Paste</button>
            <div style="width:1px; height:16px; background:var(--border-color); margin:0 4px;"></div>
            <button class="tool-btn" onclick="showCreateModal('file')">+ File</button>
            <button class="tool-btn" onclick="showCreateModal('folder')">+ Folder</button>
            <button class="tool-btn" id="btn-create-shortcut" onclick="showShortcutModal()" style="display:none;">Create Shortcut</button>
            <button class="tool-btn" onclick="deleteSelection()" style="color:#ff5555;">Delete</button>
            <div style="width:1px; height:16px; background:var(--border-color); margin:0 4px;"></div>
            <button class="tool-btn" onclick="cutSelection()">Cut</button>
        </div>

        <div id="file-scroll-container">
             <div class="file-header">
                <div class="header-col col-check"><input type="checkbox" id="check-all" onchange="toggleSelectAll(this.checked)"></div>
                <div class="header-col"></div>
                <div class="header-col" onclick="setSort('name')">Name</div>
                <div class="header-col" onclick="setSort('size')">Size</div>
                <div class="header-col" onclick="setSort('date')">Date</div>
            </div>

            <div id="file-view">
                <!-- Files injected here -->
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="upload-status">
        <div style="font-size:11px; color:var(--text-head); display:flex; justify-content:space-between;">
            <span>Uploading...</span>
            <span id="upload-percent">0%</span>
        </div>
        <div id="upload-bar-bg"><div id="upload-bar-fill"></div></div>
    </div>
    <input type="file" id="inp-upload" multiple style="display:none;" onchange="handleUpload(this.files)">

    <div id="modal-create" class="modal-overlay">
        <div class="modal">
            <h3 id="modal-title">Create New</h3>
            <input type="text" id="inp-create-name" placeholder="Name...">
            <div class="modal-footer">
                <button class="tool-btn" onclick="closeModal('modal-create')">Cancel</button>
                <button class="tool-btn primary" id="btn-create-confirm">Create</button>
            </div>
        </div>
    </div>

    <div id="modal-shortcut" class="modal-overlay">
        <div class="modal">
            <h3>Create Shortcut</h3>
            <label style="font-size:10px; color:var(--text-dim); text-transform:uppercase;">Name</label>
            <input type="text" id="sc-name" placeholder="Shortcut Name">

            <label style="font-size:10px; color:var(--text-dim); text-transform:uppercase;">Target</label>
            <input type="text" id="sc-path" readonly style="color:var(--text-dim);">

            <div style="display:flex; align-items:center; gap:10px; margin-top:10px;">
                <label style="display:flex; align-items:center; gap:5px; font-size:11px; cursor:pointer;">
                    <input type="checkbox" id="sc-confirm" checked> Confirm
                </label>
                <label style="display:flex; align-items:center; gap:5px; font-size:11px; cursor:pointer;">
                    <input type="checkbox" id="sc-capture" checked> Capture Output
                </label>
            </div>

            <label style="font-size:10px; color:var(--text-dim); text-transform:uppercase; margin-top:10px; display:block;">Run Mode</label>
            <select id="sc-mode" style="width:100%; padding:8px; margin-top:5px; background:var(--bg-core); color:var(--text-head); border:1px solid var(--border-color); font-family:'JetBrains Mono'; outline:none;">
                <option value="terminal">Run in Terminal</option>
                <option value="output">Show Output</option>
            </select>

            <div class="modal-footer">
                <button class="tool-btn" onclick="closeModal('modal-shortcut')">Cancel</button>
                <button class="tool-btn primary" onclick="saveShortcut()">Save</button>
            </div>
        </div>
    </div>

    <script>
        let coreUrl = localStorage.getItem('lyrn_core_url');
        let authToken = localStorage.getItem('lyrn_admin_token');

        // State
        let tabs = [];
        let activeTabIndex = -1;
        let sortMode = "name";
        let sortOrder = "asc";

        document.addEventListener('DOMContentLoaded', () => {
            initSidebar();
            const urlParams = new URLSearchParams(window.location.search);
            const initialPath = urlParams.get('path') || '/';
            addNewTab(initialPath);
        });

        window.addEventListener('message', (e) => {
            if (e.data.type === 'CORE_URL_CHANGE') coreUrl = e.data.url;
            if (e.data.type === 'TOKEN_UPDATE') { authToken = e.data.token; refreshTab(); initSidebar(); }
            if (e.data.type === 'THEME_CHANGE') document.body.setAttribute('data-theme', e.data.theme);
            if (e.data.type === 'COLOR_CHANGE') {
                document.documentElement.style.setProperty('--brand-purple', e.data.color);
            }
        });

        async function initSidebar() {
            const favs = [
                { name: "My Computer", path: "computer://" },
                { name: "Root", path: "/" },
                { name: "Home", path: "/home" }
            ];

            // Load User Favorites
            let userFavs = [];
            try {
                const s = localStorage.getItem('lyrn_favs');
                if(s) userFavs = JSON.parse(s);
            } catch(e) {}

            const favList = document.getElementById('fav-list');
            favList.innerHTML = '';

            // Render Defaults
            favs.forEach(f => {
                const el = document.createElement('div');
                el.className = 'sidebar-item';
                el.innerHTML = `<span>‚òÖ</span><span>${f.name}</span>`;
                el.onclick = () => { navigate(f.path); toggleSidebar(); };
                favList.appendChild(el);
            });

            // Render User Favorites
             userFavs.forEach(f => {
                 const el = document.createElement('div');
                 el.className = 'sidebar-item';
                 el.innerHTML = `<span>üìå</span><span>${f.name}</span> <span style="margin-left:auto; opacity:0.5; font-size:10px;" onclick="removeFavorite('${f.path.replace(/\\/g, '\\\\').replace(/'/g, "\\'")}', event)">‚úï</span>`;
                 el.onclick = (e) => {
                     if(e.target.innerText === '‚úï') return;
                     navigate(f.path); toggleSidebar();
                 };
                 favList.appendChild(el);
            });

            if(!coreUrl || !authToken) return;
            try {
                const res = await fetch(`${coreUrl}/api/sysinfo`, { headers: { 'X-Token': authToken } });
                const data = await res.json();
                const driveList = document.getElementById('drive-list');
                driveList.innerHTML = '';
                if (data.partitions) {
                    data.partitions.forEach(p => {
                        const el = document.createElement('div');
                        el.className = 'sidebar-item';
                        let icon = 'üíæ';
                        if (p.opts && p.opts.includes('ro')) icon = 'üîí';
                        el.innerHTML = `<span>${icon}</span><span>${p.mountpoint}</span>`;
                        el.title = `Device: ${p.device} | Used: ${Math.round(p.percent)}%`;
                        el.onclick = () => { navigate(p.mountpoint); toggleSidebar(); };
                        driveList.appendChild(el);
                    });
                }
            } catch(e) { console.error("Sidebar load failed", e); }
        }

        function addNewTab(path = "/") {
            const tab = {
                id: Date.now() + Math.random(),
                path: path,
                items: [],
                selected: new Set()
            };
            tabs.push(tab);
            setActiveTab(tabs.length - 1);
        }

        function closeTab(index, e) {
            if(e) e.stopPropagation();
            if(tabs.length === 1) return;
            tabs.splice(index, 1);
            if(activeTabIndex >= index) {
                activeTabIndex = Math.max(0, activeTabIndex - 1);
            }
            renderTabs();
            loadFilesForTab(activeTabIndex);
        }

        function setActiveTab(index) {
            if(index < 0 || index >= tabs.length) return;
            activeTabIndex = index;
            renderTabs();
            loadFilesForTab(activeTabIndex);
        }

        function renderTabs() {
            const bar = document.getElementById('tabs-bar');
            const existing = bar.querySelectorAll('.tab');
            existing.forEach(e => e.remove());

            tabs.forEach((t, i) => {
                const el = document.createElement('div');
                el.className = `tab ${i === activeTabIndex ? 'active' : ''}`;
                const parts = t.path.split(/[/\\]/).filter(Boolean);
                const title = parts.length > 0 ? parts[parts.length-1] : (t.path === '/' ? 'Root' : t.path);
                el.innerHTML = `
                    <div class="tab-title">${title}</div>
                    <div class="tab-popout" title="Pop Out Window" onclick="popOutTab(${i}, event)">‚á±</div>
                    <div class="tab-close" onclick="closeTab(${i}, event)">‚úï</div>
                `;
                el.onclick = () => setActiveTab(i);
                bar.insertBefore(el, bar.lastElementChild);
            });
        }

        function popOutTab(index, e) {
            if(e) e.stopPropagation();
            const t = tabs[index];
            window.parent.postMessage({
                type: 'OPEN_CHILD_WINDOW',
                parentId: 'mod_file_explorer',
                id: 'explorer_' + Date.now(),
                title: 'Explorer',
                url: `FileExplorer.html?path=${encodeURIComponent(t.path)}`,
                canMinimize: true
            }, '*');
        }

        async function loadFilesForTab(index) {
            const tab = tabs[index];
            if(!tab) return;
            document.getElementById('current-path').value = tab.path;
            const view = document.getElementById('file-view');
            view.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-dim)">Loading...</div>';

            if(!coreUrl || !authToken) return;

            try {
                if (tab.path === 'computer://') {
                     // Load drives
                     const res = await fetch(`${coreUrl}/api/sysinfo`, { headers: { 'X-Token': authToken } });
                     const data = await res.json();
                     tab.items = (data.partitions || []).map(p => ({
                         name: p.mountpoint || p.device,
                         path: p.mountpoint || p.device,
                         type: 'dir',
                         size: 0,
                         mtime: Date.now()/1000
                     }));
                     tab.selected.clear();
                     renderFileList(tab);
                     renderTabs();
                     return;
                }

                const res = await fetch(`${coreUrl}/api/files/list?path=${encodeURIComponent(tab.path)}&sort_by=${sortMode}&order=${sortOrder}`, {
                    headers: { 'X-Token': authToken }
                });
                if(!res.ok) throw new Error(res.statusText);

                const data = await res.json();
                tab.path = data.path;
                tab.items = data.items;
                tab.selected.clear();

                document.getElementById('current-path').value = tab.path;
                renderFileList(tab);
                renderTabs();
            } catch(e) {
                view.innerHTML = `<div style="padding:20px; text-align:center; color:#ff5555">Error: ${e.message}</div>`;
            }
        }

        function renderFileList(tab) {
            const view = document.getElementById('file-view');
            view.innerHTML = '';
            document.getElementById('check-all').checked = false;

            if(tab.items.length === 0) {
                 view.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-dim)">Empty Directory</div>';
                 return;
            }

            tab.items.forEach(item => {
                const row = document.createElement('div');
                row.className = 'file-row';
                if(tab.selected.has(item.path)) row.classList.add('selected');

                const icon = item.type === 'dir' ? 'üìÅ' : getFileIcon(item.name);
                const size = item.type === 'dir' ? '--' : formatSize(item.size);
                const date = new Date(item.mtime * 1000).toLocaleDateString();

                row.innerHTML = `
                    <div class="col-check"><input type="checkbox" ${tab.selected.has(item.path) ? 'checked' : ''}></div>
                    <div class="col-icon">${icon}</div>
                    <div class="col-name">${item.name}</div>
                    <div class="col-size">${size}</div>
                    <div class="col-date">${date}</div>
                `;

                row.onclick = (e) => {
                    toggleItemSelect(item.path, e);
                };
                row.ondblclick = () => handleItemDblClick(item);
                view.appendChild(row);
            });
        }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('sidebar-overlay');
            if(sb.classList.contains('open')) {
                sb.classList.remove('open');
                ov.classList.remove('visible');
            } else {
                sb.classList.add('open');
                ov.classList.add('visible');
            }
        }

        function toggleItemSelect(path, e) {
            const tab = tabs[activeTabIndex];
            if(tab.selected.has(path)) tab.selected.delete(path);
            else tab.selected.add(path);
            updateToolbar();
            renderFileList(tab);
        }

        function toggleSelectAll(checked) {
            const tab = tabs[activeTabIndex];
            if(checked) tab.items.forEach(i => tab.selected.add(i.path));
            else tab.selected.clear();
            updateToolbar();
            renderFileList(tab);
        }

        function updateToolbar() {
            const tab = tabs[activeTabIndex];
            const btn = document.getElementById('btn-create-shortcut');
            const runnable = ['.py', '.js', '.bat', '.ps1', '.sh', '.exe'];

            if(tab.selected.size === 1) {
                const path = Array.from(tab.selected)[0];
                const ext = '.' + path.split('.').pop().toLowerCase();
                if(runnable.includes(ext)) {
                    btn.style.display = 'flex';
                    return;
                }
            }
            btn.style.display = 'none';
        }

        function navigate(path) {
            const tab = tabs[activeTabIndex];
            tab.path = path;
            loadFilesForTab(activeTabIndex);
        }

        function navUp() {
            const tab = tabs[activeTabIndex];
            let p = tab.path;
            if(p.endsWith('/') && p.length > 1) p = p.slice(0, -1);
            if(p.endsWith('\\') && p.length > 1) p = p.slice(0, -1);
            const sep = p.includes('\\') ? '\\' : '/';
            const idx = p.lastIndexOf(sep);
            if(idx === -1) return;
            const newPath = p.substring(0, idx) || (p.includes('\\') ? p.substring(0, idx+1) : '/');
            if(newPath === tab.path) return;
            navigate(newPath);
        }

        function refreshTab() { loadFilesForTab(activeTabIndex); }
        function navBack() { /* TODO */ }

        function handleItemDblClick(item) {
            if(item.type === 'dir') navigate(item.path);
            else openFile(item);
        }

        function openFile(item) {
            const ext = item.name.split('.').pop().toLowerCase();
            const images = ['png','jpg','jpeg','gif','webp','bmp','svg'];
            const media = ['mp4','mov','mkv','webm','mp3','wav','ogg','m4v'];
            const pdf = ['pdf'];

            if(images.includes(ext) || media.includes(ext) || pdf.includes(ext)) {
                 // Use MediaViewer (generic viewer)
                 window.parent.postMessage({
                     type: 'OPEN_CHILD_WINDOW',
                     id: 'view_' + Date.now(),
                     title: item.name,
                     url: `MediaViewer.html?src=${encodeURIComponent(item.path)}`,
                     canMinimize: false
                 }, '*');
            } else {
                // Code Editor
                window.parent.postMessage({
                    type: 'OPEN_FILE',
                    path: item.path,
                    name: item.name
                }, '*');
            }
        }

        async function addToGit() {
             const tab = tabs[activeTabIndex];
             // If selection contains folders, add them. Else add current path.
             let pathsToAdd = [];

             if(tab.selected.size > 0) {
                 for(const p of tab.selected) {
                     const item = tab.items.find(i => i.path === p);
                     if(item && item.type === 'dir') pathsToAdd.push(p);
                 }
             }

             if(pathsToAdd.length === 0) {
                 // Add current directory
                 pathsToAdd.push(tab.path);
             }

             if(!confirm(`Add ${pathsToAdd.length} repositories to Git Manager?`)) return;

             for(const p of pathsToAdd) {
                  await fetch(`${coreUrl}/api/git/repos`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-Token': authToken },
                        body: JSON.stringify({ path: p })
                  });
             }
             alert("Repositories added.");
        }

        // --- Clipboard (Copy/Cut/Paste/Delete) ---
        function copySelection() {
            const tab = tabs[activeTabIndex];
            if(tab.selected.size === 0) return;
            const items = Array.from(tab.selected);
            localStorage.setItem('lyrn_clipboard', JSON.stringify({ action: 'copy', items: items }));
            alert(`Copied ${items.length} items.`);
        }

        function cutSelection() {
            const tab = tabs[activeTabIndex];
            if(tab.selected.size === 0) return;
            const items = Array.from(tab.selected);
            localStorage.setItem('lyrn_clipboard', JSON.stringify({ action: 'cut', items: items }));
            alert(`Cut ${items.length} items.`);
        }

        async function pasteSelection() {
            const clipRaw = localStorage.getItem('lyrn_clipboard');
            if(!clipRaw) return;
            const clip = JSON.parse(clipRaw);
            const dest = tabs[activeTabIndex].path;
            if(!confirm(`Paste ${clip.items.length} items to ${dest}?`)) return;

            for (const srcPath of clip.items) {
                const parts = srcPath.split(/[/\\]/);
                const name = parts[parts.length-1];
                const sep = dest.includes('\\') ? '\\' : '/';
                const destPath = dest.endsWith(sep) ? dest + name : dest + sep + name;

                if (clip.action === 'cut') {
                    await fetch(`${coreUrl}/api/files/rename`, {
                        method: 'POST',
                        headers: {'Content-Type':'application/json', 'X-Token':authToken},
                        body: JSON.stringify({ path: srcPath, new_path: destPath })
                    });
                }
            }
            if(clip.action === 'cut') localStorage.removeItem('lyrn_clipboard');
            reload();
        }

        async function deleteSelection() {
             const tab = tabs[activeTabIndex];
             if(tab.selected.size === 0) return;
             if(!confirm(`Delete ${tab.selected.size} items?`)) return;
             for(const path of tab.selected) {
                 await fetch(`${coreUrl}/api/files/delete`, {
                    method: 'POST',
                    headers: {'Content-Type':'application/json', 'X-Token':authToken},
                    body: JSON.stringify({ path: path })
                });
             }
             reload();
        }

        // --- Creation/Modals ---
        let createType = 'file';
        function showCreateModal(type) {
            createType = type;
            document.getElementById('modal-title').innerText = type === 'file' ? 'New File' : 'New Folder';
            document.getElementById('inp-create-name').value = '';
            document.getElementById('modal-create').style.display = 'flex';
            document.getElementById('inp-create-name').focus();
        }
        document.getElementById('btn-create-confirm').onclick = async () => {
             const name = document.getElementById('inp-create-name').value;
             if(!name) return;
             const tab = tabs[activeTabIndex];
             const sep = tab.path.includes('\\') ? '\\' : '/';
             const parent = tab.path.endsWith(sep) ? tab.path : tab.path + sep;
             const newPath = parent + name;
             const endpoint = createType === 'file' ? '/api/files/save' : '/api/files/create_folder';
             const body = createType === 'file' ? { path: newPath, content: "" } : { path: newPath };
             try {
                const res = await fetch(`${coreUrl}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Token': authToken },
                    body: JSON.stringify(body)
                });
                if(res.ok) { closeModal('modal-create'); reload(); } else alert("Failed to create");
             } catch(e) { alert(e); }
        };
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function reload() { refreshTab(); }
        function setSort(mode) {
             if(sortMode === mode) sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
             else { sortMode = mode; sortOrder = 'asc'; }
             refreshTab();
        }

        // --- Shortcuts ---
        function showShortcutModal() {
            const tab = tabs[activeTabIndex];
            if(tab.selected.size !== 1) return;
            const path = Array.from(tab.selected)[0];
            const filename = path.split(/[/\\]/).pop();
            const name = filename.split('.').slice(0, -1).join('.') || filename;
            document.getElementById('sc-name').value = name;
            document.getElementById('sc-path').value = path;
            document.getElementById('sc-mode').value = 'terminal';
            document.getElementById('modal-shortcut').style.display = 'flex';
        }
        async function saveShortcut() {
            const tab = tabs[activeTabIndex];
            const path = document.getElementById('sc-path').value;
            const cwd = tab.path;
            const payload = {
                name: document.getElementById('sc-name').value,
                path: path,
                type: 'auto',
                cwd: cwd,
                confirm: document.getElementById('sc-confirm').checked,
                capture_output: document.getElementById('sc-capture').checked,
                run_mode: document.getElementById('sc-mode').value
            };
            try {
                const res = await fetch(`${coreUrl}/api/shortcuts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Token': authToken },
                    body: JSON.stringify(payload)
                });
                if(res.ok) { closeModal('modal-shortcut'); alert("Shortcut created!"); } else alert("Error: " + await res.text());
            } catch(e) { alert("Error: " + e.message); }
        }

        function togglePinCurrent() {
             const tab = tabs[activeTabIndex];
             const path = tab.path;
             const name = path.split(/[/\\]/).pop() || path;

             let userFavs = [];
             try {
                const s = localStorage.getItem('lyrn_favs');
                if(s) userFavs = JSON.parse(s);
             } catch(e) {}

             // Check if exists
             if(userFavs.find(f => f.path === path)) {
                 alert("Already pinned.");
                 return;
             }

             userFavs.push({ name: name, path: path });
             localStorage.setItem('lyrn_favs', JSON.stringify(userFavs));
             initSidebar();
        }

        function removeFavorite(path, e) {
            if(e) e.stopPropagation();
             let userFavs = [];
             try {
                const s = localStorage.getItem('lyrn_favs');
                if(s) userFavs = JSON.parse(s);
             } catch(e) {}

             userFavs = userFavs.filter(f => f.path !== path);
             localStorage.setItem('lyrn_favs', JSON.stringify(userFavs));
             initSidebar();
        }

        // --- Utils ---
        function formatSize(bytes) {
            if(bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function getFileIcon(name) {
            const ext = name.split('.').pop().toLowerCase();
            if(['png','jpg','jpeg','gif'].includes(ext)) return 'üñºÔ∏è';
            if(['mp3','wav','ogg'].includes(ext)) return 'üéµ';
            if(['mp4','mov','mkv'].includes(ext)) return 'üé¨';
            if(['zip','rar','7z','tar','gz'].includes(ext)) return 'üì¶';
            if(['py','js','html','css','json','cpp','c','java'].includes(ext)) return 'üìú';
            return 'üìÑ';
        }

        // --- Upload/Download ---
        function triggerUpload() { document.getElementById('inp-upload').click(); }
        function handleUpload(files) {
            if(files.length === 0) return;
            const tab = tabs[activeTabIndex];
            const formData = new FormData();
            formData.append('path', tab.path);
            for(let i=0; i<files.length; i++) formData.append('files', files[i]);
            const ui = document.getElementById('upload-status');
            const bar = document.getElementById('upload-bar-fill');
            const txt = document.getElementById('upload-percent');
            ui.style.display = 'flex'; bar.style.width = '0%'; txt.innerText = '0%';
            const xhr = new XMLHttpRequest();
            xhr.open('POST', `${coreUrl}/api/files/upload`, true);
            if(authToken) xhr.setRequestHeader('X-Token', authToken);
            xhr.upload.onprogress = (e) => {
                if(e.lengthComputable) {
                    const percent = (e.loaded / e.total) * 100;
                    bar.style.width = percent + '%'; txt.innerText = Math.round(percent) + '%';
                }
            };
            xhr.onload = () => {
                if(xhr.status === 200) { bar.style.width = '100%'; txt.innerText = '100%'; setTimeout(() => { ui.style.display = 'none'; reload(); }, 1000); }
                else { alert("Upload failed"); ui.style.display = 'none'; }
                document.getElementById('inp-upload').value = '';
            };
            xhr.onerror = () => { alert("Upload error"); ui.style.display = 'none'; document.getElementById('inp-upload').value = ''; };
            xhr.send(formData);
        }
        async function triggerDownload() {
            const tab = tabs[activeTabIndex];
            if(tab.selected.size === 0) { alert("Please select files to download."); return; }
            const items = Array.from(tab.selected);
            if(items.length === 1) {
                const path = items[0];
                const isDir = tab.items.find(i => i.path === path)?.type === 'dir';
                if(!isDir) { window.open(`${coreUrl}/api/files/view?path=${encodeURIComponent(path)}&token=${authToken}`, '_blank'); return; }
            }
            const btn = event.target; const oldText = btn.innerText; btn.innerText = "Zipping..."; btn.disabled = true;
            try {
                const res = await fetch(`${coreUrl}/api/files/zip`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Token': authToken },
                    body: JSON.stringify({ paths: items })
                });
                if(!res.ok) throw new Error(await res.text());
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = "archive.zip";
                document.body.appendChild(a); a.click(); a.remove(); window.URL.revokeObjectURL(url);
            } catch(e) { alert("Download failed: " + e.message); } finally { btn.innerText = oldText; btn.disabled = false; }
        }
    </script>
</body>
</html>
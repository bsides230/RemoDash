<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LYRN Dashboard v0.56 (Center Dock)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet" />
    <link rel="manifest" href="manifest.json" />

    <style>
        /* =========================================
           1. CORE VARIABLES & THEME
           ========================================= */
        :root {
            --bg-core: #050505;
            --bg-panel: #0a0a0a;
            --brand-purple: #7c5cff;
            --brand-purple-dim: rgba(124, 92, 255, 0.1);
            --brand-purple-glow: rgba(124, 92, 255, 0.4);
            --text-head: #ffffff;
            --text-body: #b0b0b0;
            --text-dim: #666666;
            --border-color: #222222;

            --dock-bg: rgba(20, 20, 20, 0.6);
            --dock-border: rgba(255, 255, 255, 0.1);
            --dock-blur: 20px;

            --font-size-base: 12px;

            --bg-input: #050505;
            --error-color: #ff4444;
        }

        body[data-theme="light"] {
            --bg-core: #eef0f4;
            --bg-panel: #ffffff;
            --brand-purple: #6a4ce0;
            --brand-purple-dim: rgba(106, 76, 224, 0.1);
            --brand-purple-glow: rgba(106, 76, 224, 0.3);
            --text-head: #111111;
            --text-body: #333333;
            --text-dim: #555555;
            --border-color: #d1d5db;
            --dock-bg: rgba(255, 255, 255, 0.6);
            --dock-border: rgba(0, 0, 0, 0.1);
            --bg-input: #ffffff;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; padding: 0; width: 100vw;
            min-height: 100vh; overflow: hidden;
            background-color: var(--bg-core);
            font-family: 'Inter', system-ui, sans-serif;
            color: var(--text-body);
            transition: background-color 0.5s ease;
            background-image:
                repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(124, 92, 255, 0.03) 10px, rgba(124, 92, 255, 0.03) 11px),
                radial-gradient(circle at 50% 0%, rgba(124, 92, 255, 0.15) 0%, transparent 60%);
            background-size: auto, 100% 100%;
            background-attachment: fixed;
            font-size: var(--font-size-base);
        }

        body.no-select * {
            user-select: none !important;
            -webkit-user-select: none !important;
        }

        /* =========================================
           TOP SYSTEM BAR
           ========================================= */
        #top-system-bar {
            position: fixed; top: 0; left: 0; right: 0;
            height: 32px;
            background: rgba(10, 10, 10, 0.6);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            z-index: 10000;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px;
            user-select: none;
        }

        .bar-section { display: flex; align-items: center; gap: 15px; }
        .system-text {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px; color: var(--text-head);
            letter-spacing: 0.05em; cursor: help;
        }
        #sys-cpu { color: #7c5cff; }
        .bar-btn {
            background: transparent; border: none; color: var(--text-dim);
            cursor: pointer; font-family: 'JetBrains Mono'; font-size: 14px;
            padding: 4px; display: flex; align-items: center; justify-content: center;
            transition: color 0.2s;
        }
        .bar-btn:hover { color: var(--text-head); }
        .bar-btn.close-iframe-btn { color: #ff4444; margin-left: 10px; }
        #btn-close-iframe { display: none; }

        /* STATUS LIGHT */
        .status-light {
            width: 12px; height: 12px; border-radius: 50%;
            background-color: #ff4444; /* Default Red */
            margin-right: 12px;
            box-shadow: 0 0 5px rgba(255, 68, 68, 0.4);
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
        }
        .status-light.green { background-color: #00cc66; box-shadow: 0 0 8px rgba(0, 204, 102, 0.6); }
        .status-light.yellow { background-color: #ffbb33; box-shadow: 0 0 8px rgba(255, 187, 51, 0.6); }
        .status-light.blue { background-color: #7c5cff; box-shadow: 0 0 10px #7c5cff; }
        .status-light.orange { background-color: #ff8800; box-shadow: 0 0 8px #ff8800; }

        .status-light.pulse { animation: lightPulse 1.5s infinite ease-in-out; }
        @keyframes lightPulse { 0% { opacity: 1; transform:scale(1); } 50% { opacity: 0.6; transform:scale(0.9); } 100% { opacity: 1; transform:scale(1); } }

        .status-light:hover { transform: scale(1.2); }

        /* =========================================
           WINDOW SYSTEM
           ========================================= */
        #desktop-area { position: absolute; top: 32px; left: 0; right: 0; bottom: 0; z-index: 1; pointer-events: none; }

        .lyrn-window {
            pointer-events: auto;
            position: absolute; background: var(--bg-panel); border: 1px solid var(--border-color);
            display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            border-radius: 8px; width: 800px; height: 600px;
            min-width: 300px; min-height: 200px;
            transition: box-shadow 0.2s, opacity 0.2s, transform 0.2s;
            opacity: 0; transform: scale(0.95);
            animation: openWin 0.2s forwards ease-out;
        }
        @keyframes openWin { to { opacity: 1; transform: scale(1); } }

        .lyrn-window.active { border-color: var(--brand-purple); box-shadow: 0 25px 70px rgba(0,0,0,0.7), 0 0 15px var(--brand-purple-dim); }
        .lyrn-window.always-on-top { z-index: 9999 !important; border: 1px solid var(--brand-purple); box-shadow: 0 0 0 1px var(--brand-purple); }
        .lyrn-window.maximized { transition: width 0.2s, height 0.2s, left 0.2s, top 0.2s; }

        .window-header {
            height: 36px; background: var(--bg-panel); border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center; padding: 0 8px 0 12px;
            cursor: grab; user-select: none; flex-shrink: 0;
        }
        .window-header:active { cursor: grabbing; }
        .window-title { font-family: 'JetBrains Mono', monospace; font-size: calc(var(--font-size-base) - 1px); text-transform: uppercase; color: var(--text-dim); }

        .win-controls { display: flex; align-items: center; gap: 6px; }
        .win-btn {
            background: transparent; border: none; color: var(--text-dim);
            width: 24px; height: 24px; border-radius: 4px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: var(--font-size-base);
            transition: all 0.2s;
        }
        .win-btn:hover { background: var(--brand-purple-dim); color: var(--text-head); }

        .win-btn.pinned {
            background: var(--brand-purple-dim);
            color: var(--brand-purple);
            /* Visual indication of "pinned" state */
            box-shadow: inset 0 0 0 1px var(--brand-purple);
        }

        .window-content { flex: 1; position: relative; background: var(--bg-core); overflow: hidden; }
        iframe { width: 100%; height: 100%; border: none; }
        .iframe-shield { position: absolute; top:0; left:0; width:100%; height:100%; z-index:10; display:none; }
        .lyrn-window.is-dragging .iframe-shield, .lyrn-window.is-resizing .iframe-shield { display: block; }

        .resize-handle {
            position: absolute; bottom: 0; right: 0; width: 25px; height: 25px;
            z-index: 20; opacity: 0; cursor: nwse-resize;
            transition: opacity 0.2s;
        }
        .resize-handle::after {
            content:''; position: absolute; bottom: 4px; right: 4px;
            width: 8px; height: 8px; border-right: 2px solid var(--brand-purple); border-bottom: 2px solid var(--brand-purple);
            border-radius: 0 0 2px 0;
        }
        .lyrn-window:hover .resize-handle { opacity: 1; }

        /* New Mobile Resize Handle */
        .mobile-resize-handle {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 24px;
            z-index: 20; display: none; align-items: center; justify-content: center;
            cursor: ns-resize; padding-top: 4px;
        }
        .mobile-resize-handle::after {
            content: ''; width: 40px; height: 4px; background: var(--border-color); border-radius: 2px;
            transition: background 0.2s;
        }
        .mobile-resize-handle:active::after { background: var(--brand-purple); }

        /* =========================================
           FLOATING DOCK (WEBSITE STYLE)
           ========================================= */

        /* The main container - Acts as the Anchor */
        #floating-dock {
            position: fixed;
            /* Default position (will be overridden by JS) */
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end; /* Align to bottom so handle stays put */

            background: transparent; /* Main container is transparent */
            border: none;
            box-shadow: none;
            z-index: 20000;

            /* Allow buttons to pop UP outside the container */
            overflow: visible;
            width: 50px;
            height: 30px; /* Base height matches handle height */

            /* Disable Selection on Dock */
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;

            /* Transition for snapping */
            transition: left 0.3s cubic-bezier(0.25, 1, 0.5, 1), top 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }

        #floating-dock.is-dragging {
            transition: none !important;
            cursor: grabbing;
        }

        /* The content area - Absolute positioned ABOVE the handle */
        #dock-content {
            position: absolute;
            bottom: 100%; /* Push upwards above handle */
            left: 0;
            width: 100%;

            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 8px;
            padding-bottom: 12px; /* Visual gap above handle */
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin-bottom: 5px;

            opacity: 1;
            transform: translateY(0) scale(1);
            transform-origin: bottom center;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); /* Bouncy pop */
            pointer-events: auto;
        }

        /* Collapsed State */
        #floating-dock.dock-collapsed #dock-content {
            opacity: 0;
            transform: translateY(10px) scale(0.8);
            pointer-events: none;
        }

        /* Buttons styling */
        .dock-btn {
            width: 32px !important;
            height: 32px !important;
            border-radius: 6px !important;
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-dim);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            padding: 0 !important;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
        }

        .dock-btn:hover {
            background: var(--brand-purple-dim);
            color: var(--brand-purple);
            border-color: var(--brand-purple);
        }

        /* The Handle Container */
        #dock-handle {
            width: 50px; /* Matches container width */
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab;

            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 15px; /* Pill shape */
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transition: background 0.2s, transform 0.2s;
            flex-shrink: 0;
        }

        #dock-handle:active {
            cursor: grabbing;
            transform: scale(0.95);
        }

        /* The Glowing LED Bar */
        .handle-bar {
            width: 20px;
            height: 4px;
            background-color: #ffffff; /* Hot center */
            border-radius: 2px;
            opacity: 1;
            /* Purple LED Glow Effect */
            box-shadow: 0 0 6px var(--brand-purple), 0 0 12px var(--brand-purple);
            transition: all 0.3s;
        }

        #floating-dock:hover .handle-bar {
            background-color: #fff;
            box-shadow: 0 0 8px var(--brand-purple), 0 0 16px var(--brand-purple), 0 0 24px var(--brand-purple);
        }

        /* WIGGLE ANIMATION (Edit Mode) */
        @keyframes wiggle {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(-3deg); }
            50% { transform: rotate(0deg); }
            75% { transform: rotate(3deg); }
            100% { transform: rotate(0deg); }
        }
        .dock-btn.wiggle {
            animation: wiggle 0.3s ease-in-out infinite;
            background: rgba(255,50,50,0.15);
            border: 1px solid rgba(255,50,50,0.5);
            color: #ffcccc;
            transition: none;
        }
        .dock-btn.wiggle:hover { transform: scale(1.05); }

        .active-dot {
            position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%);
            width: 3px; height: 3px; border-radius: 50%;
            background-color: var(--brand-purple);
            box-shadow: 0 0 6px var(--brand-purple); display: none;
        }
        .dock-btn.is-running .active-dot { display: block; }
        .active-dot.minimized-dot { background-color: #ff8800; box-shadow: 0 0 6px #ff8800; }

        /* =========================================
           POPUPS & SETTINGS
           ========================================= */
        #settings-popup {
            position: fixed;
            width: 260px; background: var(--bg-panel);
            border: 1px solid var(--dock-border); border-radius: 12px;
            padding: 15px; color: var(--text-body);
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
            display: none; flex-direction: column; gap: 12px;
            z-index: 20001;
        }
        #settings-popup.show { display: flex; animation: fadeUp 0.2s; }
        @keyframes fadeUp { from{opacity:0; transform:scale(0.95);} to{opacity:1; transform:scale(1);} }

        .settings-header {
            font-family: 'JetBrains Mono'; font-size: 10px; color: var(--text-dim);
            text-transform: uppercase; border-bottom: 1px solid var(--border-color); padding-bottom: 4px;
        }
        .settings-row { display: flex; justify-content: space-between; align-items: center; font-size: 12px; }

        .btn-full-width {
            width: 100%; background: var(--bg-core); border: 1px solid var(--border-color);
            color: var(--text-head); padding: 8px; border-radius: 6px; cursor: pointer;
            font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;
            transition: all 0.2s;
        }
        .btn-full-width:hover { background: var(--brand-purple); border-color: var(--brand-purple); }

        /* SLIDER STYLES */
        input[type="range"] {
            -webkit-appearance: none; width: 100px; height: 4px; background: var(--border-color);
            border-radius: 2px; outline: none; opacity: 0.7; transition: opacity .2s;
        }
        input[type="range"]:hover { opacity: 1; }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 12px; height: 12px; border-radius: 50%;
            background: var(--brand-purple); cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
            width: 12px; height: 12px; border-radius: 50%; background: var(--brand-purple); cursor: pointer;
        }

        /* WELCOME POPUP & CONNECTION POPUP */
        #welcome-popup, #connection-popup {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 320px; background: var(--bg-panel);
            border: 1px solid var(--brand-purple);
            box-shadow: 0 0 30px rgba(124, 92, 255, 0.2);
            border-radius: 12px; z-index: 22000;
            display: none; flex-direction: column;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { opacity: 0; transform: translate(-50%, -45%) scale(0.95); } to { opacity: 1; transform: translate(-50%, -50%) scale(1); } }

        .welcome-content { padding: 20px; color: var(--text-body); font-size: 13px; line-height: 1.5; }
        .welcome-footer { padding: 10px 20px; border-top: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; font-size: 11px; color: var(--text-dim); }
        .welcome-title { font-family: 'JetBrains Mono'; color: var(--text-head); font-size: 14px; margin-bottom: 10px; display: block; text-transform: uppercase; letter-spacing: 1px; }

        .cta-btn {
            background: var(--brand-purple); color: #fff; border: none;
            padding: 6px 12px; border-radius: 4px;
            font-family: 'JetBrains Mono'; font-size: 11px;
            cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;
            transition: all 0.2s;
        }
        .cta-btn:hover { background: #fff; color: var(--brand-purple); box-shadow: 0 0 10px var(--brand-purple-glow); }


        /* EDIT POPUP */
        .edit-popup {
            position: fixed;
            background: #000; border: 1px solid #333; border-radius: 50px;
            padding: 8px; display: flex; align-items: center; gap: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.9); z-index: 20002;
            animation: fadeUp 0.15s ease-out;
            pointer-events: auto;
        }
        .edit-popup-btn {
            background: #1a1a1a; border: none; color: #fff;
            width: 36px; height: 36px; border-radius: 50%;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 16px; transition: background 0.2s;
        }
        .edit-popup-btn:hover { background: #333; }
        .edit-popup-btn.danger { color: #ff5555; }
        .edit-popup-btn.danger:hover { background: #500; color: #fff; }
        .edit-popup-sep { width: 1px; height: 20px; background: #333; }

        /* EDIT MODE BANNER */
        #edit-mode-banner {
            position: fixed; top: 40px; left: 50%; transform: translateX(-50%);
            background: var(--brand-purple); color: #fff;
            padding: 8px 16px; border-radius: 30px;
            font-family: 'JetBrains Mono', monospace; font-size: 12px;
            display: none; align-items: center; gap: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); z-index: 21000;
        }
        #edit-mode-banner button {
            background: rgba(0,0,0,0.2); border: none; color: white;
            padding: 4px 8px; border-radius: 4px; cursor: pointer;
            font-family: inherit; font-size: 10px; text-transform: uppercase;
        }
        #edit-mode-banner button:hover { background: rgba(0,0,0,0.4); }

        /* Toggle Switch */
        .toggle-switch { position: relative; width: 32px; height: 18px; display: inline-block; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border-color); transition: .4s; border-radius: 18px; }
        .toggle-slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: var(--text-dim); transition: .4s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: var(--brand-purple); }
        input:checked + .toggle-slider:before { transform: translateX(14px); background-color: white; }

        /* =========================================
           MEDIA QUERIES
           ========================================= */
        @media (max-width: 600px) {
            /* STACKED CARD LAYOUT FOR MOBILE */
            #desktop-area {
                display: flex;
                flex-direction: column;
                justify-content: flex-start;
                padding: 15px;
                padding-top: 10px;
                padding-bottom: 120px; /* Clearance for floating dock */
                gap: 20px;
                overflow-y: auto;
                pointer-events: auto; /* Enable scroll interaction */
                background: rgba(0,0,0,0.2);
            }

            .lyrn-window {
                /* Force Relative Stack Behavior */
                position: relative !important;
                top: auto !important;
                left: auto !important;

                /* Card Dimensions */
                width: 100% !important;
                height: 65vh; /* Open height - Removed !important for resizing */
                min-height: 200px;

                /* Visual Style */
                margin: 0 !important;
                border-radius: 16px !important;
                box-shadow: 0 10px 30px rgba(0,0,0,0.5) !important;

                /* Disable Desktop Animations/Logic */
                transform: none !important;
                opacity: 1 !important;
                flex-shrink: 0;

                /* Smooth entry */
                animation: slideUp 0.3s ease-out forwards !important;
            }

            @keyframes slideUp {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }

            /* Hide Resize/Drag UI */
            .resize-handle { display: none !important; }
            .mobile-resize-handle { display: flex; } /* Show mobile handle */

            .window-header { cursor: default !important; }
            .win-controls .win-btn:first-child { display: none; } /* Hide Maximize */
        }
    </style>
</head>
<body data-theme="dark">

    <div id="top-system-bar">
        <div class="bar-section">
            <div id="sys-status-server" class="status-light" title="Server Status: Disconnected" onclick="openConnectionPopup()"></div>
            <span class="system-text" id="sys-cpu"></span>
            <span class="system-text" id="sys-date">...</span>
            <span class="system-text" id="sys-clock">...</span>
            <span class="system-text" id="sys-battery"></span>
        </div>
        <div class="bar-section">
            <button class="bar-btn" title="Help" onclick="openWelcome()">?</button>
            <button class="bar-btn" title="Reset Dock" onclick="resetDock()">‚öì</button>
            <button class="bar-btn" title="Fullscreen" onclick="toggleDashboardFullscreen()">‚õ∂</button>
            <button class="bar-btn close-iframe-btn" id="btn-close-iframe" onclick="closeDashboard()">‚úï</button>
        </div>
    </div>

    <div id="auth-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); backdrop-filter:blur(15px); z-index:30000; align-items:center; justify-content:center; flex-direction:column;">
        <div style="background:var(--bg-panel); border:1px solid var(--brand-purple); padding:30px; border-radius:12px; width:350px; text-align:center; box-shadow:0 0 50px rgba(124,92,255,0.2);">
            <h2 style="margin:0 0 20px 0; color:var(--text-head); font-family:'JetBrains Mono'; text-transform:uppercase; font-size:16px;">Authentication Required</h2>
            <p style="font-size:12px; color:var(--text-body); margin-bottom:20px; line-height:1.4;">Please enter your Admin Token to access the system.</p>
            <div style="margin-bottom: 15px; text-align: center;">
                 <input type="file" id="inp-token-file" accept=".txt" style="display:none" onchange="handleTokenFile(this)">
                 <button class="cta-btn" onclick="document.getElementById('inp-token-file').click()" style="width:100%; padding:10px; background:transparent; border:1px solid var(--brand-purple);">
                    üìÇ Upload Token File
                 </button>
                 <p style="font-size:10px; color:var(--text-dim); margin-top:5px; margin-bottom:0;">Select admin_token.txt</p>
            </div>

            <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                <div style="flex:1; height:1px; background:var(--border-color);"></div>
                <span style="font-size:10px; color:var(--text-dim);">OR</span>
                <div style="flex:1; height:1px; background:var(--border-color);"></div>
            </div>

            <input type="password" id="inp-auth-token" placeholder="Paste Token String Here..." style="width:100%; padding:10px; background:var(--bg-input); border:1px solid var(--border-color); color:var(--text-head); font-family:'JetBrains Mono'; margin-bottom:15px; border-radius:4px;">

            <label style="display:flex; align-items:start; gap:10px; font-size:11px; color:var(--text-dim); text-align:left; margin-bottom:20px; cursor:pointer;">
                <input type="checkbox" id="chk-save-token">
                <span>Save token to this device?<br><span style="color:#ffaa00;">Warning: Only do this on private devices.</span></span>
            </label>

            <button class="cta-btn" style="width:100%; padding:10px;" onclick="submitAuthToken()">AUTHENTICATE</button>
            <div id="auth-error" style="color:var(--error-color); font-size:11px; margin-top:10px; min-height:15px;"></div>
        </div>
    </div>

    <div id="edit-mode-banner">
        <span>EDIT MODE ACTIVE</span>
        <button onclick="disableEditMode()">DONE</button>
    </div>

    <div id="desktop-area"></div>

    <div id="welcome-popup">
        <div class="window-header">
            <span class="window-title">System Welcome</span>
            <button class="win-btn" onclick="closeWelcome()">‚úï</button>
        </div>
        <div class="welcome-content">
            <span class="welcome-title">LYRN Dock System</span>
            <p>The floating dock is your main navigation tool. You can drag the glowing handle to move it anywhere on the screen. Click the handle to toggle collapse.</p>
            <p><strong>Lost the dock?</strong> Click the anchor (‚öì) icon in the top system bar to reset its position to the center.</p>
        </div>
        <div class="welcome-footer">
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                <input type="checkbox" id="chk-hide-welcome" onchange="toggleHideWelcome(this.checked)">
                Don't show on startup
            </label>
            <button class="cta-btn" onclick="closeWelcome()">INITIALIZE</button>
        </div>
    </div>

    <div id="connection-popup">
        <div class="window-header">
            <span class="window-title">Core Connection</span>
            <button class="win-btn" onclick="skipConnection()">‚úï</button>
        </div>
        <div class="welcome-content">
            <span class="welcome-title">Backend Configuration</span>
            <p>Please enter the URL of the Python Core backend.</p>
            <input type="text" id="inp-core-url" placeholder="http://localhost:8000" style="width:100%; padding:8px; margin-top:10px; background:var(--bg-input); color:var(--text-head); border:1px solid var(--border-color); font-family:'JetBrains Mono';">
            <div id="conn-status" style="margin-top:10px; font-size:11px; color:var(--text-dim);"></div>
        </div>
        <div class="welcome-footer">
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                <input type="checkbox" id="chk-no-startup-conn" onchange="toggleStartupConn(this.checked)">
                Don't show on startup
            </label>
            <div style="display:flex; gap:10px;">
                <button class="cta-btn" style="background:transparent; border:1px solid var(--border-color);" onclick="skipConnection()">SKIP</button>
                <button class="cta-btn" onclick="testAndSaveConnection()">CONNECT</button>
            </div>
        </div>
    </div>

    <div id="settings-popup">
        <div class="settings-header">General</div>
        <button class="btn-full-width" style="margin-bottom:10px;" onclick="openConnectionPopup()">Configure Connection</button>
        <div class="settings-row">
            <span>Dark Mode</span>
            <label class="toggle-switch">
                <input type="checkbox" id="setting-theme" checked onchange="toggleTheme(this.checked)">
                <span class="toggle-slider"></span>
            </label>
        </div>
        <div class="settings-row">
            <span>Pin Open</span>
            <label class="toggle-switch">
                <input type="checkbox" id="setting-dock-pin" checked onchange="toggleDockPin(this.checked)">
                <span class="toggle-slider"></span>
            </label>
        </div>
        <div class="settings-row">
            <span>Font Size: <b id="font-size-display">12</b>px</span>
            <input type="range" id="setting-font-size" min="10" max="18" step="1" value="12" oninput="updateFontSize(this.value)">
        </div>

        <div class="settings-header" style="margin-top:5px;">Layout</div>
        <button class="btn-full-width" onclick="enableEditMode()">Edit Dock Order</button>

        <div class="settings-header" style="margin-top:5px;">Modules</div>
        <div id="module-list-container"></div>
    </div>

    <div id="floating-dock">
        <div id="dock-content"></div>

        <div id="dock-handle" title="Drag to Move | Click to Toggle">
            <div class="handle-bar"></div>
        </div>
    </div>

    <script>
        /* =========================================================================
           CONFIG & STATE
           ========================================================================= */
        const MODULE_REGISTRY = [
            { id: "mod_logs", file: "LogViewer.html", name: "System Logs", icon: "üìú" },
            { id: "mod_settings", file: "Settings.html", name: "System Settings", icon: "üîß" },
            { id: "mod_server_status", file: "ServerStatus.html", name: "System Status", icon: "üìä" },
        ];

        let appSettings = {
            activeModules: ['mod_logs', 'mod_settings', 'mod_server_status'],
            dockPinned: true,
            dockPos: null, // Initial null to trigger center calculation
            theme: 'dark',
            fontSize: 12
        };

        let zIndexCounter = 100;
        let activeWindows = new Set();
        let isEditMode = false;

        const isTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);

        let coreUrl = "http://localhost:8000";
        if(window.location.protocol.startsWith('http')) {
             coreUrl = window.location.origin;
        }
        let authToken = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            renderDock();
            initDockDrag();
            startClock();
            // startCpuMonitor();
            initSystemMonitor();
            checkIfIframe();
            checkWelcome();
            checkConnection();

            document.getElementById('setting-dock-pin').checked = appSettings.dockPinned;
            document.getElementById('setting-theme').checked = (appSettings.theme === 'dark');

            // Initialize Font Size Slider
            document.getElementById('setting-font-size').value = appSettings.fontSize;
            updateFontSize(appSettings.fontSize, false); // False = don't save yet, just apply

            // Handle clicking outside
            document.addEventListener('click', (e) => {
                // Settings Popup
                const setPop = document.getElementById('settings-popup');
                if(setPop.classList.contains('show') && !e.target.closest('#settings-popup') && !e.target.closest('#btn_settings')) {
                    setPop.classList.remove('show');
                }

                // Edit Mode - Exit if clicking outside dock/popups
                if(isEditMode && !e.target.closest('#floating-dock') && !e.target.closest('.edit-popup') && !e.target.closest('#edit-mode-banner') && !e.target.closest('#settings-popup')) {
                    disableEditMode();
                }
            });
        });

        /* =========================================
           DOCK LOGIC
           ========================================= */
        function renderDock() {
            const container = document.getElementById('dock-content');
            const modContainer = document.getElementById('module-list-container');
            container.innerHTML = '';
            modContainer.innerHTML = '';

            // 1. Module List (Settings) - Render from Registry (Fixed Order)
            MODULE_REGISTRY.forEach(mod => {
                const isActive = appSettings.activeModules.includes(mod.id);
                const row = document.createElement('div');
                row.className = 'settings-row';
                row.innerHTML = `<span>${mod.name}</span><label class="toggle-switch"><input type="checkbox" ${isActive ? 'checked' : ''} onchange="toggleModuleActive('${mod.id}', this.checked)"><span class="toggle-slider"></span></label>`;
                modContainer.appendChild(row);
            });

            // 2. Dock Icons - Render from ActiveModules (Dynamic Order)
            appSettings.activeModules.forEach(modId => {
                const mod = MODULE_REGISTRY.find(m => m.id === modId);
                if (!mod) return; // Skip if ID invalid

                const btn = document.createElement('button');
                btn.className = 'dock-btn';
                if(isEditMode) btn.classList.add('wiggle');

                btn.id = 'btn_' + mod.id;
                btn.innerHTML = `${mod.icon}<div class="active-dot"></div>`;

                btn.onclick = (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    if(isEditMode) {
                        openEditPopup(e, mod);
                    } else {
                        toggleWindow(mod);
                    }
                };
                container.appendChild(btn);
            });

            // 3. Settings Button
            const settingsBtn = document.createElement('button');
            settingsBtn.className = 'dock-btn';
            settingsBtn.innerHTML = '‚öôÔ∏è';
            settingsBtn.id = 'btn_settings';

            if(isEditMode) {
                 settingsBtn.style.opacity = '0.3';
                 settingsBtn.style.pointerEvents = 'none';
            }

            settingsBtn.onclick = (e) => {
                e.stopPropagation();
                if(isEditMode) return;
                const popup = document.getElementById('settings-popup');

                const dockRect = document.getElementById('floating-dock').getBoundingClientRect();

                // Position Settings Popup relative to dock
                const popupW = 260;
                let leftPos = dockRect.left - popupW - 15;
                if(leftPos < 10) leftPos = dockRect.right + 15;

                popup.style.top = (dockRect.top - 100) + 'px';
                popup.style.left = leftPos + 'px';

                popup.classList.toggle('show');
            };
            container.appendChild(settingsBtn);

            updateDockIndicators();
        }

        /* =========================================
           WEBSITE STYLE DRAG (GRID SNAP)
           ========================================= */
        function initDockDrag() {
            const dock = document.getElementById('floating-dock');
            const handle = document.getElementById('dock-handle');

            // Apply saved position OR CENTER DEFAULT
            if (appSettings.dockPos) {
                 dock.style.bottom = 'auto';
                 dock.style.right = 'auto';
                 dock.style.left = appSettings.dockPos.left + 'px';
                 dock.style.top = appSettings.dockPos.top + 'px';
            } else {
                 // Calculate Center
                 const startLeft = (window.innerWidth / 2) - 25; // 50px width / 2
                 const startTop = (window.innerHeight / 2) - 15; // 30px height / 2

                 dock.style.bottom = 'auto';
                 dock.style.right = 'auto';
                 dock.style.left = startLeft + 'px';
                 dock.style.top = startTop + 'px';
            }

            if(!appSettings.dockPinned) {
                dock.classList.add('dock-collapsed');
            }

            let isDragging = false;
            let startX, startY, initialLeft, initialTop;
            let hasMoved = false;

            // 1. Drag Functionality
            handle.addEventListener('mousedown', startDrag);
            handle.addEventListener('touchstart', startDrag, {passive: false});

            function startDrag(e) {
                if(e.type === 'touchstart') e.preventDefault();

                isDragging = true;
                hasMoved = false;
                dock.classList.add('is-dragging');

                const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
                const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;

                startX = clientX;
                startY = clientY;

                const rect = dock.getBoundingClientRect();
                initialLeft = rect.left;
                initialTop = rect.top;

                // Ensure absolute positioning
                dock.style.bottom = 'auto';
                dock.style.right = 'auto';
                dock.style.left = `${initialLeft}px`;
                dock.style.top = `${initialTop}px`;

                document.addEventListener('mousemove', onDrag);
                document.addEventListener('mouseup', stopDrag);
                document.addEventListener('touchmove', onDrag, {passive: false});
                document.addEventListener('touchend', stopDrag);
            }

            function onDrag(e) {
                if (!isDragging) return;
                if(e.cancelable) e.preventDefault();

                const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
                const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;

                const dx = clientX - startX;
                const dy = clientY - startY;

                if (Math.abs(dx) + Math.abs(dy) > 5) hasMoved = true;

                let newLeft = initialLeft + dx;
                let newTop = initialTop + dy;

                const maxLeft = window.innerWidth - dock.offsetWidth;
                const maxTop = window.innerHeight - dock.offsetHeight;

                if (newLeft < 0) newLeft = 0;
                if (newLeft > maxLeft) newLeft = maxLeft;
                if (newTop < 32) newTop = 32; // Respect top bar
                if (newTop > maxTop) newTop = maxTop;

                dock.style.left = `${newLeft}px`;
                dock.style.top = `${newTop}px`;
            }

            function stopDrag() {
                isDragging = false;
                dock.classList.remove('is-dragging');

                document.removeEventListener('mousemove', onDrag);
                document.removeEventListener('mouseup', stopDrag);
                document.removeEventListener('touchmove', onDrag);
                document.removeEventListener('touchend', stopDrag);

                if (hasMoved) {
                    // Snap to Grid
                    const rect = dock.getBoundingClientRect();
                    const gridSize = 40;
                    const safeMargin = 20;

                    let currentLeft = rect.left;
                    let currentTop = rect.top;

                    let finalLeft = Math.round(currentLeft / gridSize) * gridSize;
                    let finalTop = Math.round(currentTop / gridSize) * gridSize;

                    const maxLeft = window.innerWidth - rect.width - safeMargin;
                    const maxTop = window.innerHeight - rect.height - safeMargin;

                    if (finalLeft < safeMargin) finalLeft = safeMargin;
                    if (finalLeft > maxLeft) finalLeft = maxLeft;
                    if (finalTop < 32 + safeMargin) finalTop = 32 + safeMargin;
                    if (finalTop > maxTop) finalTop = maxTop;

                    dock.style.left = `${finalLeft}px`;
                    dock.style.top = `${finalTop}px`;

                    appSettings.dockPos = { left: finalLeft, top: finalTop };
                    saveSettings();
                } else {
                    // It was a click, not a drag
                    dock.classList.toggle('dock-collapsed');
                }
            }
        }

        /* =========================================
           EDIT MODE
           ========================================= */
        function enableEditMode() {
            isEditMode = true;
            document.getElementById('settings-popup').classList.remove('show');
            document.getElementById('edit-mode-banner').style.display = 'flex';
            document.getElementById('floating-dock').classList.remove('dock-collapsed');
            renderDock();
        }

        function disableEditMode() {
            isEditMode = false;
            document.getElementById('edit-mode-banner').style.display = 'none';
            document.querySelectorAll('.edit-popup').forEach(p => p.remove());

            if(!appSettings.dockPinned) {
                document.getElementById('floating-dock').classList.add('dock-collapsed');
            }
            renderDock();
        }

        function openEditPopup(e, mod) {
            document.querySelectorAll('.edit-popup').forEach(p => p.remove());
            const popup = document.createElement('div');
            popup.className = 'edit-popup';

            // Vertical Stack logic
            const prev = '‚Üë';
            const next = '‚Üì';

            popup.innerHTML = `
                <button class="edit-popup-btn" onclick="moveApp('${mod.id}', -1)">${prev}</button>
                <button class="edit-popup-btn" onclick="moveApp('${mod.id}', 1)">${next}</button>
                <div class="edit-popup-sep"></div>
                <button class="edit-popup-btn danger" onclick="confirmRemoveApp('${mod.id}')">üóë</button>
            `;

            document.body.appendChild(popup);

            const btnRect = e.currentTarget.getBoundingClientRect();
            let top = btnRect.top;
            let left = btnRect.left - 160;

            if (left < 10) left = btnRect.right + 10;

            popup.style.top = top + 'px';
            popup.style.left = left + 'px';

            e.stopPropagation();
        }

        function moveApp(modId, dir) {
            const idx = appSettings.activeModules.indexOf(modId);
            if (idx === -1) return;

            const newIdx = idx + dir;
            if (newIdx >= 0 && newIdx < appSettings.activeModules.length) {
                const temp = appSettings.activeModules[idx];
                appSettings.activeModules[idx] = appSettings.activeModules[newIdx];
                appSettings.activeModules[newIdx] = temp;
                saveSettings(); renderDock();
                document.querySelectorAll('.edit-popup').forEach(p => p.remove());
            }
        }

        function confirmRemoveApp(modId) {
            if(confirm('Are you sure you want to remove this app from the dock?')) {
                toggleModuleActive(modId, false);
                document.querySelectorAll('.edit-popup').forEach(p => p.remove());
            }
        }

        /* =========================================
           HELPERS
           ========================================= */
        function toggleWindow(mod) {
            const id = 'win_' + mod.id;
            const el = document.getElementById(id);
            if(el) {
                if(el.style.display === 'none') {
                    el.style.display = 'flex'; el.style.zIndex = ++zIndexCounter;
                    el.classList.remove('minimized');
                } else {
                    el.style.display = 'none';
                }
            } else {
                createWindow(mod);
            }
            updateDockIndicators();
        }

        function createWindow(mod) {
            const id = 'win_' + mod.id;
            const area = document.getElementById('desktop-area');
            const win = document.createElement('div');
            win.className = 'lyrn-window active';
            win.id = id;
            win.style.zIndex = ++zIndexCounter;

            const isMobileWidth = window.innerWidth <= 600;
            const startW = isMobileWidth ? '100%' : (isTouch ? '90%' : '800px');
            const startH = isMobileWidth ? '65vh' : (isTouch ? '80%' : '600px');

            win.style.width = startW;
            win.style.height = startH;

            const offset = (activeWindows.size * 30) + 50;
            if(!isMobileWidth) {
                 win.style.left = isTouch ? '5%' : offset + 'px';
                 win.style.top = isTouch ? '10%' : offset + 'px';
            }

            win.innerHTML = `
                <div class="window-header">
                    <span class="window-title">${mod.name}</span>
                    <div class="win-controls">
                         <button class="win-btn pin-btn" title="Pin Always on Top" onclick="togglePin('${mod.id}', this)">üìå</button>
                         <button class="win-btn" onclick="minimizeWindow('${mod.id}')">_</button>
                         <button class="win-btn" onclick="toggleMaximize(this)">‚òê</button>
                         <button class="win-btn close-btn" onclick="closeWindow('${mod.id}')">‚úï</button>
                    </div>
                </div>
                <div class="window-content">
                    <div class="iframe-shield"></div>
                    <iframe src="modules/${mod.file}"></iframe>
                </div>
                <div class="resize-handle"></div>
                <div class="mobile-resize-handle"></div>
            `;

            const iframe = win.querySelector('iframe');
            // Inject Font Size on Load
            iframe.onload = () => {
                iframe.contentWindow.postMessage({ type: 'THEME_CHANGE', theme: appSettings.theme }, '*');
                iframe.contentWindow.postMessage({ type: 'FONT_CHANGE', fontSize: appSettings.fontSize }, '*');
                iframe.contentWindow.postMessage({ type: 'CORE_URL_CHANGE', url: coreUrl }, '*');
                if(authToken) iframe.contentWindow.postMessage({ type: 'TOKEN_UPDATE', token: authToken }, '*');
            };

            setupWindowDrag(win);
            setupWindowResize(win);
            setupMobileResize(win);
            win.onmousedown = () => { win.style.zIndex = ++zIndexCounter; updateDockIndicators(); };
            win.ontouchstart = () => { win.style.zIndex = ++zIndexCounter; updateDockIndicators(); };
            area.appendChild(win);
            activeWindows.add(mod.id);
            updateDockIndicators();
        }

        function closeWindow(modId) {
            const win = document.getElementById('win_' + modId);
            if(win) win.remove();
            activeWindows.delete(modId);
            updateDockIndicators();
        }

        function minimizeWindow(modId) {
            const win = document.getElementById('win_' + modId);
            if(win) win.style.display = 'none';
            updateDockIndicators();
        }

        function setupWindowResize(win) {
            const handle = win.querySelector('.resize-handle');
            const startResize = (e) => {
                e.preventDefault(); e.stopPropagation();
                const startX = e.touches ? e.touches[0].clientX : e.clientX;
                const startY = e.touches ? e.touches[0].clientY : e.clientY;
                const startW = win.offsetWidth; const startH = win.offsetHeight;
                win.classList.add('is-resizing');
                const doResize = (ev) => {
                    const curX = ev.touches ? ev.touches[0].clientX : ev.clientX;
                    const curY = ev.touches ? ev.touches[0].clientY : ev.clientY;
                    const newW = startW + (curX - startX); const newH = startH + (curY - startY);
                    if(newW > 250) win.style.width = newW + 'px';
                    if(newH > 150) win.style.height = newH + 'px';
                };
                const stopResize = () => {
                    win.classList.remove('is-resizing');
                    window.removeEventListener('mousemove', doResize); window.removeEventListener('mouseup', stopResize);
                    window.removeEventListener('touchmove', doResize); window.removeEventListener('touchend', stopResize);
                };
                window.addEventListener('mousemove', doResize); window.addEventListener('mouseup', stopResize);
                window.addEventListener('touchmove', doResize, {passive:false}); window.addEventListener('touchend', stopResize);
            };
            handle.addEventListener('mousedown', startResize); handle.addEventListener('touchstart', startResize, {passive:false});
        }

        function setupMobileResize(win) {
            const handle = win.querySelector('.mobile-resize-handle');
            if(!handle) return;

            const startResize = (e) => {
                e.preventDefault(); e.stopPropagation();
                // For mobile touches use first touch, fallback to mouse for testing
                const startY = e.touches ? e.touches[0].clientY : e.clientY;
                const startH = win.offsetHeight;

                win.classList.add('is-resizing');

                const doResize = (ev) => {
                    // Prevent page scroll
                    if(ev.cancelable) ev.preventDefault();
                    const curY = ev.touches ? ev.touches[0].clientY : ev.clientY;
                    const newH = startH + (curY - startY);

                    if(newH > 150) win.style.height = newH + 'px';
                };

                const stopResize = () => {
                    win.classList.remove('is-resizing');
                    window.removeEventListener('touchmove', doResize); window.removeEventListener('touchend', stopResize);
                    window.removeEventListener('mousemove', doResize); window.removeEventListener('mouseup', stopResize);
                };

                window.addEventListener('touchmove', doResize, {passive: false}); window.addEventListener('touchend', stopResize);
                window.addEventListener('mousemove', doResize); window.addEventListener('mouseup', stopResize);
            };

            handle.addEventListener('touchstart', startResize, {passive: false});
            handle.addEventListener('mousedown', startResize);
        }

        function setupWindowDrag(win) {
            const header = win.querySelector('.window-header');
            const startDrag = (e) => {
                if(e.target.closest('button')) return;
                if(win.classList.contains('maximized')) return;
                const startX = e.touches ? e.touches[0].clientX : e.clientX;
                const startY = e.touches ? e.touches[0].clientY : e.clientY;
                const startLeft = win.offsetLeft; const startTop = win.offsetTop;
                win.classList.add('is-dragging');
                const doDrag = (ev) => {
                    ev.preventDefault();
                    const curX = ev.touches ? ev.touches[0].clientX : ev.clientX;
                    const curY = ev.touches ? ev.touches[0].clientY : ev.clientY;
                    win.style.left = (startLeft + (curX - startX)) + 'px';
                    win.style.top = (startTop + (curY - startY)) + 'px';
                };
                const stopDrag = () => {
                    win.classList.remove('is-dragging');
                    window.removeEventListener('mousemove', doDrag); window.removeEventListener('touchmove', doDrag);
                };
                window.addEventListener('mousemove', doDrag); window.addEventListener('mouseup', stopDrag);
                window.addEventListener('touchmove', doDrag, {passive:false}); window.addEventListener('touchend', stopDrag);
            };
            header.addEventListener('mousedown', startDrag); header.addEventListener('touchstart', startDrag, {passive:false});
        }

        function updateDockIndicators() {
            document.querySelectorAll('.dock-btn').forEach(btn => {
                btn.classList.remove('is-running');
                const dot = btn.querySelector('.active-dot');
                if(dot) dot.classList.remove('minimized-dot');
            });

            activeWindows.forEach(id => {
                const btn = document.getElementById('btn_' + id);
                const win = document.getElementById('win_' + id);

                if(btn && win) {
                    btn.classList.add('is-running');
                    const dot = btn.querySelector('.active-dot');
                    if(dot && win.style.display === 'none') {
                        dot.classList.add('minimized-dot');
                    }
                }
            });
        }

        function resetDock() {
            // Recalculate center
            const startLeft = (window.innerWidth / 2) - 25;
            const startTop = (window.innerHeight / 2) - 15;

            appSettings.dockPos = { left: startLeft, top: startTop };
            appSettings.dockPinned = true;
            document.getElementById('setting-dock-pin').checked = true;

            const dock = document.getElementById('floating-dock');
            dock.style.bottom = 'auto';
            dock.style.right = 'auto';
            dock.style.left = startLeft + 'px';
            dock.style.top = startTop + 'px';
            dock.classList.remove('dock-collapsed');
            saveSettings();
        }
        function toggleTheme(isDark) {
            const theme = isDark ? 'dark' : 'light';
            document.body.setAttribute('data-theme', theme);
            appSettings.theme = theme;
            saveSettings();

            // Broadcast
            document.querySelectorAll('iframe').forEach(f => {
                f.contentWindow.postMessage({ type: 'THEME_CHANGE', theme: theme }, '*');
            });
        }

        function updateFontSize(size, save = true) {
            document.documentElement.style.setProperty('--font-size-base', size + 'px');
            document.getElementById('font-size-display').innerText = size;

            appSettings.fontSize = parseInt(size);
            if(save) saveSettings();

            // Broadcast to all active windows
            document.querySelectorAll('iframe').forEach(f => {
                f.contentWindow.postMessage({ type: 'FONT_CHANGE', fontSize: size }, '*');
            });
        }

        function toggleDockPin(pinned) {
            appSettings.dockPinned = pinned;
            const dock = document.getElementById('floating-dock');
            pinned ? dock.classList.remove('dock-collapsed') : dock.classList.add('dock-collapsed');
            saveSettings();
        }

        function togglePin(modId, btn) {
            const win = document.getElementById('win_' + modId);
            if(win) {
                win.classList.toggle('always-on-top');
                if(win.classList.contains('always-on-top')) {
                    btn.classList.add('pinned');
                    btn.innerHTML = 'üìç';
                } else {
                    btn.classList.remove('pinned');
                    btn.innerHTML = 'üìå';
                }
            }
        }

        function toggleModuleActive(modId, active) { if(active) { if(!appSettings.activeModules.includes(modId)) appSettings.activeModules.push(modId); } else { appSettings.activeModules = appSettings.activeModules.filter(m => m !== modId); } saveSettings(); renderDock(); }
        function toggleMaximize(btn) { const win = btn.closest('.lyrn-window'); if(win.classList.contains('maximized')) { win.classList.remove('maximized'); win.style.cssText = win.dataset.cache || ''; } else { win.dataset.cache = win.style.cssText; win.classList.add('maximized'); win.style.top = '32px'; win.style.left = '0'; win.style.width = '100%'; win.style.height = 'calc(100% - 32px)'; } }
        function saveSettings() { localStorage.setItem('lyrn-settings', JSON.stringify(appSettings)); }
        function loadSettings() { const s = localStorage.getItem('lyrn-settings'); if(s) appSettings = { ...appSettings, ...JSON.parse(s) }; if(appSettings.theme) document.body.setAttribute('data-theme', appSettings.theme); }

        function startClock() {
            const timeEl = document.getElementById('sys-clock');
            const dateEl = document.getElementById('sys-date');

            // Update immediately
            updateTime();
            setInterval(updateTime, 1000);

            function updateTime() {
                const n = new Date();
                if(timeEl) timeEl.innerText = n.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                if(dateEl) dateEl.innerText = n.toLocaleDateString([], {month: 'short', day: 'numeric'});
            }
        }

        function checkConnection() {
            // Restore checkbox state
            const hidden = localStorage.getItem('lyrn-conn-hidden');
            document.getElementById('chk-no-startup-conn').checked = (hidden === 'true');

            const stored = localStorage.getItem('lyrn_core_url');

            // If we have a stored URL, try to use it regardless
            if (stored) {
                coreUrl = stored;
                document.getElementById('inp-core-url').value = stored;
            } else if (window.location.protocol.startsWith('http')) {
                 document.getElementById('inp-core-url').value = window.location.origin;
            }

            // Always start monitoring (it handles failures gracefully)
            initBackendMonitor();

            // Only show popup if NO URL stored AND user hasn't hidden it
            if (!stored && hidden !== 'true') {
                document.getElementById('connection-popup').style.display = 'flex';
            }
        }

        function openConnectionPopup() {
            const stored = localStorage.getItem('lyrn_core_url');
            if(stored) document.getElementById('inp-core-url').value = stored;
            document.getElementById('connection-popup').style.display = 'flex';
            document.getElementById('settings-popup').classList.remove('show');
        }

        function skipConnection() {
            document.getElementById('connection-popup').style.display = 'none';
        }

        function toggleStartupConn(isChecked) {
            localStorage.setItem('lyrn-conn-hidden', isChecked);
        }

        async function testAndSaveConnection() {
            const inp = document.getElementById('inp-core-url');
            let url = inp.value.replace(/\/$/, "");
            if(!url) url = "http://localhost:8000";

            const statusEl = document.getElementById('conn-status');
            statusEl.innerText = "Testing...";
            statusEl.style.color = "var(--text-dim)";

            setLight('sys-status-server', 'yellow', 'Testing Connection...');

            try {
                const res = await fetch(url + '/health');
                const data = await res.json();
                if (data.status === 'ok') {
                    localStorage.setItem('lyrn_core_url', url);
                    coreUrl = url;
                    document.getElementById('connection-popup').style.display = 'none';

                    // Connected successfully, now check Auth
                    initBackendMonitor();
                    checkAuth();

                    // Broadcast to modules
                    document.querySelectorAll('iframe').forEach(f => {
                        f.contentWindow.postMessage({ type: 'CORE_URL_CHANGE', url: url }, '*');
                    });

                    setLight('sys-status-server', 'green', 'Connected to Core');
                } else {
                    throw new Error("Invalid response");
                }
            } catch (e) {
                statusEl.innerText = "Connection Failed: " + e.message;
                statusEl.style.color = "var(--error-color)";
                setLight('sys-status-server', 'red', 'Connection Failed');
            }
        }

        let hasCheckedAuth = false;
        async function checkAuth() {
            if(hasCheckedAuth) return;

            // 1. Check Global Auth Status (Bypass if disabled)
            try {
                const res = await fetch(coreUrl + '/api/auth/status');
                if(res.ok) {
                    const status = await res.json();
                    if(status.required === false) {
                        authToken = "NO_AUTH";
                        localStorage.setItem('lyrn_admin_token', authToken);
                        broadcastToken();
                        hasCheckedAuth = true;
                        document.getElementById('auth-overlay').style.display = 'none';
                        return;
                    }
                }
            } catch(e) { console.error("Failed to check auth status", e); }

            // 2. Check LocalStorage
            const storedToken = localStorage.getItem('lyrn_admin_token');
            if(storedToken) {
                // Verify it
                const valid = await verifyToken(storedToken);
                if(valid) {
                    authToken = storedToken;
                    broadcastToken();
                    hasCheckedAuth = true;
                    return;
                }
            }

            // 3. Show Overlay
            document.getElementById('auth-overlay').style.display = 'flex';
        }

        function handleTokenFile(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const text = e.target.result.trim();
                    if(text) {
                        document.getElementById('inp-auth-token').value = text;
                        submitAuthToken();
                    }
                };
                reader.readAsText(input.files[0]);
            }
        }

        async function submitAuthToken() {
            const inp = document.getElementById('inp-auth-token');
            const err = document.getElementById('auth-error');
            const save = document.getElementById('chk-save-token');
            const token = inp.value.trim();

            if(!token) {
                err.innerText = "Token cannot be empty.";
                return;
            }

            err.innerText = "Verifying...";

            const valid = await verifyToken(token);
            if(valid) {
                authToken = token;
                if(save.checked) {
                    if(confirm("Are you sure you want to save this token? Only do this on a trusted device.")) {
                        localStorage.setItem('lyrn_admin_token', token);
                    }
                }

                document.getElementById('auth-overlay').style.display = 'none';
                broadcastToken();
                hasCheckedAuth = true;
            } else {
                err.innerText = "Invalid Token. Please check admin_token.txt";
            }
        }

        async function verifyToken(token) {
            try {
                const res = await fetch(coreUrl + '/api/verify_token', {
                    method: 'POST',
                    headers: { 'X-Token': token }
                });
                if(res.ok) return true;
                return false;
            } catch(e) {
                console.error("Auth check failed", e);
                return false;
            }
        }

        function broadcastToken() {
            document.querySelectorAll('iframe').forEach(f => {
                f.contentWindow.postMessage({ type: 'TOKEN_UPDATE', token: authToken }, '*');
            });
        }

        let monitorInterval = null;
        function initBackendMonitor() {
            if(monitorInterval) clearInterval(monitorInterval);
            fetchStats();
            monitorInterval = setInterval(fetchStats, 2000);
        }

        async function fetchStats() {
            const srvLight = 'sys-status-server';

            if(!coreUrl) {
                setLight(srvLight, 'red', 'No Connection Configured');
                return;
            }
            try {
                const res = await fetch(coreUrl + '/health');
                const data = await res.json();

                // Server OK
                setLight(srvLight, 'green', 'Connected to Backend');

                // Hide connection popup if visible
                document.getElementById('connection-popup').style.display = 'none';

                // Trigger Auth Check if connected and not done yet
                if(!hasCheckedAuth) checkAuth();

                const cpuText = `CPU: ${data.cpu.percent}%`;
                const ramText = `RAM: ${Math.round(data.ram.percent)}%`;
                document.getElementById('sys-cpu').innerText = `${cpuText} | ${ramText}`;

            } catch (e) {
                document.getElementById('sys-cpu').innerText = "";
                setLight(srvLight, 'red', 'Disconnected / Offline');
            }
        }

        function setLight(id, status, title) {
            const el = document.getElementById(id);
            if(el) {
                el.className = 'status-light ' + status;
                el.title = title || status;
            }
        }

        function initSystemMonitor() {
            if('getBattery' in navigator) {
                navigator.getBattery().then(b => {
                    const update = () => {
                        const icon = b.charging ? '‚ö°' : '';
                        document.getElementById('sys-battery').innerText = icon + Math.round(b.level*100) + '%';
                    };
                    update();
                    b.addEventListener('levelchange', update);
                    b.addEventListener('chargingchange', update);
                });
            }
        }
        function toggleDashboardFullscreen() { !document.fullscreenElement ? document.documentElement.requestFullscreen() : document.exitFullscreen(); }
        function checkIfIframe() { if(window.self !== window.top) document.getElementById('btn-close-iframe').style.display = 'flex'; }
        function closeDashboard() { window.parent.postMessage({ type: 'CLOSE_DASHBOARD' }, '*'); }

        window.addEventListener('message', (e) => {
            if(e.data.type === 'OPEN_WIDGET') {
                // Check if widget already exists
                const existing = document.getElementById('win_' + e.data.id);
                if(existing) {
                    // Bring to front
                    existing.style.display = 'flex';
                    existing.style.zIndex = ++zIndexCounter;
                    return;
                }

                // Create synthetic module
                const mod = {
                    id: e.data.id,
                    name: e.data.name,
                    file: e.data.file
                };
                createWindow(mod);

                // Customize for widget (smaller size default)
                const win = document.getElementById('win_' + mod.id);
                if(win) {
                    win.style.width = '300px';
                    win.style.height = '200px';
                    // Center it
                    win.style.left = (window.innerWidth/2 - 150) + 'px';
                    win.style.top = (window.innerHeight/2 - 100) + 'px';
                }
            }
        });

        /* Welcome Popup Logic */
        function checkWelcome() {
            const hidden = localStorage.getItem('lyrn-welcome-hidden');
            document.getElementById('chk-hide-welcome').checked = (hidden === 'true');
            if(hidden !== 'true') openWelcome();
        }
        function openWelcome() {
            document.getElementById('welcome-popup').style.display = 'flex';
        }
        function closeWelcome() {
            document.getElementById('welcome-popup').style.display = 'none';
        }
        function toggleHideWelcome(isChecked) {
            localStorage.setItem('lyrn-welcome-hidden', isChecked);
        }

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(reg => console.log('Service Worker Registered', reg))
                .catch(err => console.log('Service Worker Error', err));
        }
    </script>
</body>
</html>